<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ file_path }} - Android Log åˆ†æå ±å‘ŠæŸ¥çœ‹å™¨</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* é¢æ¿å…§å®¹å®¹å™¨ */
        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #0d0d0d;
        }

		/* å°‡åˆ†æå ±å‘Šä¸­çš„æ¨£å¼æå‡ç‚ºå…¨åŸŸæ¨£å¼ */
		.panel-content style {
			display: block !important;
		}    
		
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-hover: #333333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #444444;
            --accent-color: #4ec9b0;
            --header-height: 60px;
            --status-height: 30px;
            --line-hover-color: #2d5a8e;  /* æ–°å¢çµ±ä¸€çš„è¡Œ hover é¡è‰² */            
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* é ‚éƒ¨å·¥å…·åˆ— */
        .header {
            height: var(--header-height);
            background: #1a1a1a;  /* æ”¹ç‚ºæ›´æ·±çš„é»‘è‰² */
            border-bottom: 1px solid #333333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: relative;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .file-info h1 {
            font-size: 18px;
            font-weight: 500;
        }
        
        .file-info p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            background: #2d2d2d;
            border: 1px solid #444444;
            color: #e0e0e0;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #3a3a3a;
            border-color: #666666;
        }
        
        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #3db89f;
        }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            height: calc(100vh - var(--header-height) - var(--status-height));
            display: flex;
            position: relative;
        }
        
        /* åˆ†å‰²é¢æ¿ */
        .split-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }
        
        .split-panel.hidden {
            display: none;
        }
        
        /* é¢æ¿é ­éƒ¨ */
        .panel-header {
            background: #1e1e1e;
            padding: 8px 12px;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* é¢æ¿å…§å®¹ */
        .panel-content {
            flex: 1;
            overflow: hidden;  /* æ”¹ç‚º hiddenï¼Œä¸é¡¯ç¤ºæ²è»¸ */
            position: relative;
            background: var(--bg-primary);
        }

        /* ç¢ºä¿ iframe çš„å®¹å™¨ä¹Ÿä½¿ç”¨ç›¸åŒæ¨£å¼ */
        .panel-content iframe {
            scrollbar-width: thin;
            scrollbar-color: #444 #1a1a1a;
        }

        /* åˆ†æå ±å‘Šå…§å®¹æ¨£å¼ */
        .analysis-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* åŸå§‹å…§å®¹æ¨£å¼ */
        .original-content {
            flex: 1;
            padding: 20px 20px 0 20px; /* ç§»é™¤åº•éƒ¨ padding */
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            word-wrap: normal;
            color: #d4d4d4;
            background: transparent;
            min-width: max-content;
        }

        /* åœ¨æœ€å¾Œä¸€è¡Œå¾Œæ·»åŠ ä¸€äº›ç©ºé–“ */
        .original-content::after {
            content: '';
            display: block;
            height: 20px; /* åªåœ¨æœ€å¾Œæ·»åŠ ä¸€é»ç©ºé–“ */
        }

        .line-numbers::after {
            content: '';
            display: block;
            height: 20px; /* èˆ‡å…§å®¹å°é½Š */
        }

        /* åˆ†å‰²æ¢ */
        .resize-handle {
            width: 5px;
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
            /* å¢åŠ å¯é»æ“Šå€åŸŸ */
            margin: 0 3px;
            padding: 0 1px;
            z-index: 10;
        }
        
        .resize-handle:hover {
            background: var(--accent-color);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            left: -5px;
            right: -5px;
            top: 0;
            bottom: 0;
            cursor: col-resize;
        }

        .resize-handle.hidden {
            display: none;
        }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar {
            height: var(--status-height);
            background: #1e3a5f; /* æ·±è—è‰²èƒŒæ™¯ */
            border-top: 1px solid #2d5a8e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 12px;
            color: #a8c7e8; /* æ·ºè—è‰²æ–‡å­— */
        }

        .status-bar .warning-text {
            color: #ffd700; /* é‡‘é»ƒè‰²è­¦å‘Šæ–‡å­— */
            font-weight: bold;
            margin-left: 20px;
        }

        /* å…¨å±æ¨¡å¼ */
        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .fullscreen .panel-content {
            height: calc(100% - 45px);
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .loading::before {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* åŒ¯å‡ºé¸å–® */
        .export-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 0;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }
        
        .export-menu.show {
            display: block;
        }
        
        .export-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-item:hover {
            background: var(--bg-hover);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .header {
                padding: 0 10px;
            }
            
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn span:not(:first-child) {
                display: none;
            }
            
            /* åœ¨æ‰‹æ©Ÿä¸Šé è¨­ä½¿ç”¨å–®æ¬„é¡¯ç¤º */
            .split-panel {
                flex: 1 !important;
            }
            
            .resize-handle {
                display: none !important;
            }
        }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            color: #ff6b6b;
            padding: 20px;
            text-align: center;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 6px;
            margin: 20px;
        }

        /* åˆ†æå ±å‘Šå…§å®¹æ¨£å¼ */
        .panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
            background: var(--bg-primary);
        }
        
        /* åˆ†æå ±å‘Šå®¹å™¨ */
        .analysis-wrapper {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
        }
        
        /* è¦†è“‹åˆ†æå ±å‘Šçš„æ¨£å¼ */
        .panel-content .report-content,
        .panel-content .report-line,
        .panel-content pre {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
            background: transparent;
        }
        
        .panel-content .report-line {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 2px 0;
        }

        /* åŸå§‹å…§å®¹å®¹å™¨ */
        .original-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        /* å…§å®¹è¡¨æ ¼å®¹å™¨ */
        .content-table-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
        }

        /* ä½¿ç”¨è¡¨æ ¼ä½ˆå±€ */
        .content-table {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        /* è¡Œè™Ÿå®¹å™¨ - å›ºå®šå¯¬åº¦ï¼Œä¸æ²å‹• */
        .line-numbers-container {
            width: 60px;
            min-width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* åˆ†æå ±å‘Šçš„ iframe å®¹å™¨æ¨£å¼ */
        .content-container iframe {
            position: relative;
            z-index: 1;
        }

        /* è¡Œè™Ÿå…§å®¹ */
        .analysis-with-line-numbers,
        .line-numbers-content {
            padding: 20px 10px 20px 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
        }

        /* è™›æ“¬è¡Œ hover æ•ˆæœ */
        .hover-overlay {
            pointer-events: none !important;
        }

        .current-line-highlight {
            pointer-events: none !important;
            will-change: transform, top;
        }

        /* å…§å®¹å®¹å™¨ - å¯æ²å‹• */
        .content-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
        }

        /* å…§å®¹å€åŸŸ */
        .content-area {
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            min-width: max-content;
        }

        /* åˆ†æå ±å‘Šå°ˆç”¨æ¨£å¼ - ä¸å½±éŸ¿å³å´ */
        #leftPanel .content-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #leftPanel .content-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            margin: 0;
            padding: 0;
        }

        /* ç¢ºä¿ wrapper ä¹Ÿå¡«æ»¿ */
        #leftPanel .original-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* ç§»é™¤å¯èƒ½çš„é¡å¤–é‚Šè· */
        #leftPanel .panel-content {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* ç¢ºä¿ iframe å…§å®¹ä¸æœƒæ©«å‘æº¢å‡º */
        #leftPanel iframe {
            max-width: 100%;
        }
                
        /* ç¢ºä¿ iframe å¡«æ»¿å®¹å™¨ */
        .content-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }        
        /* è¡Œè™Ÿåˆ—å›ºå®š */
        .line-number-column {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #1a1a1a;
            width: 60px;
            min-width: 60px;
            overflow: hidden;
        }

        .content-row {
            
        }

        .line-number-cell {
            display: table-cell;
            width: 60px;
            min-width: 60px;
            max-width: 80px;
            padding: 0 5px 0 0; /* æ¸›å°‘ padding */
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            vertical-align: top;
            background: #1a1a1a;
            border-right: 1px solid #333;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .content-cell {
            display: table-cell;
            padding: 0 20px 0 10px; /* èª¿æ•´å·¦å´ padding */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            vertical-align: top;
        }

        /* å…§å®¹å€åŸŸçš„å…§éƒ¨å®¹å™¨ */
        .content-inner {
            display: flex;
            position: relative;
        }

        /* åŸå§‹å…§å®¹æ¨£å¼ */
        .original-content {
            flex: 1;
            padding: 20px;
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            word-wrap: normal;
            color: #d4d4d4;
            background: transparent;
            min-width: max-content;
        }
        
        /* åˆ†æå ±å‘Šç‰¹å®šæ¨£å¼ */
        .panel-content .report-line {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 2px 0;
            color: var(--text-primary);
        }
        
        .panel-content .anr-type {
            color: #ff9800;
            font-weight: bold;
        }
        
        .panel-content .process-name {
            color: #4ec9b0;
            font-weight: bold;
        }
        
        .panel-content .timestamp {
            color: #608b4e;
        }
        
        .panel-content .separator {
            color: #565656;
        }
        
        .panel-content a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .panel-content a:hover {
            text-decoration: underline;
        }

        /* é«˜äº®æ¨£å¼ */
        .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; } /* é»ƒè‰² */
        .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; } /* ç¶ è‰² */
        .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; } /* è—è‰² */
        .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; } /* æ©™è‰² */
        .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; } /* ç²‰ç´… */

        /* å³éµé¸å–®æ¨£å¼ */
        .context-menu {
            position: fixed;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 5px 0;
            z-index: 10000;
            display: none;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
            max-height: 80vh; /* åŠ å…¥æœ€å¤§é«˜åº¦é™åˆ¶ */
            overflow-y: auto; /* å…§å®¹éå¤šæ™‚é¡¯ç¤ºæ²è»¸ */
            min-width: 180px; /* ç¢ºä¿é¸å–®æœ‰æœ€å°å¯¬åº¦ */
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.1s ease, transform 0.1s ease;            
        }

        .context-menu[style*="visibility: visible"] {
            opacity: 1;
            transform: scale(1);
        }

        .context-menu-item {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 13px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: #3a3a3a;
        }

        .context-menu-separator {
            height: 1px;
            background: #555;
            margin: 5px 0;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border: 1px solid #666;
            border-radius: 2px;
        }

        /* è¡Œè™Ÿæ¨£å¼ */
        .line-numbers {
            position: sticky;
            left: 0;
            flex-shrink: 0;
            width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px 10px 0 0; /* ç§»é™¤åº•éƒ¨ padding */
            margin: 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            z-index: 10;
            align-self: flex-start;
        }

        /* è¡Œè™Ÿé …ç›® */
        .line-number {
            display: block;
            height: 1.6em;
            line-height: 1.6em;
            cursor: pointer;
            padding-left: 10px;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .line-number:hover {
            background-color: var(--line-hover-color);
        }
                
        /* ç¬¬ä¸€è¡Œå’Œæœ€å¾Œä¸€è¡Œçš„ç‰¹æ®Šè™•ç† */
        .content-table::before,
        .content-table::after {
            content: '';
            display: table-row;
            height: 20px;
        }

        /* ç¢ºä¿ç¬¬ä¸€è¡Œå°é½Š */
        .line-numbers::before,
        .original-content::before {
            content: '';
            display: block;
            height: 20px; /* èˆ‡å…§å®¹çš„ padding-top ç›¸åŒ */
        }

        /* ç•¶å‰è¡Œé«˜äº® */
        .line-number.current {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .with-line-numbers {
            padding-left: 80px !important;
            position: relative;
        }

        /* é«˜äº®å°èˆªæç¤º */
        .highlight-nav-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #2d2d2d;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #e0e0e0;
            display: none;
            z-index: 1000;
        }

        /* æ›¸ç±¤æ¨£å¼ */
        .line-number.bookmarked::before {
            content: 'â—';
            position: absolute;
            left: 2px;
            color: #4ec9b0;
            font-size: 10px;
        }

        /* å…§å®¹è¡Œ */
        .content-line {
            height: 1.6em;
            line-height: 1.6em;
            cursor: text;
            position: relative;
        }

        .content-line:hover {
            background-color: var(--line-hover-color);
        }
 
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ - åªåœ¨å…§å®¹å€åŸŸ */
        .content-container::-webkit-scrollbar,
        .original-content-wrapper::-webkit-scrollbar,
        .panel-content::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .content-container::-webkit-scrollbar-track,
        .original-content-wrapper::-webkit-scrollbar-track,
        .panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .content-container::-webkit-scrollbar-thumb,
        .original-content-wrapper::-webkit-scrollbar-thumb,
        .panel-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .content-container::-webkit-scrollbar-thumb:hover,
        .original-content-wrapper::-webkit-scrollbar-thumb:hover,
        .panel-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ç¢ºä¿è¡Œè™Ÿå®¹å™¨æ°¸é ä¸é¡¯ç¤ºæ²è»¸ */
        .line-numbers-container::-webkit-scrollbar {
            display: none;
        }

        /* è¡Œè™Ÿæ‡¸åœæ•ˆæœ */
        .line-number:not(.bookmarked):hover::before {
            content: 'ğŸ“Œ';
            position: absolute;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
        }

        .line-number.bookmarked:hover::before {
            content: 'âœ•';
            color: #ff6666;
            left: 2px;
        }

        /* é«˜äº®æ§åˆ¶æŒ‰éˆ• - ä¿®æ­£ä½ç½® */
        .highlight-controls {
            position: absolute;
            right: 130px;
            display: flex;
            gap: 5px;
            z-index: 100;
            background: #1a1a1a;
            padding: 5px;
            border-radius: 4px;
            /* border: 1px solid #333;*/
        }

        .highlight-control-btn {
            width: 25px;
            height: 25px;
            border: 1px solid #555;
            border-radius: 20px;
            cursor: pointer;
            display: none;
            position: relative;
        }

        .highlight-control-btn:hover::after {
            content: 'âœ•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 12px;
            font-weight: bold;
        }

        #rightPanel {
            padding-right: 6px;
        }

        /* åˆ†æå ±å‘Šçš„è™›æ“¬è¡Œ hover æ•ˆæœ */
        .analysis-line-overlay {
            position: absolute;
            left: 60px; /* è¡Œè™Ÿå¯¬åº¦ */
            right: 0;
            height: 20.8px; /* 1.6em * 13px */
            pointer-events: none;
            background-color: transparent;
            transition: background-color 0.2s ease;
            z-index: 5;
        }

        .analysis-line-overlay.hover {
            background-color: var(--line-hover-color);
            opacity: 0.3;
        }

        /* iframe å®¹å™¨çš„ç›¸å°å®šä½ */
        .content-container.analysis-container {
            position: relative;
        }        
    </style>
    <style>
        /* å…§å®¹è¡Œæ¨£å¼ */
        .content-row {
            /* display: table-row; */
        }

        /* è¡Œè™Ÿå–®å…ƒæ ¼ - å›ºå®šåœ¨å·¦å´ */
        .line-number-cell {
            display: table-cell;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            padding: 0 10px 0 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            vertical-align: top;
            background: #1a1a1a;
            border-right: 1px solid #333;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        /* å…§å®¹å–®å…ƒæ ¼ */
        .content-cell {
            display: table-cell;
            padding: 0 20px 0 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            vertical-align: top;
            min-width: max-content; /* ç¢ºä¿å…§å®¹ä¸æœƒè¢«æˆªæ–· */
        }

        /* éš±è—è¡Œè™Ÿå€åŸŸçš„æ²è»¸ */
        .line-number-column::-webkit-scrollbar {
            display: none;
        }

        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ï¼ˆå¯é¸ï¼‰ */
        .content-table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .content-table-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .content-table-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .content-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ç¢ºä¿åªæœ‰å…§å®¹å€åŸŸå¯ä»¥æ²å‹• */
        .panel-content {
            overflow: hidden; /* é¢æ¿æœ¬èº«ä¸é¡¯ç¤ºæ²è»¸ */
        }        
    </style>
    <style>
        /* å·¦å´åˆ†æå ±å‘Šå°ˆç”¨çš„è¡Œè™Ÿæ¨£å¼ */
        #leftPanel .line-numbers-container {
            width: 60px;
            min-width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow: hidden;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        #leftPanel .analysis-line-numbers {
            position: relative;
            width: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
        }

        #leftPanel .analysis-line-number {
            position: absolute;
            width: 100%;
            padding: 0 10px 0 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #666;
            user-select: none;
            cursor: pointer;
            background: #1a1a1a;
            transition: background-color 0.2s ease;
        }

        #leftPanel .analysis-line-number:hover {
            background-color: var(--line-hover-color);
        }

        #leftPanel .analysis-line-number.bookmarked::before {
            content: 'â—';
            position: absolute;
            left: 2px;
            color: #4ec9b0;
            font-size: 10px;
        }

        #leftPanel .analysis-line-number:not(.bookmarked):hover::before {
            content: 'ğŸ“Œ';
            position: absolute;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
        }

        #leftPanel .analysis-line-number.bookmarked:hover::before {
            content: 'âœ•';
            color: #ff6666;
            left: 2px;
        }

        /* å³å´åˆ†æå ±å‘Šå°ˆç”¨çš„è¡Œè™Ÿæ¨£å¼ */
        #rightPanel .analysis-line-numbers {
            position: relative;
            width: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
        }

        #rightPanel .analysis-line-number {
            position: absolute;
            width: 100%;
            padding: 0 10px 0 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #666;
            user-select: none;
            cursor: pointer;
            background: #1a1a1a;
            transition: background-color 0.2s ease;
        }

        #rightPanel .analysis-line-number:hover {
            background-color: var(--line-hover-color);
        }

        #rightPanel .analysis-line-number.bookmarked::before {
            content: 'â—';
            position: absolute;
            left: 2px;
            color: #4ec9b0;
            font-size: 10px;
        }

        #rightPanel .analysis-line-number:not(.bookmarked):hover::before {
            content: 'ğŸ“Œ';
            position: absolute;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
        }

        #rightPanel .analysis-line-number.bookmarked:hover::before {
            content: 'âœ•';
            color: #ff6666;
            left: 2px;
        }

        /* å…¨åŸŸé¸å–æ¨£å¼ - çµ±ä¸€å·¦å³è¦–çª— */
        ::selection {
            background-color: rgba(78, 201, 176, 0.3);
            color: inherit;
        }

        ::-moz-selection {
            background-color: rgba(78, 201, 176, 0.3);
            color: inherit;
        }

        /* å³å´åŸå§‹æª”æ¡ˆçš„é¸å–æ¨£å¼ */
        #rightContent ::selection,
        #rightContentArea ::selection,
        .content-line ::selection,
        .content-cell ::selection {
            background-color: rgba(78, 201, 176, 0.3);
            color: inherit;
        }

        #rightContent ::-moz-selection,
        #rightContentArea ::-moz-selection,
        .content-line ::-moz-selection,
        .content-cell ::-moz-selection {
            background-color: rgba(78, 201, 176, 0.3);
            color: inherit;
        }

        /* å·¦å´åˆ†æå ±å‘Šçš„é¸å–æ¨£å¼ï¼ˆç•¶ä¸æ˜¯ iframe æ™‚ï¼‰ */
        #leftContent ::selection,
        #leftContentArea ::selection {
            background-color: rgba(78, 201, 176, 0.3);
            color: inherit;
        }

        #leftContent ::-moz-selection,
        #leftContentArea ::-moz-selection {
            background-color: rgba(78, 201, 176, 0.3);
            color: inherit;
        }

        /* ç¢ºä¿è¡Œè™Ÿä¸è¢«é¸å– */
        .line-numbers ::selection,
        .line-number ::selection,
        .analysis-line-number ::selection,
        .line-number-cell ::selection {
            background: none !important;
        }

        .line-numbers ::-moz-selection,
        .line-number ::-moz-selection,
        .analysis-line-number ::-moz-selection,
        .line-number-cell ::-moz-selection {
            background: none !important;
        }

        /* æ›¸ç±¤å°èˆªå‹•ç•« - åŠ åœ¨å…¶ä»–æ¨£å¼çš„æœ€å¾Œé¢ */
        .line-number.bookmark-flash,
        .analysis-line-number.bookmark-flash {
            animation: bookmarkFlash 0.6s ease-in-out;
        }

        @keyframes bookmarkFlash {
            0% { 
                background-color: transparent; 
                transform: scale(1);
            }
            50% { 
                background-color: #4ec9b0; 
                transform: scale(1.05);
            }
            100% { 
                background-color: transparent;
                transform: scale(1);
            }
        }

        /* ç¢ºä¿å‹•ç•«æ™‚ä¸å½±éŸ¿å…¶ä»–å…ƒç´  */
        .line-numbers-container {
            overflow: visible !important;
        }

        /* çµ±ä¸€å·¦å³è¦–çª—çš„è¡Œè™Ÿ hover æ•ˆæœ */
        #leftPanel .line-number:hover,
        #leftPanel .analysis-line-number:hover,
        #rightPanel .line-number:hover,
        #rightPanel .analysis-line-number:hover {
            background-color: var(--line-hover-color) !important;
        }

        /* ç¢ºä¿ hover æ™‚æ¸¸æ¨™æ­£ç¢º */
        .line-number,
        .analysis-line-number {
            cursor: pointer;
        }

    </style>   
</head>
<body>
    <!-- é ‚éƒ¨å·¥å…·åˆ— -->
    <div class="header">
        <div class="header-left">
            <div class="file-info">
                <h1 id="filename">è¼‰å…¥ä¸­...</h1>
                <p id="filepath">{{ file_path }}</p>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" id="toggleOriginalBtn" onclick="toggleOriginalPanel()">
                <span>ğŸ“„</span>
                <span>æŸ¥çœ‹åŸå§‹æª”æ¡ˆ</span>
            </button>
            <button class="btn" id="switchPanelsBtn" onclick="switchPanels()" style="display: none;">
                <span>ğŸ”„</span>
                <span>å·¦å³äº¤æ›</span>
            </button>
            <button class="btn" onclick="toggleFullscreenMode()">
                <span>â›¶</span>
                <span>å…¨å±æ¨¡å¼</span>
            </button>
            <a href="/view-analysis?path={{ file_path }}&download=true" class="btn" download>
                <span>ğŸ“¥</span>
                <span>ä¸‹è¼‰åˆ†æ</span>
            </a>
            <a href="/view-analysis?path={{ file_path }}&download=true&original=true" class="btn" download>
                <span>ğŸ“¥</span>
                <span>ä¸‹è¼‰åŸå§‹</span>
            </a>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container" id="mainContainer">
        <!-- å·¦å´é¢æ¿ï¼ˆé è¨­é¡¯ç¤ºåˆ†æå ±å‘Šï¼‰ -->
        <div class="split-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="leftPanelIcon">ğŸ“Š</span>
                    <span id="leftPanelTitle">åˆ†æå ±å‘Š</span>
                </div>
                <!-- å·¦å´é«˜äº®æ§åˆ¶æŒ‰éˆ• -->
                <div class="highlight-controls" id="leftHighlightControls">
                    <div class="highlight-control-btn" id="leftHighlightBtn1" style="background: rgba(255, 255, 0, 0.6);" onclick="clearHighlightColor(1, 'left')" title="æ¸…é™¤é»ƒè‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn2" style="background: rgba(0, 255, 0, 0.6);" onclick="clearHighlightColor(2, 'left')" title="æ¸…é™¤ç¶ è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn3" style="background: rgba(0, 191, 255, 0.6);" onclick="clearHighlightColor(3, 'left')" title="æ¸…é™¤è—è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn4" style="background: rgba(255, 165, 0, 0.6);" onclick="clearHighlightColor(4, 'left')" title="æ¸…é™¤æ©™è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn5" style="background: rgba(255, 192, 203, 0.6);" onclick="clearHighlightColor(5, 'left')" title="æ¸…é™¤ç²‰ç´…é«˜äº®"></div>
                </div>                
                <div class="panel-controls">
                    <button class="icon-btn" onclick="copyPanelContent('left')" title="è¤‡è£½å…§å®¹">
                        <span id="leftCopyIcon">ğŸ“‹</span>
                    </button>                        
                    <button class="icon-btn" onclick="toggleExportMenu('left')" title="åŒ¯å‡º">
                        ğŸ’¾
                    </button>
                    <div class="export-menu" id="leftExportMenu">
                        <div class="export-item" onclick="exportContent('left', 'html')">
                            <span>ğŸŒ</span> HTML
                        </div>
                        <div class="export-item" onclick="exportContent('left', 'markdown')">
                            <span>ğŸ“</span> Markdown
                        </div>
                        <div class="export-item" onclick="exportContent('left', 'txt')">
                            <span>ğŸ“„</span> ç´”æ–‡å­—
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleFullscreen('left')" title="å…¨å±">
                        â›¶
                    </button>
                </div>
            </div>
            <div class="panel-content" id="leftContent">
                <div class="loading">è¼‰å…¥åˆ†æå ±å‘Šä¸­...</div>
            </div>
        </div>
        
        <!-- åˆ†å‰²æ¢ -->
        <div class="resize-handle hidden" id="resizeHandle"></div>
        
        <!-- å³å´é¢æ¿ï¼ˆé è¨­éš±è—ï¼‰ -->
        <div class="split-panel hidden" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="rightPanelIcon">ğŸ“„</span>
                    <span id="rightPanelTitle">åŸå§‹æª”æ¡ˆ</span>
                </div>
                <!-- é«˜äº®æ§åˆ¶æŒ‰éˆ• -->
                <div class="highlight-controls" id="highlightControls">
                    <div class="highlight-control-btn" id="highlightBtn1" style="background: rgba(255, 255, 0, 0.6);" onclick="clearHighlightColor(1, 'right')" title="æ¸…é™¤é»ƒè‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn2" style="background: rgba(0, 255, 0, 0.6);" onclick="clearHighlightColor(2, 'right')" title="æ¸…é™¤ç¶ è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn3" style="background: rgba(0, 191, 255, 0.6);" onclick="clearHighlightColor(3, 'right')" title="æ¸…é™¤è—è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn4" style="background: rgba(255, 165, 0, 0.6);" onclick="clearHighlightColor(4, 'right')" title="æ¸…é™¤æ©™è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn5" style="background: rgba(255, 192, 203, 0.6);" onclick="clearHighlightColor(5, 'right')" title="æ¸…é™¤ç²‰ç´…é«˜äº®"></div>
                </div>                
                <div class="panel-controls">
                    <button class="icon-btn" onclick="copyPanelContent('right')" title="è¤‡è£½å…§å®¹">
                        <span id="rightCopyIcon">ğŸ“‹</span>
                    </button>                                                
                    <button class="icon-btn" onclick="toggleExportMenu('right')" title="åŒ¯å‡º">
                        ğŸ’¾
                    </button>
                    <div class="export-menu" id="rightExportMenu">
                        <div class="export-item" onclick="exportContent('right', 'html')">
                            <span>ğŸŒ</span> HTML
                        </div>
                        <div class="export-item" onclick="exportContent('right', 'markdown')">
                            <span>ğŸ“</span> Markdown
                        </div>
                        <div class="export-item" onclick="exportContent('right', 'txt')">
                            <span>ğŸ“„</span> ç´”æ–‡å­—
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleFullscreen('right')" title="å…¨å±">
                        â›¶
                    </button>
                    <button class="icon-btn" onclick="closePanel('right')" title="é—œé–‰">
                        âœ•
                    </button>
                </div>
            </div>
            <div class="panel-content" id="rightContent">
                <div class="loading">æº–å‚™è¼‰å…¥åŸå§‹æª”æ¡ˆ...</div>
            </div>
        </div>
    </div>
    
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div class="status-left">
            <span id="statusText">å°±ç·’</span>
        </div>
        <div class="status-right">
            <span id="reportType">{{ report_type.upper() }} å ±å‘Š</span>
            <span> | </span>
            <span id="loadTime">è¼‰å…¥æ™‚é–“: è¨ˆç®—ä¸­...</span>
        </div>
    </div>
    <!-- é«˜äº®å°èˆªæç¤º -->
    <div class="highlight-nav-hint" id="highlightNavHint">
        F2: ä¸‹ä¸€å€‹é«˜äº® | F3: ä¸Šä¸€å€‹é«˜äº®
    </div>    
    <script>
        // å…¨åŸŸè®Šæ•¸
        const filePath = {{ escaped_file_path | safe }};
        let analysisContent = '';  // åˆ†æå ±å‘Šå…§å®¹
        let originalContent = '';  // åŸå§‹æª”æ¡ˆå…§å®¹
        let isOriginalLoaded = false;
        let currentLeftType = 'analysis';
        let currentRightType = 'original';
        let startTime = Date.now();
        let currentFocusedPanel = 'left';
        let currentFocusedLine = 1;
        let bookmarks = new Set();
        let currentBookmarkIndex = -1;
        let bookmarkArray = [];
        // æ”¹ç‚ºæ¯å€‹é¢æ¿å„è‡ªçš„æ›¸ç±¤ç´¢å¼•
        let leftBookmarkIndex = -1;
        let rightBookmarkIndex = -1;
        let currentFocusedLineSource = 'content'; // 'lineNumber' æˆ– 'content'

        // ç¢ºä¿å…¨åŸŸè®Šæ•¸è¢«æ­£ç¢ºåˆå§‹åŒ–
        if (typeof window.currentFocusedPanel === 'undefined') {
            window.currentFocusedPanel = 'left';
        }
        if (typeof window.currentFocusedLine === 'undefined') {
            window.currentFocusedLine = 1;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateFilename();
            loadAnalysisContent();
            
            // è‡ªå‹•é–‹å•ŸåŸå§‹æª”æ¡ˆè¦–çª—
            setTimeout(() => {
                toggleOriginalPanel();  // è‡ªå‹•é–‹å•Ÿå³å´é¢æ¿
            }, 500);
            
            setupResizeHandler();
            setupKeyboardShortcuts();

            // é»æ“Šå¤–éƒ¨é—œé–‰åŒ¯å‡ºé¸å–®
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.export-menu') && !e.target.closest('.icon-btn')) {
                    closeAllExportMenus();
                }
            });
        });
        
        // æ›´æ–°æª”åé¡¯ç¤º
        function updateFilename() {
            // è§£ç¢¼ HTML ç·¨ç¢¼çš„æª”æ¡ˆè·¯å¾‘
            const decodedPath = decodeURIComponent(filePath);
            const pathParts = decodedPath.split('/');
            let filename = pathParts[pathParts.length - 1];
            
            // ç§»é™¤ .analyzed.html å¾Œç¶´ä»¥é¡¯ç¤ºæ›´ç°¡æ½”çš„æª”å
            filename = filename.replace('.analyzed.html', '');
            filename = filename.replace('.analyzed.txt', '');
            
            document.getElementById('filename').textContent = filename;
        }
        
        // è¼‰å…¥åˆ†æå ±å‘Šå…§å®¹
        async function loadAnalysisContent() {
            try {
                const response = await fetch(`/api/load-analysis?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    analysisContent = data.content;  // å„²å­˜åˆ†æå ±å‘Šå…§å®¹
                    
                    // èª¿è©¦ï¼šæª¢æŸ¥å…§å®¹é¡å‹
                    console.log('Content type:', typeof data.content);
                    console.log('Content preview:', data.content.substring(0, 200));
                    
                    displayContent('left', data.content, 'analysis');
                    updateLoadTime();
                } else {
                    showError('left', data.error);
                }
            } catch (error) {
                showError('left', 'è¼‰å…¥åˆ†æå ±å‘Šå¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥åŸå§‹æª”æ¡ˆå…§å®¹
        async function loadOriginalContent() {
            if (isOriginalLoaded) return;
            
            updateStatus('è¼‰å…¥åŸå§‹æª”æ¡ˆä¸­...');
            
            try {
                const response = await fetch(`/api/load-original?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    originalContent = data.content;  // å„²å­˜åŸå§‹æª”æ¡ˆå…§å®¹
                    displayContent('right', data.content, 'original');
                    isOriginalLoaded = true;
                    updateStatus('åŸå§‹æª”æ¡ˆå·²è¼‰å…¥');
                } else {
                    showError('right', data.error || 'æ‰¾ä¸åˆ°åŸå§‹æª”æ¡ˆ');
                    updateStatus('è¼‰å…¥åŸå§‹æª”æ¡ˆå¤±æ•—');
                }
            } catch (error) {
                showError('right', 'è¼‰å…¥åŸå§‹æª”æ¡ˆå¤±æ•—: ' + error.message);
                updateStatus('è¼‰å…¥åŸå§‹æª”æ¡ˆå¤±æ•—');
            }
        }

        // é¡¯ç¤ºå…§å®¹
        function displayContent(panel, content, type) {
            const contentEl = document.getElementById(panel + 'Content');
            
            if (type === 'analysis') {
                // åˆ†æå ±å‘Šè™•ç†
                if (panel === 'left' && currentLeftType === 'analysis') {
                    analysisContent = content;
                } else if (panel === 'right' && currentRightType === 'analysis') {
                    analysisContent = content;
                }
                
                // å»ºç«‹çµæ§‹
                const wrapper = document.createElement('div');
                wrapper.className = 'original-content-wrapper';
                wrapper.id = `${panel}ContentWrapper`;
                
                // å»ºç«‹è¡Œè™Ÿå®¹å™¨
                const lineNumbersContainer = document.createElement('div');
                lineNumbersContainer.className = 'line-numbers-container';
                lineNumbersContainer.id = `${panel}LineNumbersContainer`;
                
                const lineNumbersContent = document.createElement('div');
                lineNumbersContent.className = 'line-numbers-content';
                lineNumbersContent.id = `${panel}LineNumbers`;
                
                // å»ºç«‹å…§å®¹å®¹å™¨
                const contentContainer = document.createElement('div');
                contentContainer.className = 'content-container';
                contentContainer.id = `${panel}ContentContainer`;
                contentContainer.style.position = 'relative';
                
                // å»ºç«‹ iframe
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.srcdoc = content;
                
                // çµ„è£çµæ§‹
                lineNumbersContainer.appendChild(lineNumbersContent);
                contentContainer.appendChild(iframe);
                wrapper.appendChild(lineNumbersContainer);
                wrapper.appendChild(contentContainer);
                
                contentEl.innerHTML = '';
                contentEl.appendChild(wrapper);
                
                // iframe è¼‰å…¥å¾Œçš„è™•ç†
                iframe.onload = function() {
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument;
                            const iframeWindow = iframe.contentWindow;
                            if (iframeDoc && iframeWindow) {
                                // æ³¨å…¥æ¨£å¼
                                const style = iframeDoc.createElement('style');
                                style.textContent = `
                                    html, body {
                                        margin: 0;
                                        padding: 0;
                                        height: 100%;
                                        overflow: auto;
                                    }
                                    
                                    body {
                                        line-height: 1.6em;
                                        font-size: 13px;
                                        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        overflow-wrap: break-word;
                                        max-width: 100%;
                                        background: transparent;
                                    }

                                    /* é¸å–æ¨£å¼ */
                                    ::selection {
                                        background-color: rgba(78, 201, 176, 0.3);
                                        color: inherit;
                                    }
                                    
                                    ::-moz-selection {
                                        background-color: rgba(78, 201, 176, 0.3);
                                        color: inherit;
                                    }
                                    
                                    /* ç¢ºä¿é¸å–æ™‚æ–‡å­—ä¿æŒå¯è®€ */
                                    .report-content ::selection,
                                    .left-panel ::selection,
                                    pre ::selection {
                                        background-color: rgba(78, 201, 176, 0.3);
                                        color: inherit;
                                    }
                                    
                                    .report-content,
                                    .left-panel,
                                    .analysis-content {
                                        margin: 0;
                                        padding: 20px;
                                        box-sizing: border-box;
                                    }
                                    
                                    * {
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        overflow-wrap: break-word;
                                        max-width: 100%;
                                    }
                                    
                                    pre, code {
                                        white-space: pre-wrap;
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        overflow-wrap: break-word;
                                    }
                                    
                                    ::-webkit-scrollbar {
                                        height: 8px;
                                        width: 8px;
                                    }
                                    
                                    ::-webkit-scrollbar-track {
                                        background: #1a1a1a;
                                    }
                                    
                                    ::-webkit-scrollbar-thumb {
                                        background: #444;
                                        border-radius: 4px;
                                    }
                                    
                                    ::-webkit-scrollbar-thumb:hover {
                                        background: #555;
                                    }
                                    
                                    * {
                                        scrollbar-width: thin;
                                        scrollbar-color: #444 #1a1a1a;
                                    }
                                    
                                    .report-line {
                                        line-height: 1.6em;
                                        font-size: 13px;
                                        margin: 0;
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        min-height: 1.6em;  /* ç¢ºä¿ç©ºè¡Œä¹Ÿæœ‰æœ€å°é«˜åº¦ */
                                    }

                                    /* ç¢ºä¿ç©ºçš„ report-line ä¹Ÿä½”æ“šç©ºé–“ */
                                    .report-line:empty::before {
                                        content: '\\00a0';  /* ä¸å¯è¦‹çš„ç©ºæ ¼ */
                                        display: inline-block;
                                    }
                                        
                                    .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; }
                                    .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; }
                                    .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; }
                                    .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; }
                                    .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; }
                                `;
                                iframeDoc.head.appendChild(style);

                                // ç¢ºä¿æ‰€æœ‰åˆ†æå ±å‘Šéƒ½ç”Ÿæˆè¡Œè™Ÿ
                                const generateAnalysisLineNumbers = function() {
                                    // è¨ˆç®—å¯¦éš›è¡Œé«˜çš„å‡½æ•¸
                                    const measureActualLines = function() {
                                        const reportContent = iframeDoc.querySelector('.report-content') || 
                                                            iframeDoc.querySelector('.left-panel') ||
                                                            iframeDoc.querySelector('#reportContent') ||
                                                            iframeDoc.querySelector('pre') ||
                                                            iframeDoc.body;
                                        
                                        if (!reportContent) {
                                            console.log('æ‰¾ä¸åˆ°å ±å‘Šå…§å®¹');
                                            return [];
                                        }
                                        
                                        const computedStyle = iframeWindow.getComputedStyle(reportContent);
                                        const paddingTop = parseFloat(computedStyle.paddingTop) || 0;
                                        
                                        const lineData = [];
                                        
                                        // å„ªå…ˆä½¿ç”¨ .report-line å…ƒç´ 
                                        const reportLines = reportContent.querySelectorAll('.report-line');
                                        if (reportLines.length > 0) {
                                            reportLines.forEach((element, index) => {
                                                const rect = element.getBoundingClientRect();
                                                const y = rect.top + iframeWindow.pageYOffset;
                                                
                                                // è¨­å®šæœ€å°é«˜åº¦ï¼Œç¢ºä¿è¡Œè™Ÿå¯è¦‹
                                                const minHeight = 20.8; // 1.6em * 13px
                                                const actualHeight = rect.height || 0;
                                                const height = Math.max(actualHeight, minHeight);
                                                
                                                lineData.push({
                                                    index: index + 1,
                                                    top: y - paddingTop,
                                                    height: height,  // ä½¿ç”¨è¨ˆç®—å¾Œçš„é«˜åº¦
                                                    element: element
                                                });
                                            });
                                        } else if (reportContent.tagName === 'PRE') {
                                            // PRE æ¨™ç±¤çš„è™•ç†ä¿æŒä¸è®Š
                                            const lines = reportContent.textContent.split('\n');
                                            let currentTop = paddingTop;
                                            const lineHeight = 20.8;
                                            
                                            lines.forEach((line, index) => {
                                                lineData.push({
                                                    index: index + 1,
                                                    top: currentTop,
                                                    height: lineHeight,
                                                    element: null
                                                });
                                                currentTop += lineHeight;
                                            });
                                        } else {
                                            // è™•ç†å…¶ä»–å…ƒç´ ï¼Œä½†æ’é™¤å®¹å™¨æœ¬èº«
                                            const allElements = reportContent.querySelectorAll('*');
                                            let currentLine = 1;
                                            let lastY = -999;
                                            
                                            allElements.forEach(element => {
                                                // é‡è¦ï¼šè·³éå®¹å™¨å…ƒç´ æœ¬èº«å’Œå…¶ç›´æ¥ wrapper
                                                if (element === reportContent || 
                                                    element.id === 'reportContent' ||
                                                    element.classList.contains('panel-content')) {
                                                    return;
                                                }
                                                
                                                const style = iframeWindow.getComputedStyle(element);
                                                if (style.display === 'none' || style.visibility === 'hidden') {
                                                    return;
                                                }
                                                
                                                // åªè™•ç†æœ‰å¯¦éš›å…§å®¹çš„å…ƒç´ 
                                                const text = element.textContent.trim();
                                                if (text.length === 0 && element.tagName !== 'BR') {
                                                    return;
                                                }
                                                
                                                // ç¢ºä¿ä¸æ˜¯çˆ¶å®¹å™¨çš„é‡è¤‡å…§å®¹
                                                if (element.children.length > 1) {
                                                    return; // è·³éæœ‰å¤šå€‹å­å…ƒç´ çš„å®¹å™¨
                                                }
                                                
                                                const rect = element.getBoundingClientRect();
                                                const y = rect.top + iframeWindow.pageYOffset;
                                                
                                                if (Math.abs(y - lastY) > 5) {
                                                    lineData.push({
                                                        index: currentLine,
                                                        top: y - paddingTop,
                                                        height: rect.height || 20.8,
                                                        element: element
                                                    });
                                                    currentLine++;
                                                    lastY = y;
                                                }
                                            });
                                        }
                                        
                                        // ç¢ºä¿è‡³å°‘æœ‰ä¸€è¡Œ
                                        if (lineData.length === 0) {
                                            lineData.push({
                                                index: 1,
                                                top: 0,
                                                height: 20.8,
                                                element: null
                                            });
                                        }
                                        
                                        console.log('Line Data Debug:', {
                                            ç¸½è¡Œæ•¸: lineData.length,
                                            æœ€å¾Œä¸€è¡Œ: lineData[lineData.length - 1],
                                            ç¬¬ä¸€è¡Œ: lineData[0]
                                        });
                                                                              
                                        return lineData;
                                    };
                                    
                                    // ç”Ÿæˆå‹•æ…‹è¡Œè™Ÿ
                                    const generateDynamicLineNumbers = function(lineData) {
                                        lineNumbersContent.innerHTML = '';
                                        lineNumbersContent.className = 'analysis-line-numbers';
                                        lineNumbersContent.style.paddingTop = '20px';
                                        lineNumbersContent.style.paddingBottom = '20px';
                                        
                                        lineData.forEach(data => {
                                            const lineNumberEl = document.createElement('span');
                                            lineNumberEl.className = 'analysis-line-number';
                                            lineNumberEl.setAttribute('data-line', String(data.index));
                                            lineNumberEl.setAttribute('data-panel', panel);
                                            lineNumberEl.textContent = data.index;
                                            
                                            lineNumberEl.style.position = 'absolute';
                                            lineNumberEl.style.top = (data.top + 20) + 'px';
                                            lineNumberEl.style.height = data.height + 'px';
                                            lineNumberEl.style.lineHeight = data.height + 'px';
                                            lineNumberEl.style.width = '50px';
                                            lineNumberEl.style.display = 'block';
                                            lineNumberEl.style.minHeight = '20.8px';  // ç¢ºä¿æœ€å°é«˜åº¦

                                            lineNumberEl.addEventListener('click', function(e) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                toggleBookmark(this);
                                            });
                                            
                                            lineNumberEl.addEventListener('mouseenter', function() {
                                                window.currentFocusedLine = data.index;
                                                window.currentFocusedPanel = panel;
                                                window.currentFocusedLineSource = 'lineNumber';  // æ¨™è¨˜ä¾†æº
                                                highlightCurrentLineNumber(panel, data.index);
                                            });
                                            
                                            lineNumbersContent.appendChild(lineNumberEl);
                                        });
                                        
                                        if (lineData.length > 0) {
                                            const lastLine = lineData[lineData.length - 1];
                                            const totalHeight = lastLine.top + lastLine.height + 40;
                                            lineNumbersContent.style.height = totalHeight + 'px';
                                            lineData.push({
                                                index: lineData.length + 1,
                                                top: lastLine.top + lastLine.height,
                                                height: 20.8,  // æ¨™æº–è¡Œé«˜
                                                element: null,
                                                isVirtual: true  // æ¨™è¨˜ç‚ºè™›æ“¬è¡Œ
                                            });                                            
                                        }
                                        
                                        return lineData.length;
                                    };
                                    
                                    // ç­‰å¾…å…§å®¹è¼‰å…¥å®Œæˆ
                                    const waitForContent = function(callback) {
                                        let attempts = 0;
                                        const checkInterval = setInterval(() => {
                                            const reportContent = iframeDoc.querySelector('.left-panel') ||
                                                                iframeDoc.querySelector('.report-content') ||
                                                                iframeDoc.querySelector('pre') ||
                                                                iframeDoc.body;
                                            
                                            if ((reportContent && reportContent.scrollHeight > 100) || attempts > 20) {
                                                clearInterval(checkInterval);
                                                callback();
                                            }
                                            attempts++;
                                        }, 100);
                                    };
                                    
                                    waitForContent(() => {
                                        const lineData = measureActualLines();
                                        const lineCount = generateDynamicLineNumbers(lineData);
                                        
                                        window[`${panel}LineCount`] = lineCount;
                                        window[`${panel}LineData`] = lineData;
                                        
                                        // è¨­å®šæ²å‹•åŒæ­¥
                                        const bindScrollEvents = function() {
                                            const scrollableElement = iframeDoc.querySelector('.left-panel') || 
                                                                    iframeDoc.documentElement || 
                                                                    iframeDoc.body;
                                            
                                            if (scrollableElement) {
                                                const syncScroll = function() {
                                                    const scrollTop = scrollableElement.scrollTop || 
                                                                    iframeWindow.pageYOffset || 
                                                                    iframeDoc.documentElement.scrollTop || 
                                                                    iframeDoc.body.scrollTop || 0;
                                                    
                                                    lineNumbersContent.style.transform = `translateY(-${scrollTop}px)`;
                                                };
                                                
                                                scrollableElement.addEventListener('scroll', syncScroll);
                                                syncScroll();
                                            }
                                        };
                                        
                                        bindScrollEvents();
                                        
                                        // è¨­ç½®å®Œæ•´çš„äº‹ä»¶è™•ç†
                                        setupAnalysisEvents();
                                    });
                                };
                                
                                // è¨­ç½®åˆ†æå ±å‘Šçš„æ‰€æœ‰äº‹ä»¶
                                const setupAnalysisEvents = function() {
                                    // è¨­ç½®å³éµé¸å–®
                                    setupIframeContextMenu(iframe, panel);
                                    
                                    // è¨­ç½®éµç›¤äº‹ä»¶
                                    iframeDoc.addEventListener('keydown', function(e) {                                       
                                        // é˜»æ­¢ iframe å…§çš„é è¨­è¡Œç‚º
                                        if (e.key === 'F2' || e.key === 'F3') {
                                            e.preventDefault();
                                            e.stopPropagation();
                                        }
                                        
                                        // æ›´æ–°ç•¶å‰ç„¦é»è³‡è¨Š
                                        window.currentFocusedPanel = panel;
                                        
                                        // å¦‚æœæ˜¯F2ï¼Œç¢ºä¿æœ‰æ­£ç¢ºçš„è¡Œè™Ÿ
                                        if (e.key === 'F2' && window.currentFocusedLine) {

                                            // æª¢æŸ¥æ»‘é¼ æ˜¯å¦åœ¨è¡Œè™Ÿå…ƒç´ ä¸Š
                                            const hoveredElement = document.elementFromPoint(
                                                window.lastMouseX || 0, 
                                                window.lastMouseY || 0
                                            );

                                            // ç›´æ¥åœ¨é€™è£¡è™•ç†F2ï¼Œç¢ºä¿è¡Œè™Ÿæ­£ç¢º
                                            const isOnLineNumber = hoveredElement && (
                                                hoveredElement.classList.contains('analysis-line-number') ||
                                                hoveredElement.classList.contains('line-number') ||
                                                hoveredElement.closest('.line-numbers-container')
                                            );
                                            
                                            console.log('F2 Debug (setupAnalysisEvents) - Hover æª¢æŸ¥:', {
                                                hoveredElement: hoveredElement,
                                                isOnLineNumber: isOnLineNumber,
                                                classes: hoveredElement?.className
                                            });

                                            let line = window.currentFocusedLine;
                                            const panelType = (panel === 'left') ? currentLeftType : currentRightType;                   
                                            // åªæœ‰å·¦å´çš„åˆ†æå ±å‘Šä¸”æ»‘é¼ ä¸åœ¨è¡Œè™Ÿä¸Šæ™‚éœ€è¦ -1
                                            if (panel === 'left' && panelType === 'analysis' && !isOnLineNumber) {
                                                line = window.currentFocusedLine - 1;
                                                // é˜²å‘†ï¼šç¢ºä¿è¡Œè™Ÿè‡³å°‘ç‚º 1
                                                line = Math.max(1, line);
                                            }
                                            let lineElement = lineNumbersContent.querySelector(`.analysis-line-number[data-line="${line}"]`);                                                                                        
                                            if (lineElement) {
                                                toggleBookmark(lineElement);
                                                updateStatus(`å·²åœ¨${panel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿ç¬¬ ${window.currentFocusedLine} è¡Œåˆ‡æ›æ›¸ç±¤`);
                                                return;
                                            }
                                        }
                                        
                                        // å‚³éå…¶ä»–éµç›¤äº‹ä»¶åˆ°ä¸»è¦–çª—
                                        const event = new KeyboardEvent('keydown', {
                                            key: e.key,
                                            keyCode: e.keyCode,
                                            ctrlKey: e.ctrlKey,
                                            altKey: e.altKey,
                                            shiftKey: e.shiftKey,
                                            metaKey: e.metaKey,
                                            bubbles: true
                                        });
                                        document.dispatchEvent(event);
                                    });
                                    
                                    // ç¢ºä¿é»æ“Š iframe å…§å®¹æ™‚ä¹Ÿèƒ½ç²å¾—ç„¦é»
                                    iframeDoc.addEventListener('click', function() {
                                        window.currentFocusedPanel = panel;
                                        iframeDoc.body.focus();
                                    });

                                    // ç¢ºä¿ iframe å¯ä»¥ç²å¾—ç„¦é»
                                    iframeDoc.body.setAttribute('tabindex', '0');
                                    
                                    // è¨­ç½®æ»‘é¼ è¿½è¹¤
                                    const trackMouse = function(e) {
                                        const lineData = window[`${panel}LineData`];
                                        if (!lineData) return;
                                        
                                        const leftPanel = iframeDoc.querySelector('.left-panel');
                                        const scrollTop = leftPanel ? leftPanel.scrollTop : 
                                                        (iframeWindow.pageYOffset || 
                                                        iframeDoc.documentElement.scrollTop || 
                                                        iframeDoc.body.scrollTop || 0);
                                        
                                        const rect = iframe.getBoundingClientRect();
                                        const y = e.clientY - rect.top + scrollTop - 20;
                                        
                                        let targetLine = null;
                                        for (let i = 0; i < lineData.length; i++) {
                                            const data = lineData[i];
                                            if (y >= data.top && y < data.top + data.height) {
                                                targetLine = data.index;
                                                break;
                                            }
                                        }
                                        
                                        if (targetLine) {
                                            /*console.log('Mouse Track Debug:', {
                                                targetLine: targetLine,
                                                y: y,
                                                scrollTop: scrollTop,
                                                è¨ˆç®—çš„y: `${e.clientY} - ${rect.top} + ${scrollTop} - 20 = ${y}`
                                            });*/                                            
                                            window.currentFocusedLine = targetLine;
                                            window.currentFocusedPanel = panel;
                                            window.currentFocusedLineSource = 'content';  // æ¨™è¨˜ä¾†æº                                            
                                            highlightCurrentLineNumber(panel, targetLine);
                                        }
                                    };
                                    
                                    iframeDoc.addEventListener('mousemove', trackMouse);
                                    contentContainer.addEventListener('mousemove', function(e) {
                                        window.currentFocusedPanel = panel;
                                    });
                                    
                                    // iframe ç²å¾—ç„¦é»æ™‚æ›´æ–°ç•¶å‰é¢æ¿
                                    iframeWindow.addEventListener('focus', function() {
                                        window.currentFocusedPanel = panel;
                                    });
                                    
                                    // æ¢å¾©æ›¸ç±¤ç‹€æ…‹
                                    bookmarks.forEach(bookmarkKey => {
                                        const [bPanel, bLine] = bookmarkKey.split('-');
                                        if (bPanel === panel) {
                                            const lineEl = lineNumbersContent.querySelector(`.analysis-line-number[data-line="${bLine}"]`);
                                            if (lineEl) {
                                                lineEl.classList.add('bookmarked');
                                            }
                                        }
                                    });
                                    
                                    // æ·»åŠ è¡Œhoveræ•ˆæœ - ä¿®æ­£ç‰ˆæœ¬
                                    const setupLineHover = function() {
                                        // æ³¨å…¥ hover æ¨£å¼
                                        const hoverStyle = iframeDoc.createElement('style');
                                        hoverStyle.textContent = `
                                            /* è®“å®¹å™¨ä¸æ¥æ”¶æ»‘é¼ äº‹ä»¶ */
                                            #reportContent,
                                            .panel-content,
                                            .left-panel {
                                                pointer-events: none !important;
                                            }
                                            
                                            /* åªæœ‰ report-line æ¥æ”¶æ»‘é¼ äº‹ä»¶ */
                                            .report-line {
                                                pointer-events: auto !important;
                                                position: relative;
                                            }
                                            
                                            /* report-line çš„å­å…ƒç´ é è¨­ä¸æ¥æ”¶äº‹ä»¶ */
                                            .report-line * {
                                                pointer-events: none !important;
                                            }
                                            
                                            /* ä½†é€£çµå’ŒæŒ‰éˆ•å¯ä»¥æ¥æ”¶äº‹ä»¶ */
                                            .report-line a,
                                            .report-line button {
                                                pointer-events: auto !important;
                                            }
                                            
                                            /* ç§»é™¤æ‰€æœ‰é è¨­ hover */
                                            *:hover {
                                                background: inherit !important;
                                            }
                                            
                                            /* åªæœ‰ç‰¹å®šé¡åˆ¥æœ‰ hover æ•ˆæœ */
                                            .report-line.report-line-hover {
                                                background-color: rgba(45, 90, 142, 0.3) !important;
                                            }
                                        `;
                                        iframeDoc.head.appendChild(hoverStyle);
                                        
                                        // ç²å–å¯æ»¾å‹•çš„å…ƒç´ 
                                        const getScrollableElement = () => {
                                            return iframeDoc.querySelector('.left-panel') || 
                                                iframeDoc.documentElement || 
                                                iframeDoc.body;
                                        };
                                        
                                        // æ·»åŠ é˜²æŠ–å‹•è™•ç†
                                        let lastTargetLine = null;
                                        let hoverTimeout = null;
                                        
                                        iframeDoc.addEventListener('mousemove', function(e) {
                                            // æ¸…é™¤ä¹‹å‰çš„timeout
                                            if (hoverTimeout) {
                                                clearTimeout(hoverTimeout);
                                            }
                                            
                                            hoverTimeout = setTimeout(() => {
                                                const lineData = window[`${panel}LineData`];
                                                if (!lineData || lineData.length === 0) return;

                                                // ç²å–äº‹ä»¶ç›®æ¨™
                                                const target = e.target;
                                                
                                                // æª¢æŸ¥æ˜¯å¦åœ¨ report-line ä¸Šï¼ˆåŒ…æ‹¬å…¶å­å…ƒç´ ï¼‰
                                                let reportLine = null;
                                                if (target.classList.contains('report-line')) {
                                                    reportLine = target;
                                                } else {
                                                    // å¦‚æœ target ä¸æ˜¯ report-lineï¼Œå˜—è©¦æ‰¾æœ€è¿‘çš„ report-line çˆ¶å…ƒç´ 
                                                    reportLine = target.closest('.report-line');
                                                }
                                                // å¦‚æœæ‰¾åˆ° report-lineï¼Œæ·»åŠ  hover æ•ˆæœ
                                                if (reportLine) {
                                                    // æ·»åŠ  hover é¡
                                                    reportLine.classList.add('report-line-hover');
                                                }
                                                                                                
                                                // ç²å–ç•¶å‰çš„æ»¾å‹•ä½ç½®
                                                const scrollableElement = getScrollableElement();
                                                const currentScrollTop = scrollableElement.scrollTop || 0;
                                                
                                                // è¨ˆç®—æ»‘é¼ ç›¸å°æ–¼è¦–çª—çš„ä½ç½®ï¼ŒåŠ ä¸Šæ»¾å‹•åç§»
                                                const mouseYInDocument = e.clientY + currentScrollTop;
                                                
                                                // æ‰¾å‡ºæ»‘é¼ æ‰€åœ¨çš„è¡Œ
                                                let targetLine = null;
                                                let minDistance = Infinity;

                                                for (let i = 0; i < lineData.length; i++) {
                                                    const data = lineData[i];
                                                    const lineTop = data.top;
                                                    const lineBottom = lineTop + data.height;
                                                    
                                                    // æª¢æŸ¥æ»‘é¼ æ˜¯å¦åœ¨è¡Œçš„ç¯„åœå…§
                                                    if (mouseYInDocument >= lineTop && mouseYInDocument <= lineBottom) {
                                                        targetLine = data.index;
                                                        break;
                                                    }
                                                    
                                                    // è¨ˆç®—åˆ°è¡Œä¸­å¿ƒçš„è·é›¢ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
                                                    const lineCenter = lineTop + data.height / 2;
                                                    const distance = Math.abs(mouseYInDocument - lineCenter);
                                                    
                                                    if (distance < minDistance) {
                                                        minDistance = distance;
                                                        targetLine = data.index;
                                                    }
                                                }
                                                
                                                // èª¿è©¦è¼¸å‡º
                                                //console.log('Scroll:', currentScrollTop, 'MouseY:', e.clientY, 'MouseInDoc:', mouseYInDocument, 'Target:', targetLine);
                                                if (targetLine && targetLine !== window.currentFocusedLine) {
                                                    // æ›´æ–°è¡Œè™Ÿé«˜äº®
                                                    const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                                                    if (lineNumbers) {
                                                        lineNumbers.querySelectorAll('.analysis-line-number').forEach(el => {
                                                            if (!el.classList.contains('bookmarked')) {
                                                                el.style.backgroundColor = '';
                                                            }
                                                        });
                                                        
                                                        const lineElement = lineNumbers.querySelector(`.analysis-line-number[data-line="${targetLine-1}"]`);
                                                        if (lineElement && !lineElement.classList.contains('bookmarked')) {
                                                            lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.3)';
                                                            lineElement.style.color = 'inherit';
                                                        }
                                                    }
                                                    
                                                    // æ¸…é™¤ä¹‹å‰çš„å…§å®¹è¡Œé«˜äº®
                                                    iframeDoc.querySelectorAll('.report-line-hover').forEach(el => {
                                                        el.classList.remove('report-line-hover');
                                                    });
                                                    
                                                    // é«˜äº®å°æ‡‰çš„å…§å®¹è¡Œ
                                                    const targetLineData = lineData[targetLine -1];
                                                    if (targetLineData) {
                                                        // æŸ¥æ‰¾åœ¨ç•¶å‰è¦–çª—ä¸­å¯è¦‹çš„å…ƒç´ 
                                                        const elements = iframeDoc.body.getElementsByTagName('*');
                                                        let bestMatch = null;
                                                        let bestDistance = Infinity;
                                                        
                                                        for (let el of elements) {
                                                            // è·³éä¸å¯è¦‹çš„å…ƒç´ 
                                                            if (el.offsetParent === null) continue;
                                                            
                                                            const rect = el.getBoundingClientRect();
                                                            // å…ƒç´ åœ¨æ–‡æª”ä¸­çš„å¯¦éš›ä½ç½®
                                                            const elTopInDoc = rect.top + currentScrollTop;
                                                            const distance = Math.abs(elTopInDoc - targetLineData.top);
                                                            
                                                            if (distance < bestDistance && distance < 10) {
                                                                bestDistance = distance;
                                                                bestMatch = el;
                                                            }
                                                        }
                                                        
                                                        if (bestMatch) {
                                                            bestMatch.classList.add('report-line-hover');
                                                        }
                                                    }
                                                    
                                                    window.currentFocusedLine = targetLine;
                                                    window.currentFocusedPanel = panel;
                                                    /*console.log('Hover Debug:', {
                                                        mouseYInDocument: mouseYInDocument,
                                                        currentScrollTop: currentScrollTop,
                                                        clientY: e.clientY,
                                                        targetLine: targetLine,
                                                        lineDataLength: lineData.length,
                                                        æœ€å¾Œä¸€è¡Œæ•¸æ“š: lineData[lineData.length - 1]
                                                    });*/                                                    
                                                }
                                            }, 10); // 10ms çš„é˜²æŠ–å‹•å»¶é²
                                        });

                                        // æ»‘é¼ é›¢é–‹æ™‚æ¸…é™¤æ‰€æœ‰ hover
                                        iframeDoc.addEventListener('mouseleave', function() {
                                            if (hoverTimeout) {
                                                clearTimeout(hoverTimeout);
                                            }
                                            lastTargetLine = null;
                                            
                                            const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                                            if (lineNumbers) {
                                                lineNumbers.querySelectorAll('.analysis-line-number').forEach(el => {
                                                    if (!el.classList.contains('bookmarked')) {
                                                        el.style.backgroundColor = '';
                                                    }
                                                });
                                            }
                                            
                                            iframeDoc.querySelectorAll('.report-line-hover').forEach(el => {
                                                el.classList.remove('report-line-hover');
                                            });
                                        });
                                    }; 
                                             
                                    // åœ¨æ‰€æœ‰äº‹ä»¶è¨­ç½®å®Œæˆå¾Œï¼Œè¨­ç½®hoveræ•ˆæœ
                                    setTimeout(() => {
                                        setupLineHover();
                                    }, 100);

                                    updateStatus(`è¼‰å…¥å®Œæˆ - å…± ${window[`${panel}LineCount`]} è¡Œ`);
                                };
                                
                                // ç”Ÿæˆè¡Œè™Ÿ
                                generateAnalysisLineNumbers();
                            }
                        } catch (e) {
                            console.error('è™•ç† iframe æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                        }
                    }, 10);
                };
                
                // åˆå§‹åŒ–ç„¦é»
                window.currentFocusedPanel = panel;
                window.currentFocusedLine = 1;
                
            } else {
                // åŸå§‹æª”æ¡ˆè™•ç† - åˆ†é›¢è¡Œè™Ÿå’Œå…§å®¹
                if (panel === 'left' && currentLeftType === 'original') {
                    originalContent = content;
                } else if (panel === 'right' && currentRightType === 'original') {
                    originalContent = content;
                }
                
                const lines = content.split(/\r?\n/);
                if (lines[lines.length - 1] === '') {
                    lines.pop();
                }
                
                // å»ºç«‹ä¸»åŒ…è£å®¹å™¨
                const wrapper = document.createElement('div');
                wrapper.className = 'original-content-wrapper';
                wrapper.id = `${panel}ContentWrapper`;
                
                // å»ºç«‹è¡Œè™Ÿå®¹å™¨
                const lineNumbersContainer = document.createElement('div');
                lineNumbersContainer.className = 'line-numbers-container';
                lineNumbersContainer.id = `${panel}LineNumbersContainer`;
                
                const lineNumbersContent = document.createElement('div');
                lineNumbersContent.className = 'line-numbers-content';
                lineNumbersContent.id = `${panel}LineNumbers`;
                
                // å»ºç«‹å…§å®¹å®¹å™¨
                const contentContainer = document.createElement('div');
                contentContainer.className = 'content-container';
                contentContainer.id = `${panel}ContentContainer`;
                
                const contentArea = document.createElement('div');
                contentArea.className = 'content-area';
                contentArea.id = `${panel}ContentArea`;
                
                // ç”Ÿæˆè¡Œè™Ÿå’Œå…§å®¹
                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    
                    // å»ºç«‹è¡Œè™Ÿ - ç¢ºä¿è¨­ç½®æ‰€æœ‰å¿…è¦çš„å±¬æ€§
                    const lineNumberEl = document.createElement('span');
                    lineNumberEl.className = 'line-number';
                    lineNumberEl.setAttribute('data-line', lineNum);
                    lineNumberEl.setAttribute('data-panel', panel);
                    lineNumberEl.textContent = lineNum;
                    lineNumbersContent.appendChild(lineNumberEl);
                    
                    // å»ºç«‹å…§å®¹è¡Œ
                    const contentLineEl = document.createElement('div');
                    contentLineEl.className = 'content-line';
                    contentLineEl.setAttribute('data-line', String(lineNum));
                    contentLineEl.setAttribute('data-panel', panel);
                    contentLineEl.innerHTML = escapeHtml(line) || '&nbsp;';
                    contentArea.appendChild(contentLineEl);
                });
                
                // çµ„è£çµæ§‹
                lineNumbersContainer.appendChild(lineNumbersContent);
                contentContainer.appendChild(contentArea);
                wrapper.appendChild(lineNumbersContainer);
                wrapper.appendChild(contentContainer);
                
                contentEl.innerHTML = '';
                contentEl.appendChild(wrapper);
                
                // åŒæ­¥æ²å‹•
                setupScrollSync(panel);
                
                // è¨­ç½®äº‹ä»¶ï¼ˆå»¶é²ä»¥ç¢ºä¿ DOM å·²æ›´æ–°ï¼‰
                setTimeout(() => {
                    // å¹³è¡Œè¨­ç½®æ‰€æœ‰äº‹ä»¶
                    Promise.all([
                        new Promise(resolve => {
                            setupLineNumberHandlers(panel);
                            resolve();
                        }),
                        new Promise(resolve => {
                            setupContentLineTracking(panel);
                            resolve();
                        }),
                        new Promise(resolve => {
                            setupContentContextMenu(panel);
                            resolve();
                        })
                    ]).then(() => {
                        // åˆå§‹åŒ–ç„¦é»
                        window.currentFocusedPanel = panel;
                        window.currentFocusedLine = 1;
                    });
                }, 100);
                
                updateStatus(`è¼‰å…¥å®Œæˆ - å…± ${lines.length} è¡Œ`);
            }
        }   

        function setupScrollSync(panel) {
            const contentContainer = document.getElementById(`${panel}ContentContainer`);
            const lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            if (contentContainer && lineNumbers) {
                contentContainer.addEventListener('scroll', function() {
                    lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
                });
            }
        }

        // è¨­ç½®å…§å®¹è¡Œè¿½è¹¤ï¼ˆå®Œå…¨é‡å¯«ï¼‰
        function setupContentLineTracking(panel) {
            const contentLines = document.querySelectorAll(`#${panel}ContentArea .content-line`);
            
            contentLines.forEach((line, index) => {
                if (!line.getAttribute('data-line')) {
                    line.setAttribute('data-line', index + 1);
                }
                
                const lineNum = parseInt(line.getAttribute('data-line'));
                
                // æ»‘é¼ ç§»å‹•æ™‚æ›´æ–°ç„¦é»
                line.addEventListener('mousemove', function(e) {
                    e.stopPropagation();
                    // åªåœ¨æ»‘é¼ çœŸæ­£ç§»å‹•æ™‚æ›´æ–°ï¼Œé¿å…è¢«å…¶ä»–æ“ä½œå¹²æ“¾
                    if (e.movementX !== 0 || e.movementY !== 0) {
                        window.currentFocusedLine = lineNum;
                        window.currentFocusedPanel = panel;
                        highlightCurrentLineNumber(panel, lineNum);
                    }
                });
                
                line.addEventListener('mouseenter', function(e) {
                    e.stopPropagation();
                    window.currentFocusedLine = lineNum;
                    window.currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, lineNum);
                });
            });
            
            // è¡Œè™Ÿçš„æ»‘é¼ äº‹ä»¶
            const lineNumbers = document.querySelectorAll(`#${panel}LineNumbers .line-number`);
            lineNumbers.forEach((lineNumEl, index) => {
                if (!lineNumEl.getAttribute('data-line')) {
                    lineNumEl.setAttribute('data-line', index + 1);
                }
                if (!lineNumEl.getAttribute('data-panel')) {
                    lineNumEl.setAttribute('data-panel', panel);
                }
                
                const lineNum = parseInt(lineNumEl.getAttribute('data-line'));
                
                lineNumEl.addEventListener('mouseenter', function(e) {
                    e.stopPropagation();
                    window.currentFocusedLine = lineNum;
                    window.currentFocusedPanel = panel;
                    window.currentFocusedLineSource = 'lineNumber';  // æ¨™è¨˜ä¾†æº
                    highlightCurrentLineNumber(panel, lineNum);
                });
            });
        }         

        // è¨­ç½®å…§å®¹å³éµé¸å–®
        function setupContentContextMenu(panel) {
            const contentArea = document.getElementById(`${panel}ContentArea`);
            if (contentArea) {
                contentArea.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    
                    // è¨­ç½®ç•¶å‰é¢æ¿
                    contextMenuManager.currentPanel = panel;
                    highlightManager.currentPanel = panel;
                    window.currentFocusedPanel = panel;
                    
                    // ç²å–é¸æ“‡ - é‡è¦ï¼šåœ¨é¡¯ç¤ºé¸å–®å‰å°±ä¿å­˜é¸æ“‡å…§å®¹
                    const selection = window.getSelection();
                    const selectedText = selection.toString();
                    
                    // ä¿å­˜é¸æ“‡çš„æ–‡å­—å’Œç¯„åœ
                    highlightManager.selectedText = selectedText;
                    contextMenuManager.selectedText = selectedText;  // æ·»åŠ é€™è¡Œ
                    contextMenuManager.currentSelection = selection;
                    
                    if (selection.rangeCount > 0) {
                        highlightManager.selectedRange = selection.getRangeAt(0);
                        contextMenuManager.selectedRange = selection.getRangeAt(0);  // æ·»åŠ é€™è¡Œ
                    }
                    
                    contextMenuManager.show(e.clientX, e.clientY);
                });
            }
        }      

        // ç‚ºè¡¨æ ¼ä½ˆå±€è¨­ç½®å³éµé¸å–®
        function setupContextMenuForTable(panel) {
            // ç¢ºä¿å…ƒç´ å­˜åœ¨
            const wrapper = document.getElementById(`${panel}ContentWrapper`);
            if (!wrapper) {
                console.log(`æ‰¾ä¸åˆ° ${panel}ContentWrapper`);
                return;
            }
            
            const contentCells = wrapper.querySelectorAll('.content-cell');
            contentCells.forEach(cell => {
                if (cell) {
                    contextMenuManager.setupForElement(cell);
                }
            });
        }

        // é«˜äº®ç•¶å‰è¡Œè™Ÿ
        function highlightCurrentLineNumber(panel, lineNumber) {
            
            if (panel === 'left' && currentLeftType === 'analysis') {
                const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                if (lineNumbers && lineNumbers.className === 'analysis-line-numbers') {
                    // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                    lineNumbers.querySelectorAll('.analysis-line-number').forEach(el => {
                        if (!el.classList.contains('bookmarked')) {
                            el.style.backgroundColor = '';
                        }
                    });
                    
                    // é«˜äº®ç•¶å‰è¡Œ
                    const lineElement = lineNumbers.querySelector(`.analysis-line-number[data-line="${lineNumber}"]`);
                    if (lineElement && !lineElement.classList.contains('bookmarked')) {
                        lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
                    }
                    return;
                }
            }
                        
            // å˜—è©¦æ–°çµæ§‹
            let lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            // å¦‚æœæ–°çµæ§‹ä¸å­˜åœ¨ï¼Œå˜—è©¦èˆŠçµæ§‹
            if (!lineNumbers) {
                const wrapper = document.getElementById(`${panel}ContentWrapper`);
                if (wrapper) {
                    // æ¸…é™¤è©²é¢æ¿ä¹‹å‰çš„é«˜äº®
                    wrapper.querySelectorAll('.line-number').forEach(el => {
                        if (!el.classList.contains('bookmarked')) {
                            el.style.backgroundColor = '';
                        }
                    });
                    
                    // é«˜äº®ç•¶å‰è¡Œè™Ÿ
                    const lineElement = wrapper.querySelector(`.line-number[data-line="${lineNumber}"]`);
                    if (lineElement && !lineElement.classList.contains('bookmarked')) {
                        lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
                    }
                }
                return;
            }
            
            // æ–°çµæ§‹çš„è™•ç†
            lineNumbers.querySelectorAll('.line-number').forEach(el => {
                if (!el.classList.contains('bookmarked')) {
                    el.style.backgroundColor = '';
                }
            });
            
            const lineElement = lineNumbers.querySelector(`.line-number[data-line="${lineNumber}"]`);
            if (lineElement && !lineElement.classList.contains('bookmarked')) {
                lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
            }
        }

        // æ¸…é™¤è¡Œè™Ÿé«˜äº®
        function clearLineNumberHighlight(panel) {
            document.querySelectorAll(`#${panel}LineNumbers .line-number`).forEach(el => {
                el.style.backgroundColor = '';
            });
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(panel, message) {
            const contentEl = document.getElementById(panel + 'Content');
            contentEl.innerHTML = `<div class="error-message">âŒ ${escapeHtml(message)}</div>`;
        }
        
        // åˆ‡æ›åŸå§‹æª”æ¡ˆé¢æ¿
        function toggleOriginalPanel() {
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const resizeHandle = document.getElementById('resizeHandle');
            const btn = document.getElementById('toggleOriginalBtn');
            
            if (rightPanel.classList.contains('hidden')) {
                // é¡¯ç¤ºå³å´é¢æ¿
                rightPanel.classList.remove('hidden');
                resizeHandle.classList.remove('hidden');
                
                // è¨­å®šç‚º 50%/50% æ¯”ä¾‹
                leftPanel.style.flex = '0 0 calc(50% - 2.5px)';
                rightPanel.style.flex = '0 0 calc(50% - 2.5px)';
                
                // è¼‰å…¥åŸå§‹æª”æ¡ˆ
                if (!isOriginalLoaded) {
                    loadOriginalContent();
                }
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                btn.innerHTML = '<span>ğŸ“„</span><span>éš±è—åŸå§‹æª”æ¡ˆ</span>';
                document.getElementById('switchPanelsBtn').style.display = 'inline-flex';
            } else {
                // éš±è—å³å´é¢æ¿
                rightPanel.classList.add('hidden');
                resizeHandle.classList.add('hidden');
                
                // å·¦å´é¢æ¿æ¢å¾©å…¨å¯¬
                leftPanel.style.flex = '1';
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                btn.innerHTML = '<span>ğŸ“„</span><span>æŸ¥çœ‹åŸå§‹æª”æ¡ˆ</span>';
                document.getElementById('switchPanelsBtn').style.display = 'none';
            }
        }
        
        // åˆ‡æ›å·¦å³é¢æ¿å…§å®¹
        function switchPanels() {
            // ç¢ºä¿å³å´é¢æ¿å·²ç¶“é–‹å•Ÿ
            const rightPanel = document.getElementById('rightPanel');
            if (rightPanel.classList.contains('hidden')) {
                updateStatus('è«‹å…ˆé–‹å•ŸåŸå§‹æª”æ¡ˆè¦–çª—');
                return;
            }
            
            // ä¿å­˜ç•¶å‰çš„é«˜äº®ç‹€æ…‹
            const leftHighlightsTemp = {};
            const rightHighlightsTemp = {};
            
            // å°‡ Set è½‰æ›ç‚º Array ä»¥ä¾¿åºåˆ—åŒ–
            for (let i = 1; i <= 5; i++) {
                leftHighlightsTemp[i] = Array.from(highlightManager.leftHighlights[i]);
                rightHighlightsTemp[i] = Array.from(highlightManager.rightHighlights[i]);
            }
            
            // ä¿å­˜ç•¶å‰çš„æ›¸ç±¤ç‹€æ…‹
            const leftBookmarksTemp = new Set();
            const rightBookmarksTemp = new Set();
            
            bookmarks.forEach(key => {
                const [panel, line] = key.split('-');
                if (panel === 'left') {
                    rightBookmarksTemp.add(`right-${line}`);
                } else {
                    leftBookmarksTemp.add(`left-${line}`);
                }
            });
            
            // ä¿å­˜æ²å‹•ä½ç½®
            const leftScrollTop = getScrollPosition('left');
            const rightScrollTop = getScrollPosition('right');
            
            // æ¸…ç©ºèˆŠæ›¸ç±¤
            bookmarks.clear();
            
            // äº¤æ›å…§å®¹é¡å‹
            const tempType = currentLeftType;
            currentLeftType = currentRightType;
            currentRightType = tempType;
            
            // é‡æ–°è¼‰å…¥å…§å®¹ï¼ˆé€™æ¨£å¯ä»¥ç¢ºä¿æ‰€æœ‰äº‹ä»¶æ­£ç¢ºç¶å®šï¼‰
            const reloadPromises = [];
            
            if (currentLeftType === 'analysis') {
                reloadPromises.push(new Promise(resolve => {
                    displayContent('left', analysisContent, 'analysis');
                    setTimeout(resolve, 100);
                }));
            } else {
                reloadPromises.push(new Promise(resolve => {
                    displayContent('left', originalContent, 'original');
                    setTimeout(resolve, 100);
                }));
            }
            
            if (currentRightType === 'analysis') {
                reloadPromises.push(new Promise(resolve => {
                    displayContent('right', analysisContent, 'analysis');
                    setTimeout(resolve, 100);
                }));
            } else {
                reloadPromises.push(new Promise(resolve => {
                    displayContent('right', originalContent, 'original');
                    setTimeout(resolve, 100);
                }));
            }
            
            // ç­‰å¾…å…§å®¹è¼‰å…¥å®Œæˆå¾Œæ¢å¾©ç‹€æ…‹
            Promise.all(reloadPromises).then(() => {
                // äº¤æ›ä¸¦æ¢å¾©é«˜äº®ç‹€æ…‹
                highlightManager.leftHighlights = {};
                highlightManager.rightHighlights = {};
                
                for (let i = 1; i <= 5; i++) {
                    highlightManager.leftHighlights[i] = new Set(rightHighlightsTemp[i] || []);
                    highlightManager.rightHighlights[i] = new Set(leftHighlightsTemp[i] || []);
                }
                
                // é‡æ–°æ‡‰ç”¨é«˜äº®
                setTimeout(() => {
                    highlightManager.refreshHighlightsInPanel('left');
                    highlightManager.refreshHighlightsInPanel('right');
                    
                    // æ›´æ–°é«˜äº®æ§åˆ¶æŒ‰éˆ•
                    highlightManager.updateHighlightButtons('left');
                    highlightManager.updateHighlightButtons('right');
                    
                    // æ¢å¾©æ›¸ç±¤
                    leftBookmarksTemp.forEach(key => bookmarks.add(key));
                    rightBookmarksTemp.forEach(key => bookmarks.add(key));
                    
                    // æ›´æ–°æ›¸ç±¤é¡¯ç¤º
                    updateBookmarkDisplay('left');
                    updateBookmarkDisplay('right');
                    
                    // é‡ç½®æ›¸ç±¤ç´¢å¼•
                    leftBookmarkIndex = -1;
                    rightBookmarkIndex = -1;
                    
                    // æ¢å¾©æ²å‹•ä½ç½®
                    restoreScrollPosition('left', rightScrollTop);
                    restoreScrollPosition('right', leftScrollTop);
                    
                    updateStatus('å·²åˆ‡æ›é¢æ¿å…§å®¹');
                }, 200);
            });
            
            // æ›´æ–°æ¨™é¡Œ
            updatePanelTitles();
        }

        // ç²å–é¢æ¿çš„æ²å‹•ä½ç½®
        function getScrollPosition(panel) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'analysis') {
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentWindow) {
                    try {
                        return iframe.contentWindow.pageYOffset || 
                            iframe.contentDocument.documentElement.scrollTop || 
                            iframe.contentDocument.body.scrollTop || 0;
                    } catch (e) {
                        return 0;
                    }
                }
            } else {
                const contentContainer = document.getElementById(`${panel}ContentContainer`);
                return contentContainer ? contentContainer.scrollTop : 0;
            }
            return 0;
        }

        // æ¢å¾©é¢æ¿çš„æ²å‹•ä½ç½®
        function restoreScrollPosition(panel, scrollTop) {
            if (!scrollTop) return;
            
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            setTimeout(() => {
                if (panelType === 'analysis') {
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.scrollTo(0, scrollTop);
                    }
                } else {
                    const contentContainer = document.getElementById(`${panel}ContentContainer`);
                    if (contentContainer) {
                        contentContainer.scrollTop = scrollTop;
                    }
                }
            }, 100);
        }

        // é‡æ–°ç¶å®šé¢æ¿äº‹ä»¶
        function rebindPanelEvents(panel) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'original') {
                // é‡æ–°ç¶å®šåŸå§‹æª”æ¡ˆçš„äº‹ä»¶
                setupScrollSync(panel);
                setupLineNumberHandlers(panel);
                setupContentLineTracking(panel);
                setupContentContextMenu(panel);
            } else {
                // é‡æ–°ç¶å®šåˆ†æå ±å‘Šçš„äº‹ä»¶
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentWindow && iframe.contentDocument) {
                    try {
                        const iframeDoc = iframe.contentDocument;
                        const iframeWindow = iframe.contentWindow;
                        
                        // ä¿®æ­£è¡Œè™Ÿå®¹å™¨çš„æ¨£å¼
                        const lineNumbersContainer = document.getElementById(`${panel}LineNumbersContainer`);
                        if (lineNumbersContainer) {
                            // ç¢ºä¿è¡Œè™Ÿå®¹å™¨æœ‰æ­£ç¢ºçš„æ¨£å¼
                            lineNumbersContainer.className = 'line-numbers-container';
                            lineNumbersContainer.style.width = '60px';
                            lineNumbersContainer.style.minWidth = '60px';
                            lineNumbersContainer.style.background = '#1a1a1a';
                            lineNumbersContainer.style.borderRight = '1px solid #333';
                            lineNumbersContainer.style.overflow = 'hidden';
                            lineNumbersContainer.style.flexShrink = '0';
                            lineNumbersContainer.style.position = 'sticky';
                            lineNumbersContainer.style.left = '0';
                            lineNumbersContainer.style.zIndex = '10';
                        }
                        
                        // é‡æ–°ç¶å®šæ²å‹•åŒæ­¥
                        const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                        if (lineNumbers) {
                            const scrollableElement = iframeDoc.querySelector('.left-panel') || 
                                                iframeDoc.documentElement || 
                                                iframeDoc.body;
                            
                            if (scrollableElement) {
                                const syncScroll = function() {
                                    const scrollTop = scrollableElement.scrollTop || 
                                                iframeWindow.pageYOffset || 
                                                iframeDoc.documentElement.scrollTop || 
                                                iframeDoc.body.scrollTop || 0;
                                    
                                    lineNumbers.style.transform = `translateY(-${scrollTop}px)`;
                                };
                                
                                scrollableElement.addEventListener('scroll', syncScroll);
                                syncScroll();
                            }
                        }
                        
                        // é‡æ–°ç¶å®š iframe å…§çš„äº‹ä»¶
                        setupIframeContextMenu(iframe, panel);
                        
                        // é‡æ–°ç¶å®š iframe å…§çš„éµç›¤äº‹ä»¶
                        iframeDoc.addEventListener('keydown', function(e) {
                            const event = new KeyboardEvent('keydown', {
                                key: e.key,
                                keyCode: e.keyCode,
                                ctrlKey: e.ctrlKey,
                                altKey: e.altKey,
                                shiftKey: e.shiftKey,
                                metaKey: e.metaKey,
                                bubbles: true
                            });
                            
                            window.currentFocusedPanel = panel;
                            document.dispatchEvent(event);
                        });
                        
                        // é‡æ–°ç¶å®šæ»‘é¼ è¿½è¹¤
                        const lineData = window[`${panel}LineData`];
                        if (lineData) {
                            const trackMouse = function(e) {
                                const leftPanel = iframeDoc.querySelector('.left-panel');
                                const scrollTop = leftPanel ? leftPanel.scrollTop : 0;
                                const rect = iframe.getBoundingClientRect();
                                const y = e.clientY - rect.top + scrollTop - 20;
                                
                                let targetLine = null;
                                for (let i = 0; i < lineData.length; i++) {
                                    const data = lineData[i];
                                    if (y >= data.top && y < data.top + data.height) {
                                        targetLine = data.index;
                                        break;
                                    }
                                }
                                
                                if (targetLine) {
                                    window.currentFocusedLine = targetLine;
                                    window.currentFocusedPanel = panel;
                                    highlightCurrentLineNumber(panel, targetLine);
                                }
                            };
                            
                            iframeDoc.addEventListener('mousemove', trackMouse);
                        }
                        
                        // ç¢ºä¿ iframe å¯ä»¥ç²å¾—ç„¦é»
                        iframeDoc.body.setAttribute('tabindex', '0');
                        
                        // iframe ç²å¾—ç„¦é»æ™‚æ›´æ–°ç•¶å‰é¢æ¿
                        iframeWindow.addEventListener('focus', function() {
                            window.currentFocusedPanel = panel;
                        });
                        
                    } catch (e) {
                        console.log('é‡æ–°ç¶å®š iframe äº‹ä»¶å¤±æ•—:', e);
                    }
                }
            }
        }

        // æ›´æ–°é¢æ¿å…§çš„å…ƒç´  ID
        function updatePanelIds(panel) {
            const wrapper = document.querySelector(`#${panel}Content .original-content-wrapper`);
            if (!wrapper) return;
            
            // æ›´æ–° wrapper ID
            wrapper.id = `${panel}ContentWrapper`;
            
            // æ›´æ–°è¡Œè™Ÿå®¹å™¨
            const lineNumbersContainer = wrapper.querySelector('.line-numbers-container');
            if (lineNumbersContainer) {
                lineNumbersContainer.id = `${panel}LineNumbersContainer`;
                
                // ä¿æŒæ¨£å¼
                lineNumbersContainer.className = 'line-numbers-container';
                lineNumbersContainer.style.cssText = `
                    width: 60px;
                    min-width: 60px;
                    background: #1a1a1a;
                    border-right: 1px solid #333;
                    overflow: hidden;
                    flex-shrink: 0;
                    position: sticky;
                    left: 0;
                    z-index: 10;
                `;
                
                const lineNumbersContent = lineNumbersContainer.querySelector('.line-numbers-content, .analysis-line-numbers');
                if (lineNumbersContent) {
                    lineNumbersContent.id = `${panel}LineNumbers`;
                    
                    // ä¿æŒåˆ†æå ±å‘Šçš„æ¨£å¼
                    if (lineNumbersContent.className === 'analysis-line-numbers') {
                        lineNumbersContent.style.cssText = `
                            position: relative;
                            width: 100%;
                            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                            font-size: 13px;
                            line-height: 1.6em;
                            color: #666;
                            user-select: none;
                        `;
                    }
                    
                    // æ›´æ–°æ‰€æœ‰è¡Œè™Ÿçš„å±¬æ€§
                    const lineNumbers = lineNumbersContent.querySelectorAll('.line-number, .analysis-line-number');
                    lineNumbers.forEach(lineNum => {
                        lineNum.setAttribute('data-panel', panel);
                        
                        // ä¿æŒåˆ†æå ±å‘Šè¡Œè™Ÿçš„æ¨£å¼
                        if (lineNum.className === 'analysis-line-number') {
                            // æ¨£å¼å·²ç¶“é€šé CSS å®šç¾©ï¼Œä¸éœ€è¦å…§è¯æ¨£å¼
                        }
                    });
                }
            }
            
            // æ›´æ–°å…§å®¹å®¹å™¨
            const contentContainer = wrapper.querySelector('.content-container');
            if (contentContainer) {
                contentContainer.id = `${panel}ContentContainer`;
                
                const contentArea = contentContainer.querySelector('.content-area');
                if (contentArea) {
                    contentArea.id = `${panel}ContentArea`;
                    
                    // æ›´æ–°æ‰€æœ‰å…§å®¹è¡Œçš„ data-panel å±¬æ€§
                    const contentLines = contentArea.querySelectorAll('.content-line');
                    contentLines.forEach(line => {
                        line.setAttribute('data-panel', panel);
                    });
                }
            }
        }

        // æ›´æ–°æ›¸ç±¤é¡¯ç¤º
        function updateBookmarkDisplay(panel) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'analysis') {
                // åˆ†æå ±å‘Š - å¤šæ¬¡å˜—è©¦ï¼Œç¢ºä¿è¡Œè™Ÿå·²ç”Ÿæˆ
                let attempts = 0;
                const maxAttempts = 10;
                
                const tryUpdateBookmarks = () => {
                    const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                    if (lineNumbers && lineNumbers.querySelectorAll('.analysis-line-number').length > 0) {
                        // æ¢å¾©æ›¸ç±¤é¡¯ç¤º
                        bookmarks.forEach(bookmarkKey => {
                            const [bPanel, bLine] = bookmarkKey.split('-');
                            if (bPanel === panel) {
                                const lineEl = lineNumbers.querySelector(`.analysis-line-number[data-line="${bLine}"]`);
                                if (lineEl) {
                                    lineEl.classList.add('bookmarked');
                                }
                            }
                        });
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(tryUpdateBookmarks, 200);
                    }
                };
                
                tryUpdateBookmarks();
            } else {
                // åŸå§‹æª”æ¡ˆ
                setTimeout(() => {
                    bookmarks.forEach(bookmarkKey => {
                        const [bPanel, bLine] = bookmarkKey.split('-');
                        if (bPanel === panel) {
                            const lineEl = document.querySelector(`#${panel}LineNumbers .line-number[data-line="${bLine}"]`);
                            if (lineEl) {
                                lineEl.classList.add('bookmarked');
                            }
                        }
                    });
                }, 100);
            }
        }

        // æ›´æ–°é¢æ¿æ¨™é¡Œ
        function updatePanelTitles() {
            const leftIcon = document.getElementById('leftPanelIcon');
            const leftTitle = document.getElementById('leftPanelTitle');
            const rightIcon = document.getElementById('rightPanelIcon');
            const rightTitle = document.getElementById('rightPanelTitle');
            
            if (currentLeftType === 'analysis') {
                leftIcon.textContent = 'ğŸ“Š';
                leftTitle.textContent = 'åˆ†æå ±å‘Š';
            } else {
                leftIcon.textContent = 'ğŸ“„';
                leftTitle.textContent = 'åŸå§‹æª”æ¡ˆ';
            }
            
            if (currentRightType === 'analysis') {
                rightIcon.textContent = 'ğŸ“Š';
                rightTitle.textContent = 'åˆ†æå ±å‘Š';
            } else {
                rightIcon.textContent = 'ğŸ“„';
                rightTitle.textContent = 'åŸå§‹æª”æ¡ˆ';
            }
        }
        
        // åˆ‡æ›å…¨å±ï¼ˆæŒ‡å®šé¢æ¿ï¼‰
        function toggleFullscreen(panel) {
            const panelEl = document.getElementById(panel + 'Panel');
            
            if (panelEl.classList.contains('fullscreen')) {
                panelEl.classList.remove('fullscreen');
            } else {
                // å…ˆé—œé–‰å…¶ä»–å…¨å±
                document.querySelectorAll('.fullscreen').forEach(el => {
                    el.classList.remove('fullscreen');
                });
                panelEl.classList.add('fullscreen');
            }
        }
        
        // åˆ‡æ›å…¨å±æ¨¡å¼ï¼ˆæ•´å€‹æ‡‰ç”¨ï¼‰
        function toggleFullscreenMode() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // é—œé–‰é¢æ¿
        function closePanel(panel) {
            console.log('closePanel è¢«èª¿ç”¨, panel:', panel);
            
            const panelEl = document.getElementById(panel + 'Panel');
            console.log('æ‰¾åˆ°çš„é¢æ¿å…ƒç´ :', panelEl);
            console.log('æ˜¯å¦å…¨å±:', panelEl?.classList.contains('fullscreen'));
            
            if (!panelEl) {
                console.error('æ‰¾ä¸åˆ°é¢æ¿å…ƒç´ :', panel + 'Panel');
                return;
            }
            
            // å¦‚æœé¢æ¿åœ¨å…¨å±æ¨¡å¼ï¼Œå…ˆé€€å‡ºå…¨å±
            if (panelEl.classList.contains('fullscreen')) {
                console.log('é€€å‡ºå…¨å±æ¨¡å¼');
                panelEl.classList.remove('fullscreen');
            }
            
            // ç„¶å¾Œé—œé–‰é¢æ¿
            if (panel === 'right') {
                console.log('é—œé–‰å³å´é¢æ¿');
                toggleOriginalPanel();
            }
        }
        
        // åˆ‡æ›åŒ¯å‡ºé¸å–®
        function toggleExportMenu(panel) {
            const menu = document.getElementById(panel + 'ExportMenu');
            const otherMenu = document.getElementById(panel === 'left' ? 'rightExportMenu' : 'leftExportMenu');
            
            // é—œé–‰å¦ä¸€å€‹é¸å–®
            if (otherMenu) {
                otherMenu.classList.remove('show');
            }
            
            // åˆ‡æ›ç•¶å‰é¸å–®
            menu.classList.toggle('show');
        }
        
        // é—œé–‰æ‰€æœ‰åŒ¯å‡ºé¸å–®
        function closeAllExportMenus() {
            document.querySelectorAll('.export-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        // åŒ¯å‡ºå…§å®¹
        async function exportContent(panel, format) {
            closeAllExportMenus();
            
            // ç¢ºä¿å…§å®¹å·²è¼‰å…¥
            if (panel === 'left' && !analysisContent) {
                updateStatus('è«‹ç­‰å¾…åˆ†æå ±å‘Šè¼‰å…¥å®Œæˆå¾Œå†åŒ¯å‡º');
                return;
            }
            
            if (panel === 'right' && !originalContent) {
                updateStatus('è«‹ç­‰å¾…åŸå§‹æª”æ¡ˆè¼‰å…¥å®Œæˆå¾Œå†åŒ¯å‡º');
                return;
            }
            
            // æ ¹æ“šç•¶å‰é¢æ¿é¡¯ç¤ºçš„å…§å®¹é¡å‹ä¾†æ±ºå®šåŒ¯å‡ºä»€éº¼
            let content = '';
            let contentType = '';
            
            if (panel === 'left') {
                content = (currentLeftType === 'analysis') ? analysisContent : originalContent;
                contentType = currentLeftType;
            } else {
                content = (currentRightType === 'analysis') ? analysisContent : originalContent;
                contentType = currentRightType;
            }
            
            // ç¢ºä¿æœ‰å…§å®¹å¯åŒ¯å‡º
            if (!content) {
                updateStatus('æ²’æœ‰å…§å®¹å¯ä¾›åŒ¯å‡º');
                return;
            }
            
            const filename = filePath.split('/').pop().replace(/\.[^/.]+$/, '');
            
            updateStatus(`æ­£åœ¨åŒ¯å‡ºç‚º ${format.toUpperCase()} æ ¼å¼...`);
            
            try {
                const response = await fetch('/api/export-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        format: format,
                        filename: filename,
                        contentType: contentType
                    })
                });
                
                if (response.ok) {
                    // ä¸‹è¼‰æª”æ¡ˆ
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // å¾ Content-Disposition header ç²å–æª”å
                    const contentDisposition = response.headers.get('content-disposition');
                    let downloadFilename = `${filename}_${format}.${format}`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?(.+?)"?$/);
                        if (filenameMatch) {
                            downloadFilename = filenameMatch[1];
                        }
                    }
                    
                    a.download = downloadFilename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    updateStatus('åŒ¯å‡ºæˆåŠŸ');
                } else {
                    const error = await response.json();
                    updateStatus('åŒ¯å‡ºå¤±æ•—: ' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                updateStatus('åŒ¯å‡ºå¤±æ•—: ' + error.message);
            }
        }
        
        // è¨­ç½®èª¿æ•´å¤§å°è™•ç†
        function setupResizeHandler() {
            const resizeHandle = document.getElementById('resizeHandle');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const mainContainer = document.getElementById('mainContainer');
            
            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            
            // å‰µå»ºä¸€å€‹è¦†è“‹å±¤ä¾†é˜²æ­¢ iframe å¹²æ“¾
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.zIndex = '9999';
            overlay.style.cursor = 'col-resize';
            overlay.style.display = 'none';
            overlay.style.userSelect = 'none';
            document.body.appendChild(overlay);
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startLeftWidth = leftPanel.offsetWidth;
                
                // é¡¯ç¤ºè¦†è“‹å±¤
                overlay.style.display = 'block';
                
                // é˜²æ­¢æ–‡å­—é¸æ“‡
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.mozUserSelect = 'none';
                document.body.style.msUserSelect = 'none';
                
                // ç¦ç”¨ iframe çš„æŒ‡æ¨™äº‹ä»¶
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.style.pointerEvents = 'none';
                });
                
                e.preventDefault();
                e.stopPropagation();
            });
            
            // åœ¨ overlay å’Œ document ä¸Šç›£è½äº‹ä»¶
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const deltaX = e.clientX - startX;
                const newLeftWidth = startLeftWidth + deltaX;
                const containerWidth = mainContainer.offsetWidth - 5; // æ¸›å» resize handle çš„å¯¬åº¦
                const minWidth = 200;
                const maxWidth = containerWidth - minWidth;
                
                if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                    const leftPercent = (newLeftWidth / containerWidth) * 100;
                    const rightPercent = 100 - leftPercent;
                    
                    leftPanel.style.flex = `0 0 calc(${leftPercent}% - 2.5px)`;
                    rightPanel.style.flex = `0 0 calc(${rightPercent}% - 2.5px)`;
                }
            }
            
            function handleMouseUp(e) {
                if (!isResizing) return;
                
                isResizing = false;
                
                // éš±è—è¦†è“‹å±¤
                overlay.style.display = 'none';
                
                // æ¢å¾©æ¨£å¼
                document.body.style.cursor = 'default';
                document.body.style.userSelect = '';
                document.body.style.webkitUserSelect = '';
                document.body.style.mozUserSelect = '';
                document.body.style.msUserSelect = '';
                
                // æ¢å¾© iframe çš„æŒ‡æ¨™äº‹ä»¶
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.style.pointerEvents = 'auto';
                });
                
                e.preventDefault();
                e.stopPropagation();
            }
            
            // åŒæ™‚åœ¨ document å’Œ overlay ä¸Šç›£è½
            document.addEventListener('mousemove', handleMouseMove);
            overlay.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            overlay.addEventListener('mouseup', handleMouseUp);
            
            // è™•ç†æ»‘é¼ é›¢é–‹è¦–çª—çš„æƒ…æ³
            document.addEventListener('mouseleave', function(e) {
                if (isResizing) {
                    handleMouseUp(e);
                }
            });
            
            // è®“æ‹–æ›³æ¢æ›´å®¹æ˜“é»æ“Š
            resizeHandle.style.position = 'relative';
            resizeHandle.innerHTML = '<div style="position: absolute; left: -5px; right: -5px; top: 0; bottom: 0; cursor: col-resize;"></div>';
        }
        
        // è¨­ç½® iframe çš„å³éµé¸å–®
        function setupIframeContextMenu(iframe, panel) {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc) {
                    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const oldHandler = iframeDoc.__contextMenuHandler;
                    if (oldHandler) {
                        iframeDoc.removeEventListener('contextmenu', oldHandler);
                    }
                    
                    // å‰µå»ºæ–°çš„äº‹ä»¶è™•ç†å™¨
                    const contextMenuHandler = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // è¨­ç½®ç•¶å‰é¢æ¿
                        highlightManager.currentPanel = panel;
                        window.currentFocusedPanel = panel;
                        contextMenuManager.currentPanel = panel;
                        
                        const selection = iframe.contentWindow.getSelection();
                        highlightManager.selectedText = selection.toString();
                        
                        // è¨˜éŒ„ iframe å’Œå…¶é¸æ“‡
                        contextMenuManager.currentIframe = iframe;
                        contextMenuManager.currentSelection = selection;
                        
                        if (selection.rangeCount > 0) {
                            highlightManager.selectedRange = selection.getRangeAt(0);
                        }
                        
                        // è¨ˆç®—åœ¨ä¸»è¦–çª—ä¸­çš„å¯¦éš›ä½ç½®
                        const iframeRect = iframe.getBoundingClientRect();
                        const x = e.clientX + iframeRect.left;
                        const y = e.clientY + iframeRect.top;
                        
                        contextMenuManager.show(x, y);
                    };
                    
                    // ä¿å­˜è™•ç†å™¨åƒè€ƒ
                    iframeDoc.__contextMenuHandler = contextMenuHandler;
                    
                    // ç¶å®šäº‹ä»¶
                    iframeDoc.addEventListener('contextmenu', contextMenuHandler);
                    
                    // è¨­ç½®é¸æ“‡è®Šæ›´äº‹ä»¶
                    iframeDoc.addEventListener('selectionchange', function() {
                        const selection = iframe.contentWindow.getSelection();
                        if (selection.toString()) {
                            highlightManager.selectedText = selection.toString();
                            highlightManager.currentIframe = iframe;
                        }
                    });
                }
            } catch (e) {
                console.log('ç„¡æ³•å­˜å– iframe å…§å®¹:', e);
            }
        }

        // è¨­ç½® iframe å…§éƒ¨äº‹ä»¶
        function setupIframeEvents(iframe, iframeDoc) {
            // è¨­ç½®å³éµé¸å–®
            iframeDoc.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                const selection = iframe.contentWindow.getSelection();
                highlightManager.selectedText = selection.toString();
                
                if (selection.rangeCount > 0) {
                    highlightManager.selectedRange = selection.getRangeAt(0);
                }
                
                // è¨ˆç®—åœ¨ä¸»è¦–çª—ä¸­çš„å¯¦éš›ä½ç½®
                const iframeRect = iframe.getBoundingClientRect();
                const x = e.clientX + iframeRect.left;
                const y = e.clientY + iframeRect.top;
                
                contextMenuManager.show(x, y);
            });
            
            // è™•ç† iframe å…§çš„é¸æ“‡äº‹ä»¶
            iframeDoc.addEventListener('mouseup', function() {
                const selection = iframe.contentWindow.getSelection();
                if (selection.toString()) {
                    highlightManager.selectedText = selection.toString();
                    highlightManager.currentIframe = iframe;
                }
            });
        }

        // è¨­ç½®éµç›¤å¿«æ·éµ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                
                const panel = window.currentFocusedPanel || 'left';
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                                    
                // ESC é€€å‡ºå…¨å±
                if (e.key === 'Escape') {
                    document.querySelectorAll('.fullscreen').forEach(el => {
                        el.classList.remove('fullscreen');
                    });
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                }
                
                // Ctrl+A - å…¨é¸
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    // å‰µå»ºä¸€å€‹æ–°çš„ context menu manager å¯¦ä¾‹æ–¹æ³•èª¿ç”¨
                    contextMenuManager.currentPanel = panel;
                    contextMenuManager.selectAll();
                }

                // F2 - åœ¨ç•¶å‰è¡ŒåŠ æ›¸ç±¤
                if (e.key === 'F2') {
                    e.preventDefault();

                    let line = window.currentFocusedLine || 1;
                    
                    console.log('F2 Debug:', {
                        panel: panel,
                        line: line,
                        source: window.currentFocusedLineSource,
                        panelType: panelType
                    });

                    // æª¢æŸ¥æ»‘é¼ æ˜¯å¦åœ¨è¡Œè™Ÿå…ƒç´ ä¸Š
                    const hoveredElement = document.elementFromPoint(
                        window.lastMouseX || 0, 
                        window.lastMouseY || 0
                    );
                    
                    const isOnLineNumber = hoveredElement && (
                        hoveredElement.classList.contains('analysis-line-number') ||
                        hoveredElement.classList.contains('line-number') ||
                        hoveredElement.closest('.line-numbers-container') ||
                        hoveredElement.closest('.bookmarked')
                    );
                    
                    console.log('F2 Debug - Hover æª¢æŸ¥:', {
                        hoveredElement: hoveredElement,
                        isOnLineNumber: isOnLineNumber,
                        classes: hoveredElement?.className
                    });
                    
                    // åªæœ‰å·¦å´çš„åˆ†æå ±å‘Šä¸”ç„¦é»ä¾†è‡ªå…§å®¹å€æ™‚éœ€è¦ -1
                    if (panel === 'left' && 
                        panelType === 'analysis' && 
                        window.currentFocusedLineSource === 'content') {
                        line = window.currentFocusedLine - 1;
                        // é˜²å‘†ï¼šç¢ºä¿è¡Œè™Ÿè‡³å°‘ç‚º 1
                        line = Math.max(1, line);
                    }
                        
                    console.log('F2 Debug - èª¿æ•´å¾Œ:', {
                        line: line,
                        è¨ˆç®—: `${window.currentFocusedLine} - 1 = ${line}`
                    });

                    // æª¢æŸ¥é¢æ¿æ˜¯å¦å¯è¦‹
                    const panelEl = document.getElementById(`${panel}Panel`);
                    if (!panelEl || panelEl.classList.contains('hidden')) {
                        console.log('F2: é¢æ¿éš±è—ä¸­');
                        return;
                    }
                    
                    console.log(`F2 æŒ‰ä¸‹: Panel=${panel}, Line=${line}`);
                    
                    if (panelType === 'analysis') {
                        // åˆ†æå ±å‘Š - ä½¿ç”¨ç‰¹æ®Šçš„è¡Œè™Ÿé¸æ“‡å™¨
                        const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                        if (lineNumbers && lineNumbers.className === 'analysis-line-numbers') {
                            const lineElement = lineNumbers.querySelector(`.analysis-line-number[data-line="${line}"]`);
                            // å¦‚æœæ‰¾ä¸åˆ°ï¼ˆä¾‹å¦‚ line æ˜¯ 0 æˆ–ç„¡æ•ˆå€¼ï¼‰ï¼Œé»˜èªä½¿ç”¨ç¬¬ä¸€è¡Œ
                            if (!lineElement) {
                                console.log(`F2: æ‰¾ä¸åˆ°è¡Œè™Ÿ ${line}ï¼Œä½¿ç”¨ç¬¬ä¸€è¡Œ`);
                                lineElement = lineNumbers.querySelector(`.analysis-line-number[data-line="1"]`);
                                line = 1;  // æ›´æ–°è¡Œè™Ÿç‚º 1
                            }
                            if (lineElement) {
                                if (!lineElement.getAttribute('data-panel')) {
                                    lineElement.setAttribute('data-panel', panel);
                                }
                                toggleBookmark(lineElement);
                                updateStatus(`å·²åœ¨${panel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿ç¬¬ ${line} è¡Œåˆ‡æ›æ›¸ç±¤`);
                            } else {
                                console.error('F2: æ‰¾ä¸åˆ°åˆ†æå ±å‘Šè¡Œè™Ÿå…ƒç´ ', { panel, line });
                            }
                        }
                    } else {
                        // åŸå§‹æª”æ¡ˆ - ä½¿ç”¨åŸæœ‰é‚è¼¯
                        let lineElement = document.querySelector(`#${panel}LineNumbers .line-number[data-line="${line}"]`);
                        
                        if (lineElement) {
                            if (!lineElement.getAttribute('data-panel')) {
                                lineElement.setAttribute('data-panel', panel);
                            }
                            toggleBookmark(lineElement);
                            updateStatus(`å·²åœ¨${panel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿ç¬¬ ${line} è¡Œåˆ‡æ›æ›¸ç±¤`);
                        } else {
                            console.error('F2: æ‰¾ä¸åˆ°è¡Œè™Ÿå…ƒç´ ', { panel, line });
                        }
                    }
                }

                // F3 - è·³è½‰åˆ°ä¸‹ä¸€å€‹æ›¸ç±¤
                if (e.key === 'F3') {
                    e.preventDefault();
                    navigateBookmarks();
                }
                
                // å…¶ä»–å¿«æ·éµ...
                if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    toggleOriginalPanel();
                }
                
                if (e.ctrlKey && e.key === 'w') {
                    e.preventDefault();
                    switchPanels();
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreenMode();
                }
            });
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // æ›´æ–°è¼‰å…¥æ™‚é–“
        function updateLoadTime() {
            const loadTime = Date.now() - startTime;
            document.getElementById('loadTime').textContent = `è¼‰å…¥æ™‚é–“: ${loadTime}ms`;
        }
        
        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // ç¢ºä¿ Unicode å­—ç¬¦æ­£ç¢ºé¡¯ç¤º
            return div.innerHTML.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
                return '&#' + i.charCodeAt(0) + ';';
            });
        }
    </script>
    <script>
        // è¨­ç½®è¡Œè™Ÿè™•ç†å™¨
        function setupLineNumberHandlers(panel) {
            const lineNumbersContainer = document.getElementById(`${panel}LineNumbersContainer`);
            
            if (!lineNumbersContainer) {
                console.log(`æ‰¾ä¸åˆ° ${panel}LineNumbersContainer`);
                return;
            }
            
            // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†å‹•æ…‹ç”Ÿæˆçš„è¡Œè™Ÿ
            lineNumbersContainer.addEventListener('click', function(e) {
                const lineNum = e.target.closest('.line-number');
                if (lineNum) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleBookmark(lineNum);
                }
            });
            
            lineNumbersContainer.addEventListener('mouseenter', function(e) {
                const lineNum = e.target.closest('.line-number');
                if (lineNum) {
                    const line = parseInt(lineNum.getAttribute('data-line'));
                    window.currentFocusedLine = line;
                    window.currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, line);
                }
            }, true);
        }

        // ç¢ºä¿è¡Œè™Ÿèˆ‡å…§å®¹åŒæ­¥æ²å‹•
        function syncLineNumbers(panel) {
            const wrapper = document.getElementById(`${panel}ContentWrapper`);
            const lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            if (wrapper && lineNumbers) {
                // åˆå§‹å°é½Š
                const content = document.getElementById(`${panel}OriginalContent`);
                const computedStyle = window.getComputedStyle(content);
                const paddingTop = parseInt(computedStyle.paddingTop);
                
                lineNumbers.style.paddingTop = paddingTop + 'px';
                
                // ç›£è½æ²å‹•äº‹ä»¶
                wrapper.addEventListener('scroll', function() {
                    lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
                });
            }
        }

        // åˆ‡æ›æ›¸ç±¤
        function toggleBookmark(lineElement) {
            if (!lineElement) {
                console.error('toggleBookmark: lineElement is null');
                return;
            }
            
            const lineNumber = parseInt(lineElement.getAttribute('data-line'));
            const panel = lineElement.getAttribute('data-panel') || window.currentFocusedPanel;
            
            if (!lineNumber || !panel) {
                console.error('toggleBookmark: ç¼ºå°‘å¿…è¦å±¬æ€§', { lineNumber, panel });
                return;
            }
            
            const key = `${panel}-${lineNumber}`;
            
            if (bookmarks.has(key)) {
                bookmarks.delete(key);
                lineElement.classList.remove('bookmarked');
                updateStatus(`å·²ç§»é™¤æ›¸ç±¤: ${panel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿ç¬¬ ${lineNumber} è¡Œ`);
            } else {
                bookmarks.add(key);
                lineElement.classList.add('bookmarked');
                updateStatus(`å·²æ–°å¢æ›¸ç±¤: ${panel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿ç¬¬ ${lineNumber} è¡Œ`);
            }
            
            // é‡ç½®å°æ‡‰é¢æ¿çš„ç´¢å¼•
            if (panel === 'left') {
                leftBookmarkIndex = -1;
            } else {
                rightBookmarkIndex = -1;
            }
        }

        // æ›´æ–°æ›¸ç±¤é™£åˆ—
        function updateBookmarkArray() {
            bookmarkArray = Array.from(bookmarks).sort((a, b) => {
                const [panelA, lineA] = a.split('-');
                const [panelB, lineB] = b.split('-');
                if (panelA === panelB) {
                    return parseInt(lineA) - parseInt(lineB);
                }
                return panelA.localeCompare(panelB);
            });
        }

        // é«˜äº®ç•¶å‰è¡Œ
        function highlightCurrentLine(panel, lineIndex) {
            // é€™å€‹åŠŸèƒ½å¯ä»¥é¸æ“‡æ€§å¯¦ç¾
        }

        // é«˜äº®é¸ä¸­çš„æ–‡å­—ï¼ˆåªåœ¨ç•¶å‰é¢æ¿ï¼‰
        function highlightSelection(colorIndex) {
            if (!this.selectedText) return;
            
            // ç¢ºå®šç•¶å‰é¢æ¿
            const panel = this.currentPanel || window.currentFocusedPanel || 'left';
            
            // æ¸…é™¤è©²é¢æ¿ä¹‹å‰åŒé¡è‰²çš„é«˜äº®
            if (this.panelHighlights[panel][colorIndex]) {
                this.clearHighlightColorInPanel(panel, colorIndex);
            }
            
            this.panelHighlights[panel][colorIndex] = this.selectedText;
            
            // åªåœ¨ç•¶å‰é¢æ¿é«˜äº®
            this.highlightInPanel(panel, this.selectedText, colorIndex);
            
            // é¡¯ç¤ºé«˜äº®æ§åˆ¶æŒ‰éˆ•ï¼ˆå¦‚æœåœ¨å³å´é¢æ¿ï¼‰
            if (panel === 'right') {
                document.getElementById(`highlightBtn${colorIndex}`).style.display = 'block';
            }
            
            hideContextMenu();
            window.getSelection().removeAllRanges();
        }

        function hideContextMenu() {
            if (contextMenuManager && contextMenuManager.menu) {
                contextMenuManager.hide();
            }
        }

        // åœ¨ç‰¹å®šé¢æ¿ä¸­é«˜äº®
        function highlightInPanel(panel, text, colorIndex) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'original') {
                // è™•ç†åŸå§‹æª”æ¡ˆ
                const contentArea = document.getElementById(`${panel}ContentArea`);
                if (contentArea) {
                    const contentLines = contentArea.querySelectorAll('.content-line');
                    contentLines.forEach(line => {
                        this.highlightInNode(line, text, colorIndex);
                    });
                }
            } else if (panelType === 'analysis') {
                // è™•ç†åˆ†æå ±å‘Šï¼ˆiframeï¼‰- ä¿æŒåŸæ¨£
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentDocument) {
                    try {
                        this.injectHighlightStyles(iframe);
                        const iframeBody = iframe.contentDocument.body;
                        if (iframeBody) {
                            this.highlightInElement(iframeBody, text, colorIndex);
                        }
                    } catch (e) {
                        console.log('ç„¡æ³•å­˜å– iframe å…§å®¹:', e);
                    }
                }
            }
        }

        // æ¸…é™¤ç‰¹å®šé¢æ¿ç‰¹å®šé¡è‰²çš„é«˜äº®
        function clearHighlightColorInPanel(panel, colorIndex) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'original') {
                // æ¸…é™¤åŸå§‹æª”æ¡ˆçš„é«˜äº®
                document.querySelectorAll(`#${panel}ContentWrapper .highlight-${colorIndex}`).forEach(element => {
                    const parent = element.parentNode;
                    const textNode = document.createTextNode(element.textContent);
                    parent.replaceChild(textNode, element);
                    parent.normalize();
                });
            } else if (panelType === 'analysis') {
                // æ¸…é™¤ iframe ä¸­çš„é«˜äº®
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentDocument) {
                    iframe.contentDocument.querySelectorAll(`.highlight-${colorIndex}`).forEach(element => {
                        const parent = element.parentNode;
                        const textNode = iframe.contentDocument.createTextNode(element.textContent);
                        parent.replaceChild(textNode, element);
                        parent.normalize();
                    });
                }
            }
            
            this.panelHighlights[panel][colorIndex] = null;
            
            // å¦‚æœæ˜¯å³å´é¢æ¿ï¼Œæ›´æ–°æŒ‰éˆ•é¡¯ç¤º
            if (panel === 'right') {
                // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–é«˜äº®
                let hasHighlight = false;
                for (let i = 1; i <= 5; i++) {
                    if (this.panelHighlights[panel][i]) {
                        hasHighlight = true;
                        break;
                    }
                }
                if (!hasHighlight || !this.panelHighlights[panel][colorIndex]) {
                    document.getElementById(`highlightBtn${colorIndex}`).style.display = 'none';
                }
            }
        }   

        // é«˜äº®æ‰€æœ‰å‡ºç¾çš„æ–‡å­—
        function highlightAllOccurrences(text, colorIndex) {
            // è™•ç†å·¦å³é¢æ¿
            ['left', 'right'].forEach(panel => {
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                if (panelType === 'original') {
                    // è™•ç†åŸå§‹æª”æ¡ˆï¼ˆè¡¨æ ¼ä½ˆå±€ï¼‰
                    const wrapper = document.getElementById(`${panel}ContentWrapper`);
                    if (wrapper) {
                        const contentCells = wrapper.querySelectorAll('.content-cell');
                        contentCells.forEach(cell => {
                            this.highlightInNode(cell, text, colorIndex);
                        });
                    }
                } else if (panelType === 'analysis') {
                    // è™•ç†åˆ†æå ±å‘Šï¼ˆiframeï¼‰
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentDocument) {
                        try {
                            // æ³¨å…¥é«˜äº®æ¨£å¼åˆ° iframe
                            this.injectHighlightStyles(iframe);
                            
                            // é«˜äº® iframe å…§å®¹
                            const iframeBody = iframe.contentDocument.body;
                            if (iframeBody) {
                                this.highlightInElement(iframeBody, text, colorIndex);
                            }
                        } catch (e) {
                            console.log('ç„¡æ³•å­˜å– iframe å…§å®¹:', e);
                        }
                    }
                }
            });
        }

        // æ³¨å…¥é«˜äº®æ¨£å¼åˆ° iframe
        function injectHighlightStyles(iframe) {
            try {
                const iframeDoc = iframe.contentDocument;
                if (!iframeDoc.getElementById('highlight-styles')) {
                    const style = iframeDoc.createElement('style');
                    style.id = 'highlight-styles';
                    style.textContent = `
                        /* åŸºæœ¬æ¨£å¼ */
                        body {
                            line-height: 1.6em;
                            margin: 0;
                            padding: 20px;
                            font-size: 13px;
                            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                            overflow-y: auto;
                            overflow-x: auto;
                        }
                        
                        /* çµ±ä¸€æ²è»¸æ¨£å¼ - èˆ‡å³å´ç›¸åŒ */
                        ::-webkit-scrollbar {
                            height: 8px;
                            width: 8px;
                        }
                        
                        ::-webkit-scrollbar-track {
                            background: #1a1a1a;
                        }
                        
                        ::-webkit-scrollbar-thumb {
                            background: #444;
                            border-radius: 4px;
                        }
                        
                        ::-webkit-scrollbar-thumb:hover {
                            background: #555;
                        }
                        
                        /* Firefox æ²è»¸ */
                        * {
                            scrollbar-width: thin;
                            scrollbar-color: #444 #1a1a1a;
                        }
                        
                        /* å…¶ä»–æ¨£å¼ */
                        pre, .report-line {
                            line-height: 1.6em;
                            font-size: 13px;
                            margin: 0;
                        }
                        
                        /* é«˜äº®æ¨£å¼ */
                        .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; }
                        .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; }
                        .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; }
                        .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; }
                        .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; }
                    `;
                    iframeDoc.head.appendChild(style);
                }
            } catch (e) {
                console.log('ç„¡æ³•æ³¨å…¥æ¨£å¼:', e);
            }
        }

        // åœ¨å…ƒç´ ä¸­é«˜äº®æ–‡å­—
        function highlightInElement(element, text, colorIndex) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        // è·³éå·²ç¶“é«˜äº®çš„ç¯€é»
                        if (node.parentElement && node.parentElement.className && 
                            node.parentElement.className.includes('highlight-')) {
                            return NodeFilter.FILTER_REJECT;
                        }
                        return NodeFilter.FILTER_ACCEPT;
                    }
                },
                false
            );
            
            const textNodes = [];
            let node;
            
            while (node = walker.nextNode()) {
                if (node.nodeValue && node.nodeValue.includes(text)) {
                    textNodes.push(node);
                }
            }
            
            textNodes.forEach(textNode => {
                const parent = textNode.parentNode;
                const content = textNode.nodeValue;
                
                // å‰µå»ºæ­£å‰‡è¡¨é”å¼ï¼Œæ”¯æ´å¤§å°å¯«
                const regex = new RegExp(this.escapeRegExp(text), 'gi');
                const matches = content.match(regex);
                
                if (matches && matches.length > 0) {
                    const parts = content.split(regex);
                    const fragment = document.createDocumentFragment();
                    
                    parts.forEach((part, i) => {
                        if (part) {
                            fragment.appendChild(document.createTextNode(part));
                        }
                        if (i < parts.length - 1 && i < matches.length) {
                            const span = document.createElement('span');
                            span.className = `highlight-${colorIndex}`;
                            span.textContent = matches[i];
                            fragment.appendChild(span);
                        }
                    });
                    
                    parent.replaceChild(fragment, textNode);
                }
            });
        }

        // æ¸…é™¤ç‰¹å®šé¡è‰²çš„é«˜äº®ï¼ˆåªæ¸…é™¤å³å´é¢æ¿ï¼‰
        function clearHighlightColor(colorIndex, panel) {
            panel = panel || window.currentFocusedPanel || 'right';
            highlightManager.clearHighlightColorInPanel(panel, colorIndex);
        }

        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        function clearAllHighlights() {
            const panel = highlightManager.currentPanel || window.currentFocusedPanel || 'left';
            for (let i = 1; i <= 5; i++) {
                highlightManager.clearHighlightColorInPanel(panel, i);
            }
            hideContextMenu();
        }

        // è¼”åŠ©å‡½æ•¸ï¼šè½‰ç¾©æ­£å‰‡è¡¨é”å¼
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // åœ¨æ›¸ç±¤é–“å°èˆª
        function navigateBookmarks() {

            // å–å¾—ç•¶å‰ç„¦é»é¢æ¿
            const currentPanel = window.currentFocusedPanel || 'left';
            
            if (bookmarks.size === 0) {
                updateStatus('æ²’æœ‰æ›¸ç±¤');
                return;
            }
            
            // æ›´æ–°æ›¸ç±¤é™£åˆ—ï¼Œä½†åªåŒ…å«ç•¶å‰é¢æ¿çš„æ›¸ç±¤
            const panelBookmarks = Array.from(bookmarks).filter(key => key.startsWith(currentPanel + '-'));
            
            if (panelBookmarks.length === 0) {
                updateStatus(`${currentPanel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿æ²’æœ‰æ›¸ç±¤`);
                return;
            }
            
            // æ’åºæ›¸ç±¤ï¼ˆæŒ‰è¡Œè™Ÿï¼‰
            panelBookmarks.sort((a, b) => {
                const lineA = parseInt(a.split('-')[1]);
                const lineB = parseInt(b.split('-')[1]);
                return lineA - lineB;
            });
            
            // ç²å–ä¸¦æ›´æ–°ç•¶å‰é¢æ¿çš„ç´¢å¼•
            let currentIndex = currentPanel === 'left' ? leftBookmarkIndex : rightBookmarkIndex;
            currentIndex++;
            if (currentIndex >= panelBookmarks.length) {
                currentIndex = 0;
            }
            
            // æ›´æ–°å°æ‡‰é¢æ¿çš„ç´¢å¼•
            if (currentPanel === 'left') {
                leftBookmarkIndex = currentIndex;
            } else {
                rightBookmarkIndex = currentIndex;
            }
            
            const bookmarkKey = panelBookmarks[currentIndex];
            const [panel, line] = bookmarkKey.split('-');
            
            console.log(`F3 å°èˆªåˆ°æ›¸ç±¤: ${bookmarkKey}, ç´¢å¼•: ${currentIndex + 1}/${panelBookmarks.length}`);
            
            // æª¢æŸ¥é¢æ¿é¡å‹
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            // æ ¹æ“šé¢æ¿é¡å‹ä½¿ç”¨ä¸åŒçš„é¸æ“‡å™¨
            let lineElement = null;
            if (panelType === 'analysis') {
                // åˆ†æå ±å‘Šä½¿ç”¨ .analysis-line-number
                lineElement = document.querySelector(`#${panel}LineNumbers .analysis-line-number[data-line="${line}"]`);
            } else {
                // åŸå§‹æª”æ¡ˆä½¿ç”¨ .line-number
                lineElement = document.querySelector(`#${panel}LineNumbers .line-number[data-line="${line}"]`);
            }
            
            if (!lineElement) {
                console.error('F3: æ‰¾ä¸åˆ°è¡Œè™Ÿå…ƒç´ ', { 
                    panel, 
                    line, 
                    panelType,
                    selector: panelType === 'analysis' ? '.analysis-line-number' : '.line-number'
                });
                return;
            }
            
            // æ²å‹•åˆ°æ›¸ç±¤ä½ç½®
            if (panelType === 'original') {
                // åŸå§‹æª”æ¡ˆ - æŸ¥æ‰¾å…§å®¹è¡Œä¸¦æ²å‹•
                const targetElement = document.querySelector(`#${panel}ContentArea .content-line[data-line="${line}"]`);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            } else {
                // åˆ†æå ±å‘Š - ä½¿ç”¨å‹•æ…‹è¡Œé«˜æ•¸æ“šæ²å‹•
                const lineData = window[`${panel}LineData`];
                if (lineData) {
                    const targetLine = lineData.find(data => data.index === parseInt(line));
                    if (targetLine) {
                        const iframe = document.querySelector(`#${panel}Content iframe`);
                        if (iframe && iframe.contentWindow) {
                            try {
                                const iframeDoc = iframe.contentDocument;
                                const scrollableElement = iframeDoc.querySelector('.left-panel') ||
                                                        iframeDoc.documentElement ||
                                                        iframeDoc.body;
                                
                                if (scrollableElement) {
                                    // ç›´æ¥è¨­ç½®æ²å‹•ä½ç½®
                                    scrollableElement.scrollTop = targetLine.top - 100;
                                } else {
                                    // å‚™ç”¨æ–¹æ¡ˆ
                                    iframe.contentWindow.scrollTo({
                                        top: targetLine.top - 100,
                                        behavior: 'smooth'
                                    });
                                }
                            } catch (e) {
                                console.log('æ²å‹•å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ:', e);
                                // å‚™ç”¨æ–¹æ¡ˆ
                                iframe.contentWindow.scrollTo({
                                    top: targetLine.top - 100,
                                    behavior: 'smooth'
                                });
                            }
                        }
                    }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å›ºå®šè¡Œé«˜
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentWindow) {
                        const lineHeight = 20.8;
                        const scrollTop = (parseInt(line) - 1) * lineHeight;
                        iframe.contentWindow.scrollTo({
                            top: scrollTop,
                            behavior: 'smooth'
                        });
                    }
                }
            }
            
            // é–ƒçˆæ•ˆæœ - ä½¿ç”¨ CSS å‹•ç•«
            if (lineElement) {
                // æ¸…é™¤ä¹‹å‰æ‰€æœ‰çš„å‹•ç•«é¡
                document.querySelectorAll('.bookmark-flash').forEach(el => {
                    el.classList.remove('bookmark-flash');
                });
                
                // å¼·åˆ¶ç€è¦½å™¨é‡æ–°è¨ˆç®—æ¨£å¼ï¼ˆé‡è¦ï¼ï¼‰
                void lineElement.offsetWidth;
                
                // æ·»åŠ å‹•ç•«é¡
                lineElement.classList.add('bookmark-flash');
                
                // å‹•ç•«çµæŸå¾Œè‡ªå‹•ç§»é™¤é¡
                lineElement.addEventListener('animationend', function handleAnimationEnd() {
                    this.classList.remove('bookmark-flash');
                    // ç§»é™¤äº‹ä»¶ç›£è½å™¨ï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼
                    this.removeEventListener('animationend', handleAnimationEnd);
                });
            }
            
            updateStatus(`${panel === 'left' ? 'å·¦å´' : 'å³å´'}é¢æ¿æ›¸ç±¤ ${currentIndex + 1}/${panelBookmarks.length}: ç¬¬ ${line} è¡Œ`);
        }

        // ç›£è½é¢æ¿çš„ç„¦é»åˆ‡æ›
        document.getElementById('leftPanel').addEventListener('mouseenter', function() {
            window.currentFocusedPanel = 'left';
        });

        document.getElementById('rightPanel').addEventListener('mouseenter', function() {
            window.currentFocusedPanel = 'right';
        });

        // é»æ“Šé¢æ¿æ™‚ä¹Ÿæ›´æ–°ç„¦é»
        document.getElementById('leftPanel').addEventListener('click', function() {
            window.currentFocusedPanel = 'left';
        });

        document.getElementById('rightPanel').addEventListener('click', function() {
            window.currentFocusedPanel = 'right';
        });
    </script>
    <script>
        // é«˜äº®ç®¡ç†å™¨é¡åˆ¥
        class HighlightManager {
            constructor() {
                // æ¯å€‹é¢æ¿çš„æ¯å€‹é¡è‰²å¯ä»¥å„²å­˜å¤šå€‹æ–‡å­—
                this.leftHighlights = { 
                    1: new Set(), 2: new Set(), 3: new Set(), 4: new Set(), 5: new Set() 
                };
                this.rightHighlights = { 
                    1: new Set(), 2: new Set(), 3: new Set(), 4: new Set(), 5: new Set() 
                };
                this.selectedText = '';
                this.selectedRange = null;
                this.currentPanel = null;
            }

            // ç²å–é¢æ¿çš„é«˜äº®è³‡æ–™
            getPanelHighlights(panel) {
                return panel === 'left' ? this.leftHighlights : this.rightHighlights;
            }

            // é«˜äº®é¸ä¸­çš„æ–‡å­—ï¼ˆæ”¯æ´ç–ŠåŠ ï¼‰
            highlightSelection(colorIndex) {
                if (!this.selectedText) return;
                
                // ç¢ºå®šç•¶å‰é¢æ¿
                const panel = this.currentPanel || window.currentFocusedPanel || 'left';
                const highlights = this.getPanelHighlights(panel);
                
                // æ·»åŠ æ–‡å­—åˆ°è©²é¡è‰²çš„é›†åˆä¸­ï¼ˆä¸æ¸…é™¤ä¹‹å‰çš„ï¼‰
                highlights[colorIndex].add(this.selectedText);
                
                // é«˜äº®æ‰€æœ‰è©²é¡è‰²çš„æ–‡å­—
                this.refreshHighlightsInPanel(panel);
                
                // æ›´æ–°é«˜äº®æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º
                this.updateHighlightButtons(panel);
                
                hideContextMenu();
                window.getSelection().removeAllRanges();
            }

            // åˆ·æ–°é¢æ¿ä¸­çš„æ‰€æœ‰é«˜äº®
            refreshHighlightsInPanel(panel) {
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                // å…ˆæ¸…é™¤æ‰€æœ‰é«˜äº®
                this.clearAllHighlightsInPanel(panel);
                
                // é‡æ–°æ‡‰ç”¨æ‰€æœ‰é«˜äº®
                const highlights = this.getPanelHighlights(panel);
                for (let colorIndex = 1; colorIndex <= 5; colorIndex++) {
                    highlights[colorIndex].forEach(text => {
                        this.applyHighlight(panel, text, colorIndex, panelType);
                    });
                }
            }

            // æ‡‰ç”¨é«˜äº®
            applyHighlight(panel, text, colorIndex, panelType) {
                if (panelType === 'original') {
                    // è™•ç†åŸå§‹æª”æ¡ˆ
                    const contentArea = document.getElementById(`${panel}ContentArea`);
                    if (contentArea) {
                        const contentLines = contentArea.querySelectorAll('.content-line');
                        contentLines.forEach(line => {
                            this.highlightInNode(line, text, colorIndex);
                        });
                    }
                } else if (panelType === 'analysis') {
                    // è™•ç†åˆ†æå ±å‘Šï¼ˆiframeï¼‰
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentDocument) {
                        try {
                            this.injectHighlightStyles(iframe);
                            const iframeBody = iframe.contentDocument.body;
                            if (iframeBody) {
                                this.highlightInElement(iframeBody, text, colorIndex);
                            }
                        } catch (e) {
                            console.log('ç„¡æ³•å­˜å– iframe å…§å®¹:', e);
                        }
                    }
                }
            }

            // æ¸…é™¤é¢æ¿ä¸­çš„æ‰€æœ‰é«˜äº®ï¼ˆDOMï¼‰
            clearAllHighlightsInPanel(panel) {
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                if (panelType === 'original') {
                    // æ¸…é™¤åŸå§‹æª”æ¡ˆçš„é«˜äº®
                    for (let i = 1; i <= 5; i++) {
                        const highlights = document.querySelectorAll(`#${panel}ContentArea .highlight-${i}`);
                        highlights.forEach(element => {
                            const parent = element.parentNode;
                            const textNode = document.createTextNode(element.textContent);
                            parent.replaceChild(textNode, element);
                            parent.normalize();
                        });
                    }
                } else if (panelType === 'analysis') {
                    // æ¸…é™¤ iframe ä¸­çš„é«˜äº®
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentDocument) {
                        for (let i = 1; i <= 5; i++) {
                            const highlights = iframe.contentDocument.querySelectorAll(`.highlight-${i}`);
                            highlights.forEach(element => {
                                const parent = element.parentNode;
                                const textNode = iframe.contentDocument.createTextNode(element.textContent);
                                parent.replaceChild(textNode, element);
                                parent.normalize();
                            });
                        }
                    }
                }
            }

            // åœ¨ç¯€é»ä¸­é«˜äº®æ–‡å­—
            highlightInNode(node, text, colorIndex) {
                if (!node || !text || !node.textContent.includes(text)) return;
                
                // ç²å–æ‰€æœ‰æ–‡å­—ç¯€é»
                const walker = document.createTreeWalker(
                    node,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let textNode;
                while (textNode = walker.nextNode()) {
                    if (textNode.nodeValue.includes(text)) {
                        textNodes.push(textNode);
                    }
                }
                
                // è™•ç†æ¯å€‹æ–‡å­—ç¯€é»
                textNodes.forEach(textNode => {
                    const parent = textNode.parentNode;
                    if (parent.className && parent.className.includes('highlight-')) {
                        return; // è·³éå·²ç¶“é«˜äº®çš„
                    }
                    
                    const content = textNode.nodeValue;
                    const regex = new RegExp(this.escapeRegExp(text), 'gi');
                    const matches = content.match(regex);
                    
                    if (matches && matches.length > 0) {
                        const parts = content.split(regex);
                        const fragment = document.createDocumentFragment();
                        
                        parts.forEach((part, i) => {
                            if (part) {
                                fragment.appendChild(document.createTextNode(part));
                            }
                            if (i < parts.length - 1 && i < matches.length) {
                                const span = document.createElement('span');
                                span.className = `highlight-${colorIndex}`;
                                span.textContent = matches[i];
                                fragment.appendChild(span);
                            }
                        });
                        
                        parent.replaceChild(fragment, textNode);
                    }
                });
            }

            // åœ¨å…ƒç´ ä¸­é«˜äº®æ–‡å­—ï¼ˆæ”¯æ´ iframeï¼‰
            highlightInElement(element, text, colorIndex) {
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function(node) {
                            // è·³éå·²ç¶“é«˜äº®çš„ç¯€é»
                            if (node.parentElement && node.parentElement.className && 
                                node.parentElement.className.includes('highlight-')) {
                                return NodeFilter.FILTER_REJECT;
                            }
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    },
                    false
                );
                
                const textNodes = [];
                let node;
                
                while (node = walker.nextNode()) {
                    if (node.nodeValue && node.nodeValue.includes(text)) {
                        textNodes.push(node);
                    }
                }
                
                textNodes.forEach(textNode => {
                    const parent = textNode.parentNode;
                    const content = textNode.nodeValue;
                    
                    const regex = new RegExp(this.escapeRegExp(text), 'gi');
                    const matches = content.match(regex);
                    
                    if (matches && matches.length > 0) {
                        const parts = content.split(regex);
                        const fragment = document.createDocumentFragment();
                        
                        parts.forEach((part, i) => {
                            if (part) {
                                fragment.appendChild(document.createTextNode(part));
                            }
                            if (i < parts.length - 1 && i < matches.length) {
                                const span = document.createElement('span');
                                span.className = `highlight-${colorIndex}`;
                                span.textContent = matches[i];
                                fragment.appendChild(span);
                            }
                        });
                        
                        parent.replaceChild(fragment, textNode);
                    }
                });
            }

            // æ³¨å…¥é«˜äº®æ¨£å¼åˆ° iframe
            injectHighlightStyles(iframe) {
                try {
                    const iframeDoc = iframe.contentDocument;
                    if (!iframeDoc.getElementById('highlight-styles')) {
                        const style = iframeDoc.createElement('style');
                        style.id = 'highlight-styles';
                        style.textContent = `
                            .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; }
                            .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; }
                            .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; }
                            .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; }
                            .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; }
                        `;
                        iframeDoc.head.appendChild(style);
                    }
                } catch (e) {
                    console.log('ç„¡æ³•æ³¨å…¥æ¨£å¼:', e);
                }
            }

            // æ¸…é™¤ç‰¹å®šé¢æ¿ç‰¹å®šé¡è‰²çš„é«˜äº®
            clearHighlightColorInPanel(panel, colorIndex) {
                const highlights = this.getPanelHighlights(panel);
                
                // æ¸…é™¤è©²é¡è‰²çš„æ‰€æœ‰æ–‡å­—
                highlights[colorIndex].clear();
                
                // åˆ·æ–°é¢æ¿é«˜äº®
                this.refreshHighlightsInPanel(panel);
                
                // æ›´æ–°é«˜äº®æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º
                this.updateHighlightButtons(panel);
            }

            // æ¸…é™¤ç‰¹å®šé¡è‰²çš„é«˜äº®
            clearHighlightColor(colorIndex) {
                const panel = window.currentFocusedPanel || 'right';
                this.clearHighlightColorInPanel(panel, colorIndex);
            }

            // æ›´æ–°é«˜äº®æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º
            updateHighlightButtons(panel) {
                const highlights = this.getPanelHighlights(panel);
                
                // å…©å€‹é¢æ¿éƒ½æœ‰é«˜äº®æ§åˆ¶æŒ‰éˆ•
                const buttonPrefix = panel === 'left' ? 'leftHighlightBtn' : 'highlightBtn';
                
                for (let i = 1; i <= 5; i++) {
                    const btn = document.getElementById(`${buttonPrefix}${i}`);
                    
                    if (btn) {
                        // å¦‚æœè©²é¡è‰²æœ‰ä»»ä½•é«˜äº®æ–‡å­—ï¼Œé¡¯ç¤ºæŒ‰éˆ•
                        btn.style.display = highlights[i].size > 0 ? 'block' : 'none';
                    }
                }
            }

            // è¼”åŠ©å‡½æ•¸
            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        }
        
        // å»ºç«‹å…¨åŸŸé«˜äº®ç®¡ç†å™¨å¯¦ä¾‹
        const highlightManager = new HighlightManager();      
    </script>
    <script>
        // å³éµé¸å–®ç®¡ç†å™¨
        class ContextMenuManager {
            constructor() {
                this.menu = null;
                this.currentPanel = null;
                this.currentIframe = null;
                this.currentSelection = null;
                this.selectedText = '';      // æ·»åŠ 
                this.selectedRange = null;    // æ·»åŠ 
                this.setupMenu();
            }

            setupMenu() {
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨é¸å–®
                this.menu = document.getElementById('contextMenu');
                if (!this.menu) {
                    this.createMenu();
                }
            }

            createMenu() {
                const menu = document.createElement('div');
                menu.id = 'contextMenu';
                menu.className = 'context-menu';
                menu.innerHTML = `
                    <div class="context-menu-item" onclick="contextMenuManager.copyText()">
                        <span>ğŸ“‹</span> è¤‡è£½
                    </div>
                    <div class="context-menu-item" onclick="contextMenuManager.selectAll()">
                        <span>ğŸ”²</span> å…¨é¸
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(1)">
                        <div class="color-box" style="background: #ffff00;"></div>
                        <span>é«˜äº® 1 (é»ƒè‰²)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(2)">
                        <div class="color-box" style="background: #00ff00;"></div>
                        <span>é«˜äº® 2 (ç¶ è‰²)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(3)">
                        <div class="color-box" style="background: #00bfff;"></div>
                        <span>é«˜äº® 3 (è—è‰²)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(4)">
                        <div class="color-box" style="background: #ffa500;"></div>
                        <span>é«˜äº® 4 (æ©™è‰²)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(5)">
                        <div class="color-box" style="background: #ffc0cb;"></div>
                        <span>é«˜äº® 5 (ç²‰ç´…)</span>
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="clearAllHighlights()">
                        <span>æ¸…é™¤æ‰€æœ‰é«˜äº®</span>
                    </div>
                `;
                document.body.appendChild(menu);
                this.menu = menu;
            }

            show(x, y) {
                // å…ˆé¡¯ç¤ºé¸å–®ä»¥ç²å–å°ºå¯¸
                this.menu.style.display = 'block';
                this.menu.style.visibility = 'hidden'; // æš«æ™‚éš±è—é¿å…é–ƒçˆ
                
                // ç²å–é¸å–®å’Œè¦–çª—å°ºå¯¸
                const menuRect = this.menu.getBoundingClientRect();
                const menuWidth = menuRect.width;
                const menuHeight = menuRect.height;
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // è¨ˆç®—èª¿æ•´å¾Œçš„ä½ç½®
                let adjustedX = x;
                let adjustedY = y;
                
                // æª¢æŸ¥å³é‚Šç•Œ
                if (x + menuWidth > windowWidth - 10) { // ç•™ 10px é‚Šè·
                    adjustedX = x - menuWidth; // é¡¯ç¤ºåœ¨æ»‘é¼ å·¦å´
                    if (adjustedX < 10) { // å¦‚æœå·¦å´ä¹Ÿä¸å¤ ç©ºé–“
                        adjustedX = windowWidth - menuWidth - 10; // è²¼è‘—å³é‚Šç•Œ
                    }
                }
                
                // æª¢æŸ¥ä¸‹é‚Šç•Œ
                if (y + menuHeight > windowHeight - 10) { // ç•™ 10px é‚Šè·
                    adjustedY = y - menuHeight; // é¡¯ç¤ºåœ¨æ»‘é¼ ä¸Šæ–¹
                    if (adjustedY < 10) { // å¦‚æœä¸Šæ–¹ä¹Ÿä¸å¤ ç©ºé–“
                        adjustedY = windowHeight - menuHeight - 10; // è²¼è‘—ä¸‹é‚Šç•Œ
                    }
                }
                
                // æª¢æŸ¥å·¦é‚Šç•Œ
                if (adjustedX < 10) {
                    adjustedX = 10;
                }
                
                // æª¢æŸ¥ä¸Šé‚Šç•Œ
                if (adjustedY < 10) {
                    adjustedY = 10;
                }
                
                // è¨­å®šæœ€çµ‚ä½ç½®
                this.menu.style.left = adjustedX + 'px';
                this.menu.style.top = adjustedY + 'px';
                this.menu.style.visibility = 'visible'; // é¡¯ç¤ºé¸å–®
                
                // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
                setTimeout(() => {
                    document.addEventListener('click', () => this.hide(), { once: true });
                }, 0);
            }

            hide() {
                this.menu.style.display = 'none';
            }

            copyText() {
                let textToCopy = '';
                
                // å„ªå…ˆä½¿ç”¨ä¿å­˜çš„é¸ä¸­æ–‡å­—
                if (this.selectedText && this.selectedText.trim()) {
                    textToCopy = this.selectedText;
                } else {
                    // å˜—è©¦ç²å–ç•¶å‰é¸æ“‡
                    let selection = null;
                    
                    if (this.currentPanel) {
                        const panelType = (this.currentPanel === 'left') ? currentLeftType : currentRightType;
                        
                        if (panelType === 'analysis' && this.currentIframe) {
                            selection = this.currentIframe.contentWindow.getSelection();
                        } else {
                            selection = window.getSelection();
                        }
                        
                        if (selection && selection.toString().trim()) {
                            textToCopy = selection.toString();
                        }
                    }
                }
                
                // åªæœ‰åœ¨æœ‰é¸ä¸­æ–‡å­—æ™‚æ‰è¤‡è£½
                if (textToCopy) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            updateStatus('å·²è¤‡è£½é¸ä¸­çš„æ–‡å­—');
                        }).catch(() => {
                            this.fallbackCopy(textToCopy);
                        });
                    } else {
                        this.fallbackCopy(textToCopy);
                    }
                } else {
                    updateStatus('è«‹å…ˆé¸å–è¦è¤‡è£½çš„æ–‡å­—');
                }
                
                // æ¸…ç†
                this.selectedText = '';
                this.currentIframe = null;
                this.currentSelection = null;
                this.selectedRange = null;
                this.hide();
            }

            extractReportText(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // å˜—è©¦æ‰¾åˆ°å ±å‘Šå…§å®¹å€åŸŸ
                const reportContent = tempDiv.querySelector('.report-content') || 
                                    tempDiv.querySelector('.analysis-content') ||
                                    tempDiv.querySelector('pre');
                
                if (reportContent) {
                    return reportContent.textContent || reportContent.innerText || '';
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°ç‰¹å®šå€åŸŸï¼Œæå– body å…§å®¹
                const body = tempDiv.querySelector('body');
                if (body) {
                    return body.textContent || body.innerText || '';
                }
                
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            // å¾ HTML æå–ç´”æ–‡å­—çš„è¼”åŠ©æ–¹æ³•
            extractTextFromHTML(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            // å‚™ç”¨è¤‡è£½æ–¹æ³•
            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    updateStatus('å·²è¤‡è£½');
                }
            }

            selectAll() {
                const panel = this.currentPanel || window.currentFocusedPanel || 'left';
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                if (panelType === 'analysis') {
                    // åˆ†æå ±å‘Š - é¸å– iframe å…§çš„å…§å®¹
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentWindow && iframe.contentDocument) {
                        try {
                            const iframeWindow = iframe.contentWindow;
                            const iframeDoc = iframe.contentDocument;
                            
                            // åœ¨ iframe å…§å»ºç«‹é¸å–ç¯„åœ
                            const selection = iframeWindow.getSelection();
                            selection.removeAllRanges();
                            
                            // æ‰¾åˆ°ä¸»è¦å…§å®¹å€åŸŸ
                            const contentElement = iframeDoc.querySelector('.report-content') || 
                                                iframeDoc.querySelector('.left-panel') ||
                                                iframeDoc.querySelector('.analysis-content') ||
                                                iframeDoc.querySelector('pre') ||
                                                iframeDoc.body;
                            
                            if (contentElement) {
                                const range = iframeDoc.createRange();
                                range.selectNodeContents(contentElement);
                                selection.addRange(range);
                                
                                // è®“ iframe ç²å¾—ç„¦é»
                                iframe.contentWindow.focus();
                                
                                updateStatus('å·²é¸å–æ‰€æœ‰å…§å®¹');
                            }
                        } catch (e) {
                            console.error('ç„¡æ³•åœ¨ iframe å…§é¸å–å…§å®¹:', e);
                            updateStatus('é¸å–å¤±æ•—');
                        }
                    }
                } else {
                    // åŸå§‹æª”æ¡ˆ - é¸å–å…§å®¹å€åŸŸ
                    const contentArea = document.getElementById(`${panel}ContentArea`);
                    if (contentArea) {
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        const range = document.createRange();
                        range.selectNodeContents(contentArea);
                        selection.addRange(range);
                        
                        updateStatus('å·²é¸å–æ‰€æœ‰å…§å®¹');
                    }
                }
                
                this.hide();
            }

            setupForElement(element, isIframe = false) {
                element.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    
                    // ç¢ºå®šç•¶å‰æ˜¯å“ªå€‹é¢æ¿
                    let panel = 'left';
                    if (element.closest('#rightContent') || element.closest('#rightPanel')) {
                        panel = 'right';
                    } else if (element.closest('#leftContent') || element.closest('#leftPanel')) {
                        panel = 'left';
                    }
                    
                    highlightManager.currentPanel = panel;
                    window.currentFocusedPanel = panel;
                    
                    const selection = isIframe ? 
                        element.contentWindow.getSelection() : 
                        window.getSelection();
                    
                    highlightManager.selectedText = selection.toString();
                    
                    if (selection.rangeCount > 0) {
                        highlightManager.selectedRange = selection.getRangeAt(0);
                    }
                    
                    // è¨ˆç®—å¯¦éš›çš„åº§æ¨™ä½ç½®
                    let clientX = e.clientX;
                    let clientY = e.clientY;
                    
                    // å¦‚æœæ˜¯ iframeï¼Œéœ€è¦åŠ ä¸Š iframe çš„åç§»é‡
                    if (isIframe) {
                        const iframeRect = element.getBoundingClientRect();
                        clientX = e.clientX + iframeRect.left;
                        clientY = e.clientY + iframeRect.top;
                    }
                    
                    this.show(clientX, clientY);
                });
            }
        }

        // å»ºç«‹å…¨åŸŸå³éµé¸å–®ç®¡ç†å™¨å¯¦ä¾‹
        const contextMenuManager = new ContextMenuManager();
    </script>
    <script>
        // è¤‡è£½é¢æ¿å…§å®¹
        function copyPanelContent(panel) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            // å…ˆåŸ·è¡Œå…¨é¸
            if (panelType === 'analysis') {
                // åˆ†æå ±å‘Š - é¸å– iframe å…§çš„å…§å®¹
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentWindow && iframe.contentDocument) {
                    try {
                        const iframeWindow = iframe.contentWindow;
                        const iframeDoc = iframe.contentDocument;
                        
                        // åœ¨ iframe å…§å»ºç«‹é¸å–ç¯„åœ
                        const selection = iframeWindow.getSelection();
                        selection.removeAllRanges();
                        
                        // æ‰¾åˆ°ä¸»è¦å…§å®¹å€åŸŸ
                        const contentElement = iframeDoc.querySelector('.report-content') || 
                                            iframeDoc.querySelector('.left-panel') ||
                                            iframeDoc.querySelector('.analysis-content') ||
                                            iframeDoc.querySelector('pre') ||
                                            iframeDoc.body;
                        
                        if (contentElement) {
                            const range = iframeDoc.createRange();
                            range.selectNodeContents(contentElement);
                            selection.addRange(range);
                            
                            // è®“ iframe ç²å¾—ç„¦é»
                            iframe.contentWindow.focus();
                            
                            // å»¶é²ä¸€ä¸‹ç¢ºä¿é¸å–å®Œæˆï¼Œç„¶å¾ŒåŸ·è¡Œè¤‡è£½
                            setTimeout(() => {
                                // ä½¿ç”¨ iframe å…§çš„ document åŸ·è¡Œè¤‡è£½
                                try {
                                    const success = iframeDoc.execCommand('copy');
                                    if (success) {
                                        showPanelCopySuccess(panel);
                                        // æ¸…é™¤é¸å–
                                        selection.removeAllRanges();
                                    } else {
                                        // å¦‚æœ execCommand å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•
                                        const textContent = contentElement.innerText || contentElement.textContent || '';
                                        fallbackPanelCopy(textContent, panel);
                                    }
                                } catch (e) {
                                    // å‚™ç”¨æ–¹æ³•ï¼šæ‰‹å‹•ç²å–æ–‡å­—
                                    const textContent = contentElement.innerText || contentElement.textContent || '';
                                    fallbackPanelCopy(textContent, panel);
                                }
                            }, 50);
                        }
                    } catch (e) {
                        console.error('ç„¡æ³•å­˜å– iframe å…§å®¹:', e);
                        updateStatus('è¤‡è£½å¤±æ•—');
                    }
                }
            } else {
                // åŸå§‹æª”æ¡ˆ - é¸å–å…§å®¹å€åŸŸä¸¦è¤‡è£½
                const contentArea = document.getElementById(`${panel}ContentArea`);
                if (contentArea) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    
                    const range = document.createRange();
                    range.selectNodeContents(contentArea);
                    selection.addRange(range);
                    
                    // å»¶é²åŸ·è¡Œè¤‡è£½
                    setTimeout(() => {
                        try {
                            const success = document.execCommand('copy');
                            if (success) {
                                showPanelCopySuccess(panel);
                                // æ¸…é™¤é¸å–
                                selection.removeAllRanges();
                            } else {
                                const textContent = contentArea.innerText || contentArea.textContent || '';
                                fallbackPanelCopy(textContent, panel);
                            }
                        } catch (e) {
                            const textContent = contentArea.innerText || contentArea.textContent || '';
                            fallbackPanelCopy(textContent, panel);
                        }
                    }, 50);
                }
            }
        }

        // é¡¯ç¤ºé¢æ¿è¤‡è£½æˆåŠŸçš„å‹•ç•«
        function showPanelCopySuccess(panel) {
            const iconElement = document.getElementById(`${panel}CopyIcon`);
            if (iconElement) {
                const originalIcon = iconElement.textContent;
                
                // æ”¹æˆå‹¾è™Ÿ
                iconElement.textContent = 'âœ“';
                
                // æ·»åŠ å‹•ç•«æ•ˆæœ
                iconElement.style.color = '#4ec9b0';
                iconElement.style.transform = 'scale(1.2)';
                iconElement.style.transition = 'all 0.2s ease';
                
                updateStatus('å·²è¤‡è£½æ‰€æœ‰å…§å®¹åˆ°å‰ªè²¼ç°¿');
                
                // 1ç§’å¾Œæ¢å¾©åŸå§‹åœ–æ¨™
                setTimeout(() => {
                    iconElement.textContent = originalIcon;
                    iconElement.style.color = '';
                    iconElement.style.transform = '';
                }, 1000);
            } else {
                updateStatus('å·²è¤‡è£½æ‰€æœ‰å…§å®¹åˆ°å‰ªè²¼ç°¿');
            }
        }

        // å‚™ç”¨çš„é¢æ¿è¤‡è£½æ–¹æ³•
        function fallbackPanelCopy(text, panel) {
            if (!text) {
                updateStatus('æ²’æœ‰å…§å®¹å¯ä¾›è¤‡è£½');
                return;
            }
            
            // ä½¿ç”¨ Clipboard API ä½œç‚ºé¦–é¸
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showPanelCopySuccess(panel);
                }).catch(() => {
                    // å¦‚æœ Clipboard API å¤±æ•—ï¼Œä½¿ç”¨å‚³çµ±æ–¹æ³•
                    useTextareaCopy(text, panel);
                });
            } else {
                // ä½¿ç”¨å‚³çµ±çš„ textarea æ–¹æ³•
                useTextareaCopy(text, panel);
            }
        }

        // ä½¿ç”¨ textarea çš„è¤‡è£½æ–¹æ³•
        function useTextareaCopy(text, panel) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            // é¸å–ä¸¦è¤‡è£½
            textarea.select();
            textarea.setSelectionRange(0, text.length);
            
            try {
                const success = document.execCommand('copy');
                if (success) {
                    showPanelCopySuccess(panel);
                } else {
                    updateStatus('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½');
                }
            } catch (e) {
                updateStatus('è¤‡è£½å¤±æ•—: ' + e.message);
            }
            
            document.body.removeChild(textarea);
        }        
    </script>  
</body>
</html>