<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ file_path }} - Android Log 分析報告查看器</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 面板內容容器 */
        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #0d0d0d;
        }

		/* 將分析報告中的樣式提升為全域樣式 */
		.panel-content style {
			display: block !important;
		}    
		
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-hover: #333333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #444444;
            --accent-color: #4ec9b0;
            --header-height: 60px;
            --status-height: 30px;
            --line-hover-color: #2d5a8e;  /* 新增統一的行 hover 顏色 */            
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* 頂部工具列 */
        .header {
            height: var(--header-height);
            background: #1a1a1a;  /* 改為更深的黑色 */
            border-bottom: 1px solid #333333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: relative;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .file-info h1 {
            font-size: 18px;
            font-weight: 500;
        }
        
        .file-info p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            background: #2d2d2d;
            border: 1px solid #444444;
            color: #e0e0e0;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #3a3a3a;
            border-color: #666666;
        }
        
        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #3db89f;
        }
        
        /* 主容器 */
        .main-container {
            height: calc(100vh - var(--header-height) - var(--status-height));
            display: flex;
            position: relative;
        }
        
        /* 分割面板 */
        .split-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }
        
        .split-panel.hidden {
            display: none;
        }
        
        /* 面板頭部 */
        .panel-header {
            background: #1e1e1e;
            padding: 8px 12px;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* 面板內容 */
        .panel-content {
            flex: 1;
            overflow: hidden;  /* 改為 hidden，不顯示捲軸 */
            position: relative;
            background: var(--bg-primary);
        }

        /* 確保 iframe 的容器也使用相同樣式 */
        .panel-content iframe {
            scrollbar-width: thin;
            scrollbar-color: #444 #1a1a1a;
        }

        /* 分析報告內容樣式 */
        .analysis-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 原始內容樣式 */
        .original-content {
            flex: 1;
            padding: 20px 20px 0 20px; /* 移除底部 padding */
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            word-wrap: normal;
            color: #d4d4d4;
            background: transparent;
            min-width: max-content;
        }

        /* 在最後一行後添加一些空間 */
        .original-content::after {
            content: '';
            display: block;
            height: 20px; /* 只在最後添加一點空間 */
        }

        .line-numbers::after {
            content: '';
            display: block;
            height: 20px; /* 與內容對齊 */
        }

        /* 分割條 */
        .resize-handle {
            width: 5px;
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
            /* 增加可點擊區域 */
            margin: 0 3px;
            padding: 0 1px;
            z-index: 10;
        }
        
        .resize-handle:hover {
            background: var(--accent-color);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            left: -5px;
            right: -5px;
            top: 0;
            bottom: 0;
            cursor: col-resize;
        }

        .resize-handle.hidden {
            display: none;
        }
        
        /* 狀態列 */
        .status-bar {
            height: var(--status-height);
            background: #1e3a5f; /* 深藍色背景 */
            border-top: 1px solid #2d5a8e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 12px;
            color: #a8c7e8; /* 淺藍色文字 */
        }

        .status-bar .warning-text {
            color: #ffd700; /* 金黃色警告文字 */
            font-weight: bold;
            margin-left: 20px;
        }

        /* 全屏模式 */
        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .fullscreen .panel-content {
            height: calc(100% - 45px);
        }
        
        /* 載入動畫 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .loading::before {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 匯出選單 */
        .export-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 0;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }
        
        .export-menu.show {
            display: block;
        }
        
        .export-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-item:hover {
            background: var(--bg-hover);
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .header {
                padding: 0 10px;
            }
            
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn span:not(:first-child) {
                display: none;
            }
            
            /* 在手機上預設使用單欄顯示 */
            .split-panel {
                flex: 1 !important;
            }
            
            .resize-handle {
                display: none !important;
            }
        }
        
        /* 錯誤訊息 */
        .error-message {
            color: #ff6b6b;
            padding: 20px;
            text-align: center;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 6px;
            margin: 20px;
        }

        /* 分析報告內容樣式 */
        .panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
            background: var(--bg-primary);
        }
        
        /* 分析報告容器 */
        .analysis-wrapper {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
        }
        
        /* 覆蓋分析報告的樣式 */
        .panel-content .report-content,
        .panel-content .report-line,
        .panel-content pre {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
            background: transparent;
        }
        
        .panel-content .report-line {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 2px 0;
        }

        /* 原始內容容器 */
        .original-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        /* 內容表格容器 */
        .content-table-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
        }

        /* 使用表格佈局 */
        .content-table {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        /* 行號容器 - 固定寬度，不捲動 */
        .line-numbers-container {
            width: 60px;
            min-width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* 分析報告的 iframe 容器樣式 */
        .content-container iframe {
            position: relative;
            z-index: 1;
        }

        /* 行號內容 */
        .analysis-with-line-numbers,
        .line-numbers-content {
            padding: 20px 10px 20px 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
        }

        /* 虛擬行 hover 效果 */
        .hover-overlay {
            pointer-events: none !important;
        }

        .current-line-highlight {
            pointer-events: none !important;
            will-change: transform, top;
        }

        /* 內容容器 - 可捲動 */
        .content-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
        }

        /* 內容區域 */
        .content-area {
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            min-width: max-content;
        }

        /* 分析報告專用樣式 - 不影響右側 */
        #leftPanel .content-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #leftPanel .content-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            margin: 0;
            padding: 0;
        }

        /* 確保 wrapper 也填滿 */
        #leftPanel .original-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* 移除可能的額外邊距 */
        #leftPanel .panel-content {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* 確保 iframe 內容不會橫向溢出 */
        #leftPanel iframe {
            max-width: 100%;
        }
                
        /* 確保 iframe 填滿容器 */
        .content-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }        
        /* 行號列固定 */
        .line-number-column {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #1a1a1a;
            width: 60px;
            min-width: 60px;
            overflow: hidden;
        }

        .content-row {
            
        }

        .line-number-cell {
            display: table-cell;
            width: 60px;
            min-width: 60px;
            max-width: 80px;
            padding: 0 5px 0 0; /* 減少 padding */
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            vertical-align: top;
            background: #1a1a1a;
            border-right: 1px solid #333;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .content-cell {
            display: table-cell;
            padding: 0 20px 0 10px; /* 調整左側 padding */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            vertical-align: top;
        }

        /* 內容區域的內部容器 */
        .content-inner {
            display: flex;
            position: relative;
        }

        /* 原始內容樣式 */
        .original-content {
            flex: 1;
            padding: 20px;
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            word-wrap: normal;
            color: #d4d4d4;
            background: transparent;
            min-width: max-content;
        }
        
        /* 分析報告特定樣式 */
        .panel-content .report-line {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 2px 0;
            color: var(--text-primary);
        }
        
        .panel-content .anr-type {
            color: #ff9800;
            font-weight: bold;
        }
        
        .panel-content .process-name {
            color: #4ec9b0;
            font-weight: bold;
        }
        
        .panel-content .timestamp {
            color: #608b4e;
        }
        
        .panel-content .separator {
            color: #565656;
        }
        
        .panel-content a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .panel-content a:hover {
            text-decoration: underline;
        }

        /* 高亮樣式 */
        .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; } /* 黃色 */
        .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; } /* 綠色 */
        .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; } /* 藍色 */
        .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; } /* 橙色 */
        .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; } /* 粉紅 */

        /* 右鍵選單樣式 */
        .context-menu {
            position: fixed;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 5px 0;
            z-index: 10000;
            display: none;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
            max-height: 80vh; /* 加入最大高度限制 */
            overflow-y: auto; /* 內容過多時顯示捲軸 */
            min-width: 180px; /* 確保選單有最小寬度 */
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.1s ease, transform 0.1s ease;            
        }

        .context-menu[style*="visibility: visible"] {
            opacity: 1;
            transform: scale(1);
        }

        .context-menu-item {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 13px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: #3a3a3a;
        }

        .context-menu-separator {
            height: 1px;
            background: #555;
            margin: 5px 0;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border: 1px solid #666;
            border-radius: 2px;
        }

        /* 行號樣式 */
        .line-numbers {
            position: sticky;
            left: 0;
            flex-shrink: 0;
            width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px 10px 0 0; /* 移除底部 padding */
            margin: 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            z-index: 10;
            align-self: flex-start;
        }

        /* 行號項目 */
        .line-number {
            display: block;
            height: 1.6em;
            line-height: 1.6em;
            cursor: pointer;
            padding-left: 10px;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .line-number:hover {
            background-color: var(--line-hover-color);
        }
                
        /* 第一行和最後一行的特殊處理 */
        .content-table::before,
        .content-table::after {
            content: '';
            display: table-row;
            height: 20px;
        }

        /* 確保第一行對齊 */
        .line-numbers::before,
        .original-content::before {
            content: '';
            display: block;
            height: 20px; /* 與內容的 padding-top 相同 */
        }

        /* 當前行高亮 */
        .line-number.current {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .with-line-numbers {
            padding-left: 80px !important;
            position: relative;
        }

        /* 高亮導航提示 */
        .highlight-nav-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #2d2d2d;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #e0e0e0;
            display: none;
            z-index: 1000;
        }

        /* 書籤樣式 */
        .line-number.bookmarked::before {
            content: '●';
            position: absolute;
            left: 2px;
            color: #4ec9b0;
            font-size: 10px;
        }

        /* 內容行 */
        .content-line {
            height: 1.6em;
            line-height: 1.6em;
            cursor: text;
            position: relative;
        }

        .content-line:hover {
            background-color: var(--line-hover-color);
        }
 
        /* 自定義捲軸樣式 - 只在內容區域 */
        .content-container::-webkit-scrollbar,
        .original-content-wrapper::-webkit-scrollbar,
        .panel-content::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .content-container::-webkit-scrollbar-track,
        .original-content-wrapper::-webkit-scrollbar-track,
        .panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .content-container::-webkit-scrollbar-thumb,
        .original-content-wrapper::-webkit-scrollbar-thumb,
        .panel-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .content-container::-webkit-scrollbar-thumb:hover,
        .original-content-wrapper::-webkit-scrollbar-thumb:hover,
        .panel-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 確保行號容器永遠不顯示捲軸 */
        .line-numbers-container::-webkit-scrollbar {
            display: none;
        }

        /* 行號懸停效果 */
        .line-number:not(.bookmarked):hover::before {
            content: '📌';
            position: absolute;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
        }

        .line-number.bookmarked:hover::before {
            content: '✕';
            color: #ff6666;
            left: 2px;
        }

        /* 高亮控制按鈕 - 修正位置 */
        .highlight-controls {
            position: absolute;
            right: 130px;
            display: flex;
            gap: 5px;
            z-index: 100;
            background: #1a1a1a;
            padding: 5px;
            border-radius: 4px;
            /* border: 1px solid #333;*/
        }

        .highlight-control-btn {
            width: 25px;
            height: 25px;
            border: 1px solid #555;
            border-radius: 20px;
            cursor: pointer;
            display: none;
            position: relative;
        }

        .highlight-control-btn:hover::after {
            content: '✕';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 12px;
            font-weight: bold;
        }

        #rightPanel {
            padding-right: 6px;
        }

        /* 分析報告的虛擬行 hover 效果 */
        .analysis-line-overlay {
            position: absolute;
            left: 60px; /* 行號寬度 */
            right: 0;
            height: 20.8px; /* 1.6em * 13px */
            pointer-events: none;
            background-color: transparent;
            transition: background-color 0.2s ease;
            z-index: 5;
        }

        .analysis-line-overlay.hover {
            background-color: var(--line-hover-color);
            opacity: 0.3;
        }

        /* iframe 容器的相對定位 */
        .content-container.analysis-container {
            position: relative;
        }        
    </style>
    <style>
        /* 內容行樣式 */
        .content-row {
            /* display: table-row; */
        }

        /* 行號單元格 - 固定在左側 */
        .line-number-cell {
            display: table-cell;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            padding: 0 10px 0 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            vertical-align: top;
            background: #1a1a1a;
            border-right: 1px solid #333;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        /* 內容單元格 */
        .content-cell {
            display: table-cell;
            padding: 0 20px 0 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            vertical-align: top;
            min-width: max-content; /* 確保內容不會被截斷 */
        }

        /* 隱藏行號區域的捲軸 */
        .line-number-column::-webkit-scrollbar {
            display: none;
        }

        /* 自定義捲軸樣式（可選） */
        .content-table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .content-table-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .content-table-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .content-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 確保只有內容區域可以捲動 */
        .panel-content {
            overflow: hidden; /* 面板本身不顯示捲軸 */
        }        
    </style>
    <style>
        /* 左側分析報告專用的行號樣式 */
        #leftPanel .line-numbers-container {
            width: 60px;
            min-width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow: hidden;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        #leftPanel .analysis-line-numbers {
            position: relative;
            width: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
        }

        #leftPanel .analysis-line-number {
            position: absolute;
            width: 100%;
            padding: 0 10px 0 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #666;
            user-select: none;
            cursor: pointer;
            background: #1a1a1a;
            transition: background-color 0.2s ease;
        }

        #leftPanel .analysis-line-number:hover {
            background-color: var(--line-hover-color);
        }

        #leftPanel .analysis-line-number.bookmarked::before {
            content: '●';
            position: absolute;
            left: 2px;
            color: #4ec9b0;
            font-size: 10px;
        }

        #leftPanel .analysis-line-number:not(.bookmarked):hover::before {
            content: '📌';
            position: absolute;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
        }

        #leftPanel .analysis-line-number.bookmarked:hover::before {
            content: '✕';
            color: #ff6666;
            left: 2px;
        }       
    </style>   
</head>
<body>
    <!-- 頂部工具列 -->
    <div class="header">
        <div class="header-left">
            <div class="file-info">
                <h1 id="filename">載入中...</h1>
                <p id="filepath">{{ file_path }}</p>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" id="toggleOriginalBtn" onclick="toggleOriginalPanel()">
                <span>📄</span>
                <span>查看原始檔案</span>
            </button>
            <button class="btn" id="switchPanelsBtn" onclick="switchPanels()" style="display: none;">
                <span>🔄</span>
                <span>左右交換</span>
            </button>
            <button class="btn" onclick="toggleFullscreenMode()">
                <span>⛶</span>
                <span>全屏模式</span>
            </button>
            <a href="/view-analysis?path={{ file_path }}&download=true" class="btn" download>
                <span>📥</span>
                <span>下載分析</span>
            </a>
            <a href="/view-analysis?path={{ file_path }}&download=true&original=true" class="btn" download>
                <span>📥</span>
                <span>下載原始</span>
            </a>
        </div>
    </div>
    
    <!-- 主容器 -->
    <div class="main-container" id="mainContainer">
        <!-- 左側面板（預設顯示分析報告） -->
        <div class="split-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="leftPanelIcon">📊</span>
                    <span id="leftPanelTitle">分析報告</span>
                </div>
                <!-- 左側高亮控制按鈕 -->
                <div class="highlight-controls" id="leftHighlightControls">
                    <div class="highlight-control-btn" id="leftHighlightBtn1" style="background: rgba(255, 255, 0, 0.6);" onclick="clearHighlightColor(1, 'left')" title="清除黃色高亮"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn2" style="background: rgba(0, 255, 0, 0.6);" onclick="clearHighlightColor(2, 'left')" title="清除綠色高亮"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn3" style="background: rgba(0, 191, 255, 0.6);" onclick="clearHighlightColor(3, 'left')" title="清除藍色高亮"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn4" style="background: rgba(255, 165, 0, 0.6);" onclick="clearHighlightColor(4, 'left')" title="清除橙色高亮"></div>
                    <div class="highlight-control-btn" id="leftHighlightBtn5" style="background: rgba(255, 192, 203, 0.6);" onclick="clearHighlightColor(5, 'left')" title="清除粉紅高亮"></div>
                </div>                
                <div class="panel-controls">
                    <button class="icon-btn" onclick="copyPanelContent('left')" title="複製內容">
                        <span id="leftCopyIcon">📋</span>
                    </button>                        
                    <button class="icon-btn" onclick="toggleExportMenu('left')" title="匯出">
                        💾
                    </button>
                    <div class="export-menu" id="leftExportMenu">
                        <div class="export-item" onclick="exportContent('left', 'html')">
                            <span>🌐</span> HTML
                        </div>
                        <div class="export-item" onclick="exportContent('left', 'markdown')">
                            <span>📝</span> Markdown
                        </div>
                        <div class="export-item" onclick="exportContent('left', 'txt')">
                            <span>📄</span> 純文字
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleFullscreen('left')" title="全屏">
                        ⛶
                    </button>
                </div>
            </div>
            <div class="panel-content" id="leftContent">
                <div class="loading">載入分析報告中...</div>
            </div>
        </div>
        
        <!-- 分割條 -->
        <div class="resize-handle hidden" id="resizeHandle"></div>
        
        <!-- 右側面板（預設隱藏） -->
        <div class="split-panel hidden" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="rightPanelIcon">📄</span>
                    <span id="rightPanelTitle">原始檔案</span>
                </div>
                <!-- 高亮控制按鈕 -->
                <div class="highlight-controls" id="highlightControls">
                    <div class="highlight-control-btn" id="highlightBtn1" style="background: rgba(255, 255, 0, 0.6);" onclick="clearHighlightColor(1, 'right')" title="清除黃色高亮"></div>
                    <div class="highlight-control-btn" id="highlightBtn2" style="background: rgba(0, 255, 0, 0.6);" onclick="clearHighlightColor(2, 'right')" title="清除綠色高亮"></div>
                    <div class="highlight-control-btn" id="highlightBtn3" style="background: rgba(0, 191, 255, 0.6);" onclick="clearHighlightColor(3, 'right')" title="清除藍色高亮"></div>
                    <div class="highlight-control-btn" id="highlightBtn4" style="background: rgba(255, 165, 0, 0.6);" onclick="clearHighlightColor(4, 'right')" title="清除橙色高亮"></div>
                    <div class="highlight-control-btn" id="highlightBtn5" style="background: rgba(255, 192, 203, 0.6);" onclick="clearHighlightColor(5, 'right')" title="清除粉紅高亮"></div>
                </div>                
                <div class="panel-controls">
                    <button class="icon-btn" onclick="copyPanelContent('right')" title="複製內容">
                        <span id="rightCopyIcon">📋</span>
                    </button>                                                
                    <button class="icon-btn" onclick="toggleExportMenu('right')" title="匯出">
                        💾
                    </button>
                    <div class="export-menu" id="rightExportMenu">
                        <div class="export-item" onclick="exportContent('right', 'html')">
                            <span>🌐</span> HTML
                        </div>
                        <div class="export-item" onclick="exportContent('right', 'markdown')">
                            <span>📝</span> Markdown
                        </div>
                        <div class="export-item" onclick="exportContent('right', 'txt')">
                            <span>📄</span> 純文字
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleFullscreen('right')" title="全屏">
                        ⛶
                    </button>
                    <button class="icon-btn" onclick="closePanel('right')" title="關閉">
                        ✕
                    </button>
                </div>
            </div>
            <div class="panel-content" id="rightContent">
                <div class="loading">準備載入原始檔案...</div>
            </div>
        </div>
    </div>
    
    <!-- 狀態列 -->
    <div class="status-bar">
        <div class="status-left">
            <span id="statusText">就緒</span>
        </div>
        <div class="status-right">
            <span id="reportType">{{ report_type.upper() }} 報告</span>
            <span> | </span>
            <span id="loadTime">載入時間: 計算中...</span>
        </div>
    </div>
    <!-- 高亮導航提示 -->
    <div class="highlight-nav-hint" id="highlightNavHint">
        F2: 下一個高亮 | F3: 上一個高亮
    </div>    
    <script>
        // 全域變數
        const filePath = {{ escaped_file_path | safe }};
        let analysisContent = '';  // 分析報告內容
        let originalContent = '';  // 原始檔案內容
        let isOriginalLoaded = false;
        let currentLeftType = 'analysis';
        let currentRightType = 'original';
        let startTime = Date.now();
        let currentFocusedPanel = 'left';
        let currentFocusedLine = 1;
        let bookmarks = new Set();
        let currentBookmarkIndex = -1;
        let bookmarkArray = [];
        // 改為每個面板各自的書籤索引
        let leftBookmarkIndex = -1;
        let rightBookmarkIndex = -1;

        // 確保全域變數被正確初始化
        if (typeof window.currentFocusedPanel === 'undefined') {
            window.currentFocusedPanel = 'left';
        }
        if (typeof window.currentFocusedLine === 'undefined') {
            window.currentFocusedLine = 1;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateFilename();
            loadAnalysisContent();
            
            // 自動開啟原始檔案視窗
            setTimeout(() => {
                toggleOriginalPanel();  // 自動開啟右側面板
            }, 500);
            
            setupResizeHandler();
            setupKeyboardShortcuts();

            // 點擊外部關閉匯出選單
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.export-menu') && !e.target.closest('.icon-btn')) {
                    closeAllExportMenus();
                }
            });
        });
        
        // 更新檔名顯示
        function updateFilename() {
            // 解碼 HTML 編碼的檔案路徑
            const decodedPath = decodeURIComponent(filePath);
            const pathParts = decodedPath.split('/');
            let filename = pathParts[pathParts.length - 1];
            
            // 移除 .analyzed.html 後綴以顯示更簡潔的檔名
            filename = filename.replace('.analyzed.html', '');
            filename = filename.replace('.analyzed.txt', '');
            
            document.getElementById('filename').textContent = filename;
        }
        
        // 載入分析報告內容
        async function loadAnalysisContent() {
            try {
                const response = await fetch(`/api/load-analysis?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    analysisContent = data.content;  // 儲存分析報告內容
                    
                    // 調試：檢查內容類型
                    console.log('Content type:', typeof data.content);
                    console.log('Content preview:', data.content.substring(0, 200));
                    
                    displayContent('left', data.content, 'analysis');
                    updateLoadTime();
                } else {
                    showError('left', data.error);
                }
            } catch (error) {
                showError('left', '載入分析報告失敗: ' + error.message);
            }
        }
        
        // 載入原始檔案內容
        async function loadOriginalContent() {
            if (isOriginalLoaded) return;
            
            updateStatus('載入原始檔案中...');
            
            try {
                const response = await fetch(`/api/load-original?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    originalContent = data.content;  // 儲存原始檔案內容
                    displayContent('right', data.content, 'original');
                    isOriginalLoaded = true;
                    updateStatus('原始檔案已載入');
                } else {
                    showError('right', data.error || '找不到原始檔案');
                    updateStatus('載入原始檔案失敗');
                }
            } catch (error) {
                showError('right', '載入原始檔案失敗: ' + error.message);
                updateStatus('載入原始檔案失敗');
            }
        }

        // 顯示內容
        function displayContent(panel, content, type) {
            const contentEl = document.getElementById(panel + 'Content');
            
            if (type === 'analysis') {
                // 分析報告處理
                if (panel === 'left' && currentLeftType === 'analysis') {
                    analysisContent = content;
                } else if (panel === 'right' && currentRightType === 'analysis') {
                    analysisContent = content;
                }
                
                // 建立結構
                const wrapper = document.createElement('div');
                wrapper.className = 'original-content-wrapper';
                wrapper.id = `${panel}ContentWrapper`;
                
                // 建立行號容器
                const lineNumbersContainer = document.createElement('div');
                lineNumbersContainer.className = 'line-numbers-container';
                lineNumbersContainer.id = `${panel}LineNumbersContainer`;
                
                const lineNumbersContent = document.createElement('div');
                lineNumbersContent.className = 'line-numbers-content';
                lineNumbersContent.id = `${panel}LineNumbers`;
                
                // 建立內容容器
                const contentContainer = document.createElement('div');
                contentContainer.className = 'content-container';
                contentContainer.id = `${panel}ContentContainer`;
                contentContainer.style.position = 'relative';
                
                // 建立 iframe
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.srcdoc = content;
                
                // 組裝結構
                lineNumbersContainer.appendChild(lineNumbersContent);
                contentContainer.appendChild(iframe);
                wrapper.appendChild(lineNumbersContainer);
                wrapper.appendChild(contentContainer);
                
                contentEl.innerHTML = '';
                contentEl.appendChild(wrapper);
                
                // iframe 載入後的處理
                iframe.onload = function() {
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument;
                            const iframeWindow = iframe.contentWindow;
                            
                            if (iframeDoc && iframeWindow) {
                                // 注入樣式
                                const style = iframeDoc.createElement('style');
                                style.textContent = `
                                    html, body {
                                        margin: 0;
                                        padding: 0;
                                        height: 100%;
                                        overflow: auto;
                                    }
                                    
                                    body {
                                        line-height: 1.6em;
                                        font-size: 13px;
                                        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        overflow-wrap: break-word;
                                        max-width: 100%;
                                        background: transparent;
                                    }
                                    
                                    /* 移除可能的外層容器邊距 */
                                    .report-content,
                                    .left-panel,
                                    .analysis-content {
                                        margin: 0;
                                        padding: 20px;
                                        box-sizing: border-box;
                                    }
                                    
                                    * {
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        overflow-wrap: break-word;
                                        max-width: 100%;
                                    }
                                    
                                    pre, code {
                                        white-space: pre-wrap;
                                        word-wrap: break-word;
                                        word-break: break-all;
                                        overflow-wrap: break-word;
                                    }
                                    
                                    ::-webkit-scrollbar {
                                        height: 8px;
                                        width: 8px;
                                    }
                                    
                                    ::-webkit-scrollbar-track {
                                        background: #1a1a1a;
                                    }
                                    
                                    ::-webkit-scrollbar-thumb {
                                        background: #444;
                                        border-radius: 4px;
                                    }
                                    
                                    ::-webkit-scrollbar-thumb:hover {
                                        background: #555;
                                    }
                                    
                                    * {
                                        scrollbar-width: thin;
                                        scrollbar-color: #444 #1a1a1a;
                                    }
                                    
                                    .report-line {
                                        line-height: 1.6em;
                                        font-size: 13px;
                                        margin: 0;
                                        word-wrap: break-word;
                                        word-break: break-all;
                                    }
                                    
                                    .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; }
                                    .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; }
                                    .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; }
                                    .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; }
                                    .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; }
                                `;
                                iframeDoc.head.appendChild(style);
                                
                                // 根據面板決定行號生成方式
                                if (panel === 'left' && currentLeftType === 'analysis') {
                                    // 左側分析報告 - 使用動態行號對齊
                                    
                                    // 計算實際行高的函數
                                    const measureActualLines = function() {
                                        const reportContent = iframeDoc.querySelector('.report-content') || 
                                                            iframeDoc.querySelector('.left-panel') ||
                                                            iframeDoc.querySelector('pre') ||
                                                            iframeDoc.body;
                                        
                                        if (!reportContent) {
                                            console.log('找不到報告內容');
                                            return [];
                                        }
                                        
                                        // 獲取計算後的樣式
                                        const computedStyle = iframeWindow.getComputedStyle(reportContent);
                                        const paddingTop = parseFloat(computedStyle.paddingTop) || 0;
                                        
                                        const lineData = [];
                                        
                                        // 如果是 pre 元素，按行分割
                                        if (reportContent.tagName === 'PRE') {
                                            const lines = reportContent.textContent.split('\n');
                                            let currentTop = paddingTop;
                                            const lineHeight = 20.8; // 1.6em * 13px
                                            
                                            lines.forEach((line, index) => {
                                                lineData.push({
                                                    index: index + 1,
                                                    top: currentTop,
                                                    height: lineHeight,
                                                    element: null
                                                });
                                                currentTop += lineHeight;
                                            });
                                        } else {
                                            // 對於其他元素，分析實際的行佈局
                                            const allElements = reportContent.querySelectorAll('*');
                                            let currentLine = 1;
                                            let lastY = -999;
                                            
                                            allElements.forEach(element => {
                                                // 跳過隱藏元素
                                                const style = iframeWindow.getComputedStyle(element);
                                                if (style.display === 'none' || style.visibility === 'hidden') {
                                                    return;
                                                }
                                                
                                                // 只處理包含文字的元素
                                                const text = element.textContent.trim();
                                                if (text.length === 0 && element.tagName !== 'BR') {
                                                    return;
                                                }
                                                
                                                const rect = element.getBoundingClientRect();
                                                const y = rect.top + iframeWindow.pageYOffset;
                                                
                                                // 如果 Y 座標變化超過 5px，視為新行
                                                if (Math.abs(y - lastY) > 5) {
                                                    lineData.push({
                                                        index: currentLine,
                                                        top: y - paddingTop, // 減去容器的 padding
                                                        height: rect.height || 20.8,
                                                        element: element
                                                    });
                                                    currentLine++;
                                                    lastY = y;
                                                }
                                            });
                                        }
                                        
                                        // 確保至少有一行
                                        if (lineData.length === 0) {
                                            lineData.push({
                                                index: 1,
                                                top: 0,
                                                height: 20.8,
                                                element: null
                                            });
                                        }
                                        
                                        console.log(`計算出 ${lineData.length} 行`);
                                        return lineData;
                                    };
                                    
                                    // 生成動態行號的函數
                                    const generateDynamicLineNumbers = function(lineData) {
                                        // 清空容器
                                        lineNumbersContent.innerHTML = '';
                                        lineNumbersContent.className = 'analysis-line-numbers';
                                        
                                        // 設置容器樣式，與右側一致
                                        lineNumbersContent.style.paddingTop = '20px';
                                        lineNumbersContent.style.paddingBottom = '20px';
                                        
                                        lineData.forEach(data => {
                                            const lineNumberEl = document.createElement('span'); // 使用 span 而不是 div
                                            lineNumberEl.className = 'analysis-line-number';
                                            lineNumberEl.setAttribute('data-line', String(data.index));
                                            lineNumberEl.setAttribute('data-panel', panel);
                                            lineNumberEl.textContent = data.index;
                                            
                                            // 設置絕對定位來對齊實際行高
                                            lineNumberEl.style.position = 'absolute';
                                            lineNumberEl.style.top = (data.top + 20) + 'px'; // 加上 padding 偏移
                                            lineNumberEl.style.height = data.height + 'px';
                                            lineNumberEl.style.lineHeight = data.height + 'px';
                                            lineNumberEl.style.width = '50px'; // 固定寬度
                                            lineNumberEl.style.display = 'block';
                                            
                                            // 添加事件處理
                                            lineNumberEl.addEventListener('click', function(e) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                toggleBookmark(this);
                                            });
                                            
                                            lineNumberEl.addEventListener('mouseenter', function() {
                                                window.currentFocusedLine = data.index;
                                                window.currentFocusedPanel = panel;
                                                highlightCurrentLineNumber(panel, data.index);
                                            });
                                            
                                            lineNumbersContent.appendChild(lineNumberEl);
                                        });
                                        
                                        // 設置容器的總高度
                                        if (lineData.length > 0) {
                                            const lastLine = lineData[lineData.length - 1];
                                            const totalHeight = lastLine.top + lastLine.height + 40; // 加上上下 padding
                                            lineNumbersContent.style.height = totalHeight + 'px';
                                        }
                                        
                                        return lineData.length;
                                    };
                                    
                                    // 等待內容載入的函數
                                    const waitForContent = function(callback) {
                                        const checkInterval = setInterval(() => {
                                            const leftPanel = iframeDoc.querySelector('.left-panel');
                                            
                                            if (leftPanel && leftPanel.scrollHeight > 100) {
                                                clearInterval(checkInterval);
                                                callback();
                                            }
                                        }, 100);
                                        
                                        setTimeout(() => {
                                            clearInterval(checkInterval);
                                            callback();
                                        }, 3000);
                                    };
                                    
                                    // 等待內容載入完成後測量行高
                                    waitForContent(() => {
                                        const lineData = measureActualLines();
                                        const lineCount = generateDynamicLineNumbers(lineData);
                                        
                                        // 保存行數和行數據
                                        window[`${panel}LineCount`] = lineCount;
                                        window[`${panel}LineData`] = lineData;
                                        
                                        // 修改捲動同步邏輯
                                        const bindScrollEvents = function() {
                                            const scrollableElement = iframeDoc.querySelector('.left-panel') || 
                                                                    iframeDoc.documentElement || 
                                                                    iframeDoc.body;
                                            
                                            if (scrollableElement) {
                                                const syncScroll = function() {
                                                    const scrollTop = scrollableElement.scrollTop || 
                                                                    iframeWindow.pageYOffset || 
                                                                    iframeDoc.documentElement.scrollTop || 
                                                                    iframeDoc.body.scrollTop || 0;
                                                    
                                                    lineNumbersContent.style.transform = `translateY(-${scrollTop}px)`;
                                                };
                                                
                                                // 綁定多個可能的捲動事件
                                                scrollableElement.addEventListener('scroll', syncScroll);
                                                iframeWindow.addEventListener('scroll', syncScroll);
                                                
                                                // 如果有橫向捲軸，確保行號不會跟著橫向移動
                                                lineNumbersContainer.style.position = 'sticky';
                                                lineNumbersContainer.style.left = '0';
                                                
                                                // 初始同步
                                                syncScroll();
                                            }
                                        };
                                        
                                        bindScrollEvents();
                                        
                                        // 監聽 iframe 內容變化，重新計算行高
                                        const observer = new MutationObserver(function() {
                                            const newLineData = measureActualLines();
                                            if (newLineData.length !== lineData.length) {
                                                generateDynamicLineNumbers(newLineData);
                                                window[`${panel}LineData`] = newLineData;
                                            }
                                        });
                                        
                                        const leftPanel = iframeDoc.querySelector('.left-panel');
                                        if (leftPanel) {
                                            observer.observe(leftPanel, {
                                                childList: true,
                                                subtree: true,
                                                characterData: true
                                            });
                                        }
                                        
                                        // 滑鼠追蹤
                                        const trackMouse = function(e) {
                                            const leftPanel = iframeDoc.querySelector('.left-panel');
                                            const scrollTop = leftPanel ? leftPanel.scrollTop : 0;
                                            const y = e.clientY + scrollTop - 20;
                                            
                                            // 根據滑鼠位置找到對應的行
                                            let targetLine = null;
                                            for (let i = 0; i < lineData.length; i++) {
                                                const data = lineData[i];
                                                if (y >= data.top && y < data.top + data.height) {
                                                    targetLine = data.index;
                                                    break;
                                                }
                                            }
                                            
                                            if (targetLine) {
                                                window.currentFocusedLine = targetLine;
                                                window.currentFocusedPanel = panel;
                                                highlightCurrentLineNumber(panel, targetLine);
                                            }
                                        };
                                        
                                        iframeDoc.addEventListener('mousemove', trackMouse);
                                        
                                        // 設置其他事件
                                        setupIframeContextMenu(iframe, panel);
                                        
                                        // 恢復書籤狀態
                                        bookmarks.forEach(bookmarkKey => {
                                            const [bPanel, bLine] = bookmarkKey.split('-');
                                            if (bPanel === panel) {
                                                const lineEl = lineNumbersContent.querySelector(`.analysis-line-number[data-line="${bLine}"]`);
                                                if (lineEl) {
                                                    lineEl.classList.add('bookmarked');
                                                }
                                            }
                                        });
                                        
                                        updateStatus(`載入完成 - 共 ${lineCount} 行`);
                                    });
                                    
                                } else {
                                    // 右側或非分析報告 - 使用原有的固定行高方式
                                    
                                    // 計算行數的函數
                                    const calculateLines = function() {
                                        const leftPanel = iframeDoc.querySelector('.left-panel');
                                        let contentHeight = 0;
                                        
                                        if (leftPanel) {
                                            contentHeight = leftPanel.scrollHeight;
                                            console.log('使用 left-panel scrollHeight:', contentHeight);
                                        } else {
                                            const body = iframeDoc.body;
                                            contentHeight = body.scrollHeight;
                                            console.log('使用 body scrollHeight:', contentHeight);
                                        }
                                        
                                        const lineHeight = 20.8;
                                        const lineCount = Math.ceil(contentHeight / lineHeight);
                                        console.log(`計算出 ${lineCount} 行`);
                                        
                                        return lineCount;
                                    };
                                    
                                    // 生成行號的函數
                                    const generateLineNumbers = function(count) {
                                        lineNumbersContent.innerHTML = '';
                                        for (let i = 1; i <= count; i++) {
                                            const lineNumberEl = document.createElement('span');
                                            lineNumberEl.className = 'line-number';
                                            lineNumberEl.setAttribute('data-line', String(i));
                                            lineNumberEl.setAttribute('data-panel', panel);
                                            lineNumberEl.textContent = i;
                                            
                                            lineNumberEl.addEventListener('click', function(e) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                toggleBookmark(this);
                                            });
                                            
                                            lineNumberEl.addEventListener('mouseenter', function() {
                                                window.currentFocusedLine = i;
                                                window.currentFocusedPanel = panel;
                                                highlightCurrentLineNumber(panel, i);
                                            });
                                            
                                            lineNumbersContent.appendChild(lineNumberEl);
                                        }
                                        
                                        lineNumbersContent.style.paddingTop = '20px';
                                        lineNumbersContent.style.paddingBottom = '20px';
                                    };
                                    
                                    // 延遲執行以確保內容載入完成
                                    const waitForContent = function(callback) {
                                        const checkInterval = setInterval(() => {
                                            const leftPanel = iframeDoc.querySelector('.left-panel');
                                            
                                            if (leftPanel && leftPanel.scrollHeight > 100) {
                                                clearInterval(checkInterval);
                                                callback();
                                            }
                                        }, 100);
                                        
                                        setTimeout(() => {
                                            clearInterval(checkInterval);
                                            callback();
                                        }, 3000);
                                    };
                                    
                                    // 等待內容載入完成後再計算行數
                                    waitForContent(() => {
                                        const lineCount = calculateLines();
                                        generateLineNumbers(lineCount);
                                        
                                        window[`${panel}LineCount`] = lineCount;
                                        
                                        // 捲動同步函數
                                        const bindScrollEvents = function() {
                                            const leftPanel = iframeDoc.querySelector('.left-panel');
                                            const container = document.getElementById(`${panel}LineNumbersContainer`);
                                            
                                            if (leftPanel && container) {
                                                console.log('找到 left-panel，設置滾動同步');
                                                
                                                container.style.overflowY = 'auto';
                                                container.style.overflowX = 'hidden';
                                                container.style.height = '100%';
                                                
                                                const syncScroll = function() {
                                                    container.scrollTop = leftPanel.scrollTop;
                                                };
                                                
                                                leftPanel.addEventListener('scroll', syncScroll);
                                                
                                                syncScroll();
                                            } else {
                                                console.log('未找到滾動元素，500ms 後重試');
                                                setTimeout(bindScrollEvents, 500);
                                            }
                                        };
                                        
                                        bindScrollEvents();
                                        
                                        // 滑鼠追蹤
                                        const trackMouse = function(e) {
                                            const leftPanel = iframeDoc.querySelector('.left-panel');
                                            const scrollTop = leftPanel ? leftPanel.scrollTop : 0;
                                            const y = e.clientY + scrollTop - 20;
                                            const lineHeight = 20.8;
                                            const lineNum = Math.floor(y / lineHeight) + 1;
                                            
                                            if (lineNum > 0 && lineNum <= lineCount) {
                                                window.currentFocusedLine = lineNum;
                                                window.currentFocusedPanel = panel;
                                                highlightCurrentLineNumber(panel, lineNum);
                                            }
                                        };
                                        
                                        iframeDoc.addEventListener('mousemove', trackMouse);
                                        
                                        // 監聽窗口大小變化
                                        let resizeTimer;
                                        iframeWindow.addEventListener('resize', function() {
                                            clearTimeout(resizeTimer);
                                            resizeTimer = setTimeout(() => {
                                                const newLineCount = calculateLines();
                                                if (newLineCount !== window[`${panel}LineCount`]) {
                                                    window[`${panel}LineCount`] = newLineCount;
                                                    generateLineNumbers(newLineCount);
                                                    
                                                    // 恢復書籤
                                                    bookmarks.forEach(bookmarkKey => {
                                                        const [bPanel, bLine] = bookmarkKey.split('-');
                                                        if (bPanel === panel) {
                                                            const lineEl = lineNumbersContent.querySelector(`.line-number[data-line="${bLine}"]`);
                                                            if (lineEl) {
                                                                lineEl.classList.add('bookmarked');
                                                            }
                                                        }
                                                    });
                                                }
                                            }, 300);
                                        });
                                        
                                        // 設置其他事件
                                        setupIframeContextMenu(iframe, panel);
                                        
                                        // 恢復書籤狀態
                                        bookmarks.forEach(bookmarkKey => {
                                            const [bPanel, bLine] = bookmarkKey.split('-');
                                            if (bPanel === panel) {
                                                const lineEl = lineNumbersContent.querySelector(`.line-number[data-line="${bLine}"]`);
                                                if (lineEl) {
                                                    lineEl.classList.add('bookmarked');
                                                }
                                            }
                                        });
                                        
                                        updateStatus(`載入完成 - 共 ${lineCount} 行`);
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('處理 iframe 時發生錯誤:', e);
                        }
                    }, 1000);
                };
                
                // 初始化焦點
                window.currentFocusedPanel = panel;
                window.currentFocusedLine = 1;
                
            } else {
                // 原始檔案處理 - 分離行號和內容
                if (panel === 'left' && currentLeftType === 'original') {
                    originalContent = content;
                } else if (panel === 'right' && currentRightType === 'original') {
                    originalContent = content;
                }
                
                const lines = content.split(/\r?\n/);
                if (lines[lines.length - 1] === '') {
                    lines.pop();
                }
                
                // 建立主包裝容器
                const wrapper = document.createElement('div');
                wrapper.className = 'original-content-wrapper';
                wrapper.id = `${panel}ContentWrapper`;
                
                // 建立行號容器
                const lineNumbersContainer = document.createElement('div');
                lineNumbersContainer.className = 'line-numbers-container';
                lineNumbersContainer.id = `${panel}LineNumbersContainer`;
                
                const lineNumbersContent = document.createElement('div');
                lineNumbersContent.className = 'line-numbers-content';
                lineNumbersContent.id = `${panel}LineNumbers`;
                
                // 建立內容容器
                const contentContainer = document.createElement('div');
                contentContainer.className = 'content-container';
                contentContainer.id = `${panel}ContentContainer`;
                
                const contentArea = document.createElement('div');
                contentArea.className = 'content-area';
                contentArea.id = `${panel}ContentArea`;
                
                // 生成行號和內容
                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    
                    // 建立行號 - 確保設置所有必要的屬性
                    const lineNumberEl = document.createElement('span');
                    lineNumberEl.className = 'line-number';
                    lineNumberEl.setAttribute('data-line', lineNum);
                    lineNumberEl.setAttribute('data-panel', panel);
                    lineNumberEl.textContent = lineNum;
                    lineNumbersContent.appendChild(lineNumberEl);
                    
                    // 建立內容行
                    const contentLineEl = document.createElement('div');
                    contentLineEl.className = 'content-line';
                    contentLineEl.setAttribute('data-line', String(lineNum));
                    contentLineEl.setAttribute('data-panel', panel);
                    contentLineEl.innerHTML = escapeHtml(line) || '&nbsp;';
                    contentArea.appendChild(contentLineEl);
                });
                
                // 組裝結構
                lineNumbersContainer.appendChild(lineNumbersContent);
                contentContainer.appendChild(contentArea);
                wrapper.appendChild(lineNumbersContainer);
                wrapper.appendChild(contentContainer);
                
                contentEl.innerHTML = '';
                contentEl.appendChild(wrapper);
                
                // 同步捲動
                setupScrollSync(panel);
                
                // 設置事件（延遲以確保 DOM 已更新）
                setTimeout(() => {
                    // 平行設置所有事件
                    Promise.all([
                        new Promise(resolve => {
                            setupLineNumberHandlers(panel);
                            resolve();
                        }),
                        new Promise(resolve => {
                            setupContentLineTracking(panel);
                            resolve();
                        }),
                        new Promise(resolve => {
                            setupContentContextMenu(panel);
                            resolve();
                        })
                    ]).then(() => {
                        // 初始化焦點
                        window.currentFocusedPanel = panel;
                        window.currentFocusedLine = 1;
                    });
                }, 100);
                
                updateStatus(`載入完成 - 共 ${lines.length} 行`);
            }
        }

        function setupIframeScrollSync(iframe, lineNumbers) {
            try {
                const iframeWindow = iframe.contentWindow;
                if (!iframeWindow) return;
                
                // 監聽 iframe 內的捲動事件
                iframeWindow.addEventListener('scroll', function() {
                    const scrollTop = iframeWindow.pageYOffset || 
                                    iframeWindow.document.documentElement.scrollTop || 
                                    iframeWindow.document.body.scrollTop || 0;
                    
                    // 同步行號位置
                    lineNumbers.style.transform = `translateY(-${scrollTop}px)`;
                });
                
                // 也監聽 iframe 內 body 的捲動
                const iframeBody = iframe.contentDocument.body;
                if (iframeBody) {
                    iframeBody.addEventListener('scroll', function() {
                        lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
                    });
                }
            } catch (e) {
                console.log('設置 iframe 捲動同步失敗:', e);
            }
        }      

        // 為分析報告添加行追蹤
        function setupAnalysisLineTracking(panel, iframe, lineCount) {
            const wrapper = document.getElementById(`${panel}ContentWrapper`);
            const contentContainer = document.getElementById(`${panel}ContentContainer`);
            
            if (!wrapper || !contentContainer || !iframe) return;
            
            // 為整個容器添加滑鼠移動事件
            contentContainer.addEventListener('mousemove', function(e) {
                // 計算相對於容器的位置
                const rect = contentContainer.getBoundingClientRect();
                const relativeY = e.clientY - rect.top;
                
                // 考慮捲動位置
                let scrollTop = 0;
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow) {
                        scrollTop = iframeWindow.pageYOffset || 
                                iframeWindow.document.documentElement.scrollTop || 
                                iframeWindow.document.body.scrollTop || 0;
                    }
                } catch (e) {}
                
                // 計算行號
                const adjustedY = relativeY + scrollTop - 20; // 20px 是 padding
                const lineHeight = 20.8; // 1.6em * 13px
                const lineNum = Math.floor(adjustedY / lineHeight) + 1;
                
                if (lineNum > 0 && lineNum <= lineCount) {
                    window.currentFocusedLine = lineNum;
                    window.currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, lineNum);
                    
                    // 更新虛擬行 hover
                    const overlays = contentContainer.querySelectorAll('.analysis-line-overlay');
                    overlays.forEach(overlay => {
                        overlay.classList.remove('hover');
                    });
                    const currentOverlay = contentContainer.querySelector(`.analysis-line-overlay[data-line="${lineNum}"]`);
                    if (currentOverlay) {
                        currentOverlay.classList.add('hover');
                    }
                }
            });
            
            // 滑鼠離開時清除 hover
            contentContainer.addEventListener('mouseleave', function() {
                const overlays = contentContainer.querySelectorAll('.analysis-line-overlay');
                overlays.forEach(overlay => {
                    overlay.classList.remove('hover');
                });
            });
            
            // 處理 iframe 內的滑鼠事件
            try {
                const iframeDoc = iframe.contentDocument;
                if (iframeDoc) {
                    // 允許滑鼠事件穿透到父容器
                    iframeDoc.body.style.pointerEvents = 'auto';
                    
                    // 監聽 iframe 內的滑鼠移動
                    iframeDoc.addEventListener('mousemove', function(e) {
                        // 創建一個對應的事件並傳遞到父容器
                        const parentEvent = new MouseEvent('mousemove', {
                            clientX: e.clientX + iframe.getBoundingClientRect().left,
                            clientY: e.clientY + iframe.getBoundingClientRect().top,
                            bubbles: true
                        });
                        contentContainer.dispatchEvent(parentEvent);
                    });
                }
            } catch (e) {
                console.log('無法設置 iframe 內事件:', e);
            }
        }

        function setupScrollSync(panel) {
            const contentContainer = document.getElementById(`${panel}ContentContainer`);
            const lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            if (contentContainer && lineNumbers) {
                contentContainer.addEventListener('scroll', function() {
                    lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
                });
            }
        }

        // 設置內容行追蹤（完全重寫）
        function setupContentLineTracking(panel) {
            const contentLines = document.querySelectorAll(`#${panel}ContentArea .content-line`);
            
            contentLines.forEach((line, index) => {
                if (!line.getAttribute('data-line')) {
                    line.setAttribute('data-line', index + 1);
                }
                
                const lineNum = parseInt(line.getAttribute('data-line'));
                
                // 滑鼠移動時更新焦點
                line.addEventListener('mousemove', function(e) {
                    e.stopPropagation();
                    // 只在滑鼠真正移動時更新，避免被其他操作干擾
                    if (e.movementX !== 0 || e.movementY !== 0) {
                        window.currentFocusedLine = lineNum;
                        window.currentFocusedPanel = panel;
                        highlightCurrentLineNumber(panel, lineNum);
                    }
                });
                
                line.addEventListener('mouseenter', function(e) {
                    e.stopPropagation();
                    window.currentFocusedLine = lineNum;
                    window.currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, lineNum);
                });
            });
            
            // 行號的滑鼠事件
            const lineNumbers = document.querySelectorAll(`#${panel}LineNumbers .line-number`);
            lineNumbers.forEach((lineNumEl, index) => {
                if (!lineNumEl.getAttribute('data-line')) {
                    lineNumEl.setAttribute('data-line', index + 1);
                }
                if (!lineNumEl.getAttribute('data-panel')) {
                    lineNumEl.setAttribute('data-panel', panel);
                }
                
                const lineNum = parseInt(lineNumEl.getAttribute('data-line'));
                
                lineNumEl.addEventListener('mouseenter', function(e) {
                    e.stopPropagation();
                    window.currentFocusedLine = lineNum;
                    window.currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, lineNum);
                });
            });
        }         

        // 設置內容右鍵選單
        function setupContentContextMenu(panel) {
            const contentArea = document.getElementById(`${panel}ContentArea`);
            if (contentArea) {
                contentArea.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    
                    // 設置當前面板
                    contextMenuManager.currentPanel = panel;
                    highlightManager.currentPanel = panel;
                    window.currentFocusedPanel = panel;
                    
                    // 獲取選擇
                    const selection = window.getSelection();
                    highlightManager.selectedText = selection.toString();
                    contextMenuManager.currentSelection = selection;
                    
                    if (selection.rangeCount > 0) {
                        highlightManager.selectedRange = selection.getRangeAt(0);
                    }
                    
                    contextMenuManager.show(e.clientX, e.clientY);
                });
            }
        }       

        // 為表格佈局設置右鍵選單
        function setupContextMenuForTable(panel) {
            // 確保元素存在
            const wrapper = document.getElementById(`${panel}ContentWrapper`);
            if (!wrapper) {
                console.log(`找不到 ${panel}ContentWrapper`);
                return;
            }
            
            const contentCells = wrapper.querySelectorAll('.content-cell');
            contentCells.forEach(cell => {
                if (cell) {
                    contextMenuManager.setupForElement(cell);
                }
            });
        }

        // 高亮當前行號
        function highlightCurrentLineNumber(panel, lineNumber) {
            
            if (panel === 'left' && currentLeftType === 'analysis') {
                const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                if (lineNumbers && lineNumbers.className === 'analysis-line-numbers') {
                    // 清除之前的高亮
                    lineNumbers.querySelectorAll('.analysis-line-number').forEach(el => {
                        if (!el.classList.contains('bookmarked')) {
                            el.style.backgroundColor = '';
                        }
                    });
                    
                    // 高亮當前行
                    const lineElement = lineNumbers.querySelector(`.analysis-line-number[data-line="${lineNumber}"]`);
                    if (lineElement && !lineElement.classList.contains('bookmarked')) {
                        lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
                    }
                    return;
                }
            }
                        
            // 嘗試新結構
            let lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            // 如果新結構不存在，嘗試舊結構
            if (!lineNumbers) {
                const wrapper = document.getElementById(`${panel}ContentWrapper`);
                if (wrapper) {
                    // 清除該面板之前的高亮
                    wrapper.querySelectorAll('.line-number').forEach(el => {
                        if (!el.classList.contains('bookmarked')) {
                            el.style.backgroundColor = '';
                        }
                    });
                    
                    // 高亮當前行號
                    const lineElement = wrapper.querySelector(`.line-number[data-line="${lineNumber}"]`);
                    if (lineElement && !lineElement.classList.contains('bookmarked')) {
                        lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
                    }
                }
                return;
            }
            
            // 新結構的處理
            lineNumbers.querySelectorAll('.line-number').forEach(el => {
                if (!el.classList.contains('bookmarked')) {
                    el.style.backgroundColor = '';
                }
            });
            
            const lineElement = lineNumbers.querySelector(`.line-number[data-line="${lineNumber}"]`);
            if (lineElement && !lineElement.classList.contains('bookmarked')) {
                lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
            }
        }

        // 清除行號高亮
        function clearLineNumberHighlight(panel) {
            document.querySelectorAll(`#${panel}LineNumbers .line-number`).forEach(el => {
                el.style.backgroundColor = '';
            });
        }

        // 顯示錯誤
        function showError(panel, message) {
            const contentEl = document.getElementById(panel + 'Content');
            contentEl.innerHTML = `<div class="error-message">❌ ${escapeHtml(message)}</div>`;
        }
        
        // 切換原始檔案面板
        function toggleOriginalPanel() {
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const resizeHandle = document.getElementById('resizeHandle');
            const btn = document.getElementById('toggleOriginalBtn');
            
            if (rightPanel.classList.contains('hidden')) {
                // 顯示右側面板
                rightPanel.classList.remove('hidden');
                resizeHandle.classList.remove('hidden');
                
                // 設定為 50%/50% 比例
                leftPanel.style.flex = '0 0 calc(50% - 2.5px)';
                rightPanel.style.flex = '0 0 calc(50% - 2.5px)';
                
                // 載入原始檔案
                if (!isOriginalLoaded) {
                    loadOriginalContent();
                }
                
                // 更新按鈕文字
                btn.innerHTML = '<span>📄</span><span>隱藏原始檔案</span>';
                document.getElementById('switchPanelsBtn').style.display = 'inline-flex';
            } else {
                // 隱藏右側面板
                rightPanel.classList.add('hidden');
                resizeHandle.classList.add('hidden');
                
                // 左側面板恢復全寬
                leftPanel.style.flex = '1';
                
                // 更新按鈕文字
                btn.innerHTML = '<span>📄</span><span>查看原始檔案</span>';
                document.getElementById('switchPanelsBtn').style.display = 'none';
            }
        }
        
        // 切換左右面板內容
        function switchPanels() {
            // 確保右側面板已經開啟
            const rightPanel = document.getElementById('rightPanel');
            if (rightPanel.classList.contains('hidden')) {
                updateStatus('請先開啟原始檔案視窗');
                return;
            }
            
            // 交換內容類型
            const tempType = currentLeftType;
            currentLeftType = currentRightType;
            currentRightType = tempType;
            
            // 重新顯示內容
            if (currentLeftType === 'analysis') {
                displayContent('left', analysisContent, 'analysis');
            } else {
                displayContent('left', originalContent, 'original');
            }
            
            if (currentRightType === 'analysis') {
                displayContent('right', analysisContent, 'analysis');
            } else {
                displayContent('right', originalContent, 'original');
            }
            
            // 更新標題
            updatePanelTitles();
            
            updateStatus('已切換面板內容');
        }
        
        // 更新面板標題
        function updatePanelTitles() {
            const leftIcon = document.getElementById('leftPanelIcon');
            const leftTitle = document.getElementById('leftPanelTitle');
            const rightIcon = document.getElementById('rightPanelIcon');
            const rightTitle = document.getElementById('rightPanelTitle');
            
            if (currentLeftType === 'analysis') {
                leftIcon.textContent = '📊';
                leftTitle.textContent = '分析報告';
            } else {
                leftIcon.textContent = '📄';
                leftTitle.textContent = '原始檔案';
            }
            
            if (currentRightType === 'analysis') {
                rightIcon.textContent = '📊';
                rightTitle.textContent = '分析報告';
            } else {
                rightIcon.textContent = '📄';
                rightTitle.textContent = '原始檔案';
            }
        }
        
        // 切換全屏（指定面板）
        function toggleFullscreen(panel) {
            const panelEl = document.getElementById(panel + 'Panel');
            
            if (panelEl.classList.contains('fullscreen')) {
                panelEl.classList.remove('fullscreen');
            } else {
                // 先關閉其他全屏
                document.querySelectorAll('.fullscreen').forEach(el => {
                    el.classList.remove('fullscreen');
                });
                panelEl.classList.add('fullscreen');
            }
        }
        
        // 切換全屏模式（整個應用）
        function toggleFullscreenMode() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // 關閉面板
        function closePanel(panel) {
            if (panel === 'right') {
                toggleOriginalPanel();
            }
        }
        
        // 切換匯出選單
        function toggleExportMenu(panel) {
            const menu = document.getElementById(panel + 'ExportMenu');
            const otherMenu = document.getElementById(panel === 'left' ? 'rightExportMenu' : 'leftExportMenu');
            
            // 關閉另一個選單
            if (otherMenu) {
                otherMenu.classList.remove('show');
            }
            
            // 切換當前選單
            menu.classList.toggle('show');
        }
        
        // 關閉所有匯出選單
        function closeAllExportMenus() {
            document.querySelectorAll('.export-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        // 匯出內容
        async function exportContent(panel, format) {
            closeAllExportMenus();
            
            // 確保內容已載入
            if (panel === 'left' && !analysisContent) {
                updateStatus('請等待分析報告載入完成後再匯出');
                return;
            }
            
            if (panel === 'right' && !originalContent) {
                updateStatus('請等待原始檔案載入完成後再匯出');
                return;
            }
            
            // 根據當前面板顯示的內容類型來決定匯出什麼
            let content = '';
            let contentType = '';
            
            if (panel === 'left') {
                content = (currentLeftType === 'analysis') ? analysisContent : originalContent;
                contentType = currentLeftType;
            } else {
                content = (currentRightType === 'analysis') ? analysisContent : originalContent;
                contentType = currentRightType;
            }
            
            // 確保有內容可匯出
            if (!content) {
                updateStatus('沒有內容可供匯出');
                return;
            }
            
            const filename = filePath.split('/').pop().replace(/\.[^/.]+$/, '');
            
            updateStatus(`正在匯出為 ${format.toUpperCase()} 格式...`);
            
            try {
                const response = await fetch('/api/export-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        format: format,
                        filename: filename,
                        contentType: contentType
                    })
                });
                
                if (response.ok) {
                    // 下載檔案
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // 從 Content-Disposition header 獲取檔名
                    const contentDisposition = response.headers.get('content-disposition');
                    let downloadFilename = `${filename}_${format}.${format}`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?(.+?)"?$/);
                        if (filenameMatch) {
                            downloadFilename = filenameMatch[1];
                        }
                    }
                    
                    a.download = downloadFilename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    updateStatus('匯出成功');
                } else {
                    const error = await response.json();
                    updateStatus('匯出失敗: ' + (error.error || '未知錯誤'));
                }
            } catch (error) {
                updateStatus('匯出失敗: ' + error.message);
            }
        }
        
        // 設置調整大小處理
        function setupResizeHandler() {
            const resizeHandle = document.getElementById('resizeHandle');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const mainContainer = document.getElementById('mainContainer');
            
            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            
            // 創建一個覆蓋層來防止 iframe 干擾
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.zIndex = '9999';
            overlay.style.cursor = 'col-resize';
            overlay.style.display = 'none';
            overlay.style.userSelect = 'none';
            document.body.appendChild(overlay);
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startLeftWidth = leftPanel.offsetWidth;
                
                // 顯示覆蓋層
                overlay.style.display = 'block';
                
                // 防止文字選擇
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.mozUserSelect = 'none';
                document.body.style.msUserSelect = 'none';
                
                // 禁用 iframe 的指標事件
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.style.pointerEvents = 'none';
                });
                
                e.preventDefault();
                e.stopPropagation();
            });
            
            // 在 overlay 和 document 上監聽事件
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const deltaX = e.clientX - startX;
                const newLeftWidth = startLeftWidth + deltaX;
                const containerWidth = mainContainer.offsetWidth - 5; // 減去 resize handle 的寬度
                const minWidth = 200;
                const maxWidth = containerWidth - minWidth;
                
                if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                    const leftPercent = (newLeftWidth / containerWidth) * 100;
                    const rightPercent = 100 - leftPercent;
                    
                    leftPanel.style.flex = `0 0 calc(${leftPercent}% - 2.5px)`;
                    rightPanel.style.flex = `0 0 calc(${rightPercent}% - 2.5px)`;
                }
            }
            
            function handleMouseUp(e) {
                if (!isResizing) return;
                
                isResizing = false;
                
                // 隱藏覆蓋層
                overlay.style.display = 'none';
                
                // 恢復樣式
                document.body.style.cursor = 'default';
                document.body.style.userSelect = '';
                document.body.style.webkitUserSelect = '';
                document.body.style.mozUserSelect = '';
                document.body.style.msUserSelect = '';
                
                // 恢復 iframe 的指標事件
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.style.pointerEvents = 'auto';
                });
                
                e.preventDefault();
                e.stopPropagation();
            }
            
            // 同時在 document 和 overlay 上監聽
            document.addEventListener('mousemove', handleMouseMove);
            overlay.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            overlay.addEventListener('mouseup', handleMouseUp);
            
            // 處理滑鼠離開視窗的情況
            document.addEventListener('mouseleave', function(e) {
                if (isResizing) {
                    handleMouseUp(e);
                }
            });
            
            // 讓拖曳條更容易點擊
            resizeHandle.style.position = 'relative';
            resizeHandle.innerHTML = '<div style="position: absolute; left: -5px; right: -5px; top: 0; bottom: 0; cursor: col-resize;"></div>';
        }
        
        // 設置 iframe 的右鍵選單
        function setupIframeContextMenu(iframe, panel) {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc) {
                    // 設置右鍵選單
                    iframeDoc.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        
                        // 設置當前面板
                        highlightManager.currentPanel = panel;
                        window.currentFocusedPanel = panel;
                        contextMenuManager.currentPanel = panel;
                        
                        const selection = iframe.contentWindow.getSelection();
                        highlightManager.selectedText = selection.toString();
                        
                        // 記錄 iframe 和其選擇，供複製使用
                        contextMenuManager.currentIframe = iframe;
                        contextMenuManager.currentSelection = selection;
                        
                        if (selection.rangeCount > 0) {
                            highlightManager.selectedRange = selection.getRangeAt(0);
                        }
                        
                        // 計算在主視窗中的實際位置
                        const iframeRect = iframe.getBoundingClientRect();
                        const x = e.clientX + iframeRect.left;
                        const y = e.clientY + iframeRect.top;
                        
                        contextMenuManager.show(x, y);
                    });
                }
            } catch (e) {
                console.log('無法存取 iframe 內容:', e);
            }
        }

        // 設置 iframe 內部事件
        function setupIframeEvents(iframe, iframeDoc) {
            // 設置右鍵選單
            iframeDoc.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                const selection = iframe.contentWindow.getSelection();
                highlightManager.selectedText = selection.toString();
                
                if (selection.rangeCount > 0) {
                    highlightManager.selectedRange = selection.getRangeAt(0);
                }
                
                // 計算在主視窗中的實際位置
                const iframeRect = iframe.getBoundingClientRect();
                const x = e.clientX + iframeRect.left;
                const y = e.clientY + iframeRect.top;
                
                contextMenuManager.show(x, y);
            });
            
            // 處理 iframe 內的選擇事件
            iframeDoc.addEventListener('mouseup', function() {
                const selection = iframe.contentWindow.getSelection();
                if (selection.toString()) {
                    highlightManager.selectedText = selection.toString();
                    highlightManager.currentIframe = iframe;
                }
            });
        }

        // 設置鍵盤快捷鍵
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // ESC 退出全屏
                if (e.key === 'Escape') {
                    document.querySelectorAll('.fullscreen').forEach(el => {
                        el.classList.remove('fullscreen');
                    });
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                }
                
                // F2 - 在當前行加書籤
                if (e.key === 'F2') {
                    e.preventDefault();
                    
                    const panel = window.currentFocusedPanel || 'left';
                    const line = window.currentFocusedLine || 1;
                    
                    console.log(`F2 按下: Panel=${panel}, Line=${line}`);
                    
                    // 檢查面板是否可見
                    const panelEl = document.getElementById(`${panel}Panel`);
                    if (!panelEl || panelEl.classList.contains('hidden')) {
                        console.log('F2: 面板隱藏中');
                        return;
                    }
                    
                    // 查找行號元素 - 使用更寬鬆的選擇器
                    let lineElement = null;
                    
                    // 先嘗試精確匹配
                    lineElement = document.querySelector(`#${panel}LineNumbers .line-number[data-line="${line}"][data-panel="${panel}"]`);
                    
                    // 如果找不到，使用更寬鬆的選擇器
                    if (!lineElement) {
                        const lineNumbers = document.getElementById(`${panel}LineNumbers`);
                        if (lineNumbers) {
                            // 遍歷所有行號元素
                            const allLineNumbers = lineNumbers.querySelectorAll('.line-number');
                            for (let el of allLineNumbers) {
                                if (el.getAttribute('data-line') === String(line)) {
                                    lineElement = el;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (lineElement) {
                        // 確保元素有正確的 data-panel 屬性
                        if (!lineElement.getAttribute('data-panel')) {
                            lineElement.setAttribute('data-panel', panel);
                        }
                        toggleBookmark(lineElement);
                        updateStatus(`已在${panel === 'left' ? '左側' : '右側'}面板第 ${line} 行切換書籤`);
                    } else {
                        console.error(`F2: 找不到行號元素`, {
                            panel: panel,
                            line: line,
                            lineNumbersExists: !!document.getElementById(`${panel}LineNumbers`),
                            totalLines: document.querySelectorAll(`#${panel}LineNumbers .line-number`).length
                        });
                    }
                }

                // F3 - 跳轉到下一個書籤
                if (e.key === 'F3') {
                    e.preventDefault();
                    navigateBookmarks();
                }
                
                // 其他快捷鍵...
                if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    toggleOriginalPanel();
                }
                
                if (e.ctrlKey && e.key === 'w') {
                    e.preventDefault();
                    switchPanels();
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreenMode();
                }
            });
        }
        
        // 更新狀態
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // 更新載入時間
        function updateLoadTime() {
            const loadTime = Date.now() - startTime;
            document.getElementById('loadTime').textContent = `載入時間: ${loadTime}ms`;
        }
        
        // HTML 轉義
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // 確保 Unicode 字符正確顯示
            return div.innerHTML.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
                return '&#' + i.charCodeAt(0) + ';';
            });
        }
    </script>
    <script>
        // 設置行號處理器
        function setupLineNumberHandlers(panel) {
            const lineNumbersContainer = document.getElementById(`${panel}LineNumbersContainer`);
            
            if (!lineNumbersContainer) {
                console.log(`找不到 ${panel}LineNumbersContainer`);
                return;
            }
            
            // 使用事件委託處理動態生成的行號
            lineNumbersContainer.addEventListener('click', function(e) {
                const lineNum = e.target.closest('.line-number');
                if (lineNum) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleBookmark(lineNum);
                }
            });
            
            lineNumbersContainer.addEventListener('mouseenter', function(e) {
                const lineNum = e.target.closest('.line-number');
                if (lineNum) {
                    const line = parseInt(lineNum.getAttribute('data-line'));
                    window.currentFocusedLine = line;
                    window.currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, line);
                }
            }, true);
        }

        // 確保行號與內容同步捲動
        function syncLineNumbers(panel) {
            const wrapper = document.getElementById(`${panel}ContentWrapper`);
            const lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            if (wrapper && lineNumbers) {
                // 初始對齊
                const content = document.getElementById(`${panel}OriginalContent`);
                const computedStyle = window.getComputedStyle(content);
                const paddingTop = parseInt(computedStyle.paddingTop);
                
                lineNumbers.style.paddingTop = paddingTop + 'px';
                
                // 監聽捲動事件
                wrapper.addEventListener('scroll', function() {
                    lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
                });
            }
        }

        // 切換書籤
        function toggleBookmark(lineElement) {
            if (!lineElement) {
                console.error('toggleBookmark: lineElement is null');
                return;
            }
            
            const lineNumber = parseInt(lineElement.getAttribute('data-line'));
            const panel = lineElement.getAttribute('data-panel') || window.currentFocusedPanel;
            
            if (!lineNumber || !panel) {
                console.error('toggleBookmark: 缺少必要屬性', { lineNumber, panel });
                return;
            }
            
            const key = `${panel}-${lineNumber}`;
            
            if (bookmarks.has(key)) {
                bookmarks.delete(key);
                lineElement.classList.remove('bookmarked');
                updateStatus(`已移除書籤: ${panel === 'left' ? '左側' : '右側'}面板第 ${lineNumber} 行`);
            } else {
                bookmarks.add(key);
                lineElement.classList.add('bookmarked');
                updateStatus(`已新增書籤: ${panel === 'left' ? '左側' : '右側'}面板第 ${lineNumber} 行`);
            }
            
            // 重置對應面板的索引
            if (panel === 'left') {
                leftBookmarkIndex = -1;
            } else {
                rightBookmarkIndex = -1;
            }
        }

        // 更新書籤陣列
        function updateBookmarkArray() {
            bookmarkArray = Array.from(bookmarks).sort((a, b) => {
                const [panelA, lineA] = a.split('-');
                const [panelB, lineB] = b.split('-');
                if (panelA === panelB) {
                    return parseInt(lineA) - parseInt(lineB);
                }
                return panelA.localeCompare(panelB);
            });
        }

        // 高亮當前行
        function highlightCurrentLine(panel, lineIndex) {
            // 這個功能可以選擇性實現
        }

        // 高亮選中的文字（只在當前面板）
        function highlightSelection(colorIndex) {
            if (!this.selectedText) return;
            
            // 確定當前面板
            const panel = this.currentPanel || window.currentFocusedPanel || 'left';
            
            // 清除該面板之前同顏色的高亮
            if (this.panelHighlights[panel][colorIndex]) {
                this.clearHighlightColorInPanel(panel, colorIndex);
            }
            
            this.panelHighlights[panel][colorIndex] = this.selectedText;
            
            // 只在當前面板高亮
            this.highlightInPanel(panel, this.selectedText, colorIndex);
            
            // 顯示高亮控制按鈕（如果在右側面板）
            if (panel === 'right') {
                document.getElementById(`highlightBtn${colorIndex}`).style.display = 'block';
            }
            
            hideContextMenu();
            window.getSelection().removeAllRanges();
        }

        function hideContextMenu() {
            if (contextMenuManager && contextMenuManager.menu) {
                contextMenuManager.hide();
            }
        }

        // 在特定面板中高亮
        function highlightInPanel(panel, text, colorIndex) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'original') {
                // 處理原始檔案
                const contentArea = document.getElementById(`${panel}ContentArea`);
                if (contentArea) {
                    const contentLines = contentArea.querySelectorAll('.content-line');
                    contentLines.forEach(line => {
                        this.highlightInNode(line, text, colorIndex);
                    });
                }
            } else if (panelType === 'analysis') {
                // 處理分析報告（iframe）- 保持原樣
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentDocument) {
                    try {
                        this.injectHighlightStyles(iframe);
                        const iframeBody = iframe.contentDocument.body;
                        if (iframeBody) {
                            this.highlightInElement(iframeBody, text, colorIndex);
                        }
                    } catch (e) {
                        console.log('無法存取 iframe 內容:', e);
                    }
                }
            }
        }

        // 清除特定面板特定顏色的高亮
        function clearHighlightColorInPanel(panel, colorIndex) {
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'original') {
                // 清除原始檔案的高亮
                document.querySelectorAll(`#${panel}ContentWrapper .highlight-${colorIndex}`).forEach(element => {
                    const parent = element.parentNode;
                    const textNode = document.createTextNode(element.textContent);
                    parent.replaceChild(textNode, element);
                    parent.normalize();
                });
            } else if (panelType === 'analysis') {
                // 清除 iframe 中的高亮
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentDocument) {
                    iframe.contentDocument.querySelectorAll(`.highlight-${colorIndex}`).forEach(element => {
                        const parent = element.parentNode;
                        const textNode = iframe.contentDocument.createTextNode(element.textContent);
                        parent.replaceChild(textNode, element);
                        parent.normalize();
                    });
                }
            }
            
            this.panelHighlights[panel][colorIndex] = null;
            
            // 如果是右側面板，更新按鈕顯示
            if (panel === 'right') {
                // 檢查是否還有其他高亮
                let hasHighlight = false;
                for (let i = 1; i <= 5; i++) {
                    if (this.panelHighlights[panel][i]) {
                        hasHighlight = true;
                        break;
                    }
                }
                if (!hasHighlight || !this.panelHighlights[panel][colorIndex]) {
                    document.getElementById(`highlightBtn${colorIndex}`).style.display = 'none';
                }
            }
        }   

        // 高亮所有出現的文字
        function highlightAllOccurrences(text, colorIndex) {
            // 處理左右面板
            ['left', 'right'].forEach(panel => {
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                if (panelType === 'original') {
                    // 處理原始檔案（表格佈局）
                    const wrapper = document.getElementById(`${panel}ContentWrapper`);
                    if (wrapper) {
                        const contentCells = wrapper.querySelectorAll('.content-cell');
                        contentCells.forEach(cell => {
                            this.highlightInNode(cell, text, colorIndex);
                        });
                    }
                } else if (panelType === 'analysis') {
                    // 處理分析報告（iframe）
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentDocument) {
                        try {
                            // 注入高亮樣式到 iframe
                            this.injectHighlightStyles(iframe);
                            
                            // 高亮 iframe 內容
                            const iframeBody = iframe.contentDocument.body;
                            if (iframeBody) {
                                this.highlightInElement(iframeBody, text, colorIndex);
                            }
                        } catch (e) {
                            console.log('無法存取 iframe 內容:', e);
                        }
                    }
                }
            });
        }

        // 注入高亮樣式到 iframe
        function injectHighlightStyles(iframe) {
            try {
                const iframeDoc = iframe.contentDocument;
                if (!iframeDoc.getElementById('highlight-styles')) {
                    const style = iframeDoc.createElement('style');
                    style.id = 'highlight-styles';
                    style.textContent = `
                        /* 基本樣式 */
                        body {
                            line-height: 1.6em;
                            margin: 0;
                            padding: 20px;
                            font-size: 13px;
                            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                            overflow-y: auto;
                            overflow-x: auto;
                        }
                        
                        /* 統一捲軸樣式 - 與右側相同 */
                        ::-webkit-scrollbar {
                            height: 8px;
                            width: 8px;
                        }
                        
                        ::-webkit-scrollbar-track {
                            background: #1a1a1a;
                        }
                        
                        ::-webkit-scrollbar-thumb {
                            background: #444;
                            border-radius: 4px;
                        }
                        
                        ::-webkit-scrollbar-thumb:hover {
                            background: #555;
                        }
                        
                        /* Firefox 捲軸 */
                        * {
                            scrollbar-width: thin;
                            scrollbar-color: #444 #1a1a1a;
                        }
                        
                        /* 其他樣式 */
                        pre, .report-line {
                            line-height: 1.6em;
                            font-size: 13px;
                            margin: 0;
                        }
                        
                        /* 高亮樣式 */
                        .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; }
                        .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; }
                        .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; }
                        .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; }
                        .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; }
                    `;
                    iframeDoc.head.appendChild(style);
                }
            } catch (e) {
                console.log('無法注入樣式:', e);
            }
        }

        // 在元素中高亮文字
        function highlightInElement(element, text, colorIndex) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        // 跳過已經高亮的節點
                        if (node.parentElement && node.parentElement.className && 
                            node.parentElement.className.includes('highlight-')) {
                            return NodeFilter.FILTER_REJECT;
                        }
                        return NodeFilter.FILTER_ACCEPT;
                    }
                },
                false
            );
            
            const textNodes = [];
            let node;
            
            while (node = walker.nextNode()) {
                if (node.nodeValue && node.nodeValue.includes(text)) {
                    textNodes.push(node);
                }
            }
            
            textNodes.forEach(textNode => {
                const parent = textNode.parentNode;
                const content = textNode.nodeValue;
                
                // 創建正則表達式，支援大小寫
                const regex = new RegExp(this.escapeRegExp(text), 'gi');
                const matches = content.match(regex);
                
                if (matches && matches.length > 0) {
                    const parts = content.split(regex);
                    const fragment = document.createDocumentFragment();
                    
                    parts.forEach((part, i) => {
                        if (part) {
                            fragment.appendChild(document.createTextNode(part));
                        }
                        if (i < parts.length - 1 && i < matches.length) {
                            const span = document.createElement('span');
                            span.className = `highlight-${colorIndex}`;
                            span.textContent = matches[i];
                            fragment.appendChild(span);
                        }
                    });
                    
                    parent.replaceChild(fragment, textNode);
                }
            });
        }

        // 清除特定顏色的高亮（只清除右側面板）
        function clearHighlightColor(colorIndex, panel) {
            panel = panel || window.currentFocusedPanel || 'right';
            highlightManager.clearHighlightColorInPanel(panel, colorIndex);
        }

        // 清除所有高亮
        function clearAllHighlights() {
            const panel = highlightManager.currentPanel || window.currentFocusedPanel || 'left';
            for (let i = 1; i <= 5; i++) {
                highlightManager.clearHighlightColorInPanel(panel, i);
            }
            hideContextMenu();
        }

        // 輔助函數：轉義正則表達式
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // 在書籤間導航
        function navigateBookmarks() {
            // 取得當前焦點面板
            const currentPanel = window.currentFocusedPanel || 'left';
            
            if (bookmarks.size === 0) {
                updateStatus('沒有書籤');
                return;
            }
            
            // 更新書籤陣列，但只包含當前面板的書籤
            const panelBookmarks = Array.from(bookmarks).filter(key => key.startsWith(currentPanel + '-'));
            
            if (panelBookmarks.length === 0) {
                updateStatus(`${currentPanel === 'left' ? '左側' : '右側'}面板沒有書籤`);
                return;
            }
            
            // 排序書籤（按行號）
            panelBookmarks.sort((a, b) => {
                const lineA = parseInt(a.split('-')[1]);
                const lineB = parseInt(b.split('-')[1]);
                return lineA - lineB;
            });
            
            // 獲取並更新當前面板的索引
            let currentIndex = currentPanel === 'left' ? leftBookmarkIndex : rightBookmarkIndex;
            currentIndex++;
            if (currentIndex >= panelBookmarks.length) {
                currentIndex = 0;
            }
            
            // 更新對應面板的索引
            if (currentPanel === 'left') {
                leftBookmarkIndex = currentIndex;
            } else {
                rightBookmarkIndex = currentIndex;
            }
            
            const bookmarkKey = panelBookmarks[currentIndex];
            const [panel, line] = bookmarkKey.split('-');
            
            console.log(`F3 導航到書籤: ${bookmarkKey}, 索引: ${currentIndex + 1}/${panelBookmarks.length}`);
            
            // 查找行號元素
            const lineElement = document.querySelector(`#${panel}LineNumbers .line-number[data-line="${line}"]`);
            if (!lineElement) {
                console.error('F3: 找不到行號元素', { panel, line });
                return;
            }
            
            // 檢查面板類型
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'original') {
                // 原始檔案 - 查找內容行並捲動（保持原有邏輯）
                const targetElement = document.querySelector(`#${panel}ContentArea .content-line[data-line="${line}"]`);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            } else {
                // 分析報告 - 使用動態行高數據捲動
                const lineData = window[`${panel}LineData`];
                if (lineData) {
                    const targetLine = lineData.find(data => data.index === parseInt(line));
                    if (targetLine) {
                        const iframe = document.querySelector(`#${panel}Content iframe`);
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.scrollTo({
                                top: targetLine.top - 100, // 留一些上方空間
                                behavior: 'smooth'
                            });
                        }
                    }
                } else {
                    // 備用方案：使用固定行高
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentWindow) {
                        const lineHeight = 20.8;
                        const scrollTop = (parseInt(line) - 1) * lineHeight;
                        iframe.contentWindow.scrollTo({
                            top: scrollTop,
                            behavior: 'smooth'
                        });
                    }
                }
            }
            
            // 閃爍效果
            if (lineElement) {
                lineElement.style.transition = 'background-color 0.3s';
                const originalBg = lineElement.style.backgroundColor;
                lineElement.style.backgroundColor = '#4ec9b0';
                setTimeout(() => {
                    lineElement.style.backgroundColor = originalBg;
                }, 500);
            }
            
            updateStatus(`${panel === 'left' ? '左側' : '右側'}面板書籤 ${currentIndex + 1}/${panelBookmarks.length}: 第 ${line} 行`);
        }        

        // 監聽面板的焦點切換
        document.getElementById('leftPanel').addEventListener('mouseenter', function() {
            window.currentFocusedPanel = 'left';
        });

        document.getElementById('rightPanel').addEventListener('mouseenter', function() {
            window.currentFocusedPanel = 'right';
        });

        // 點擊面板時也更新焦點
        document.getElementById('leftPanel').addEventListener('click', function() {
            window.currentFocusedPanel = 'left';
        });

        document.getElementById('rightPanel').addEventListener('click', function() {
            window.currentFocusedPanel = 'right';
        });
    </script>
    <script>
        // 高亮管理器類別
        class HighlightManager {
            constructor() {
                // 每個面板的每個顏色可以儲存多個文字
                this.leftHighlights = { 
                    1: new Set(), 2: new Set(), 3: new Set(), 4: new Set(), 5: new Set() 
                };
                this.rightHighlights = { 
                    1: new Set(), 2: new Set(), 3: new Set(), 4: new Set(), 5: new Set() 
                };
                this.selectedText = '';
                this.selectedRange = null;
                this.currentPanel = null;
            }

            // 獲取面板的高亮資料
            getPanelHighlights(panel) {
                return panel === 'left' ? this.leftHighlights : this.rightHighlights;
            }

            // 高亮選中的文字（支援疊加）
            highlightSelection(colorIndex) {
                if (!this.selectedText) return;
                
                // 確定當前面板
                const panel = this.currentPanel || window.currentFocusedPanel || 'left';
                const highlights = this.getPanelHighlights(panel);
                
                // 添加文字到該顏色的集合中（不清除之前的）
                highlights[colorIndex].add(this.selectedText);
                
                // 高亮所有該顏色的文字
                this.refreshHighlightsInPanel(panel);
                
                // 更新高亮控制按鈕顯示
                this.updateHighlightButtons(panel);
                
                hideContextMenu();
                window.getSelection().removeAllRanges();
            }

            // 刷新面板中的所有高亮
            refreshHighlightsInPanel(panel) {
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                // 先清除所有高亮
                this.clearAllHighlightsInPanel(panel);
                
                // 重新應用所有高亮
                const highlights = this.getPanelHighlights(panel);
                for (let colorIndex = 1; colorIndex <= 5; colorIndex++) {
                    highlights[colorIndex].forEach(text => {
                        this.applyHighlight(panel, text, colorIndex, panelType);
                    });
                }
            }

            // 應用高亮
            applyHighlight(panel, text, colorIndex, panelType) {
                if (panelType === 'original') {
                    // 處理原始檔案
                    const contentArea = document.getElementById(`${panel}ContentArea`);
                    if (contentArea) {
                        const contentLines = contentArea.querySelectorAll('.content-line');
                        contentLines.forEach(line => {
                            this.highlightInNode(line, text, colorIndex);
                        });
                    }
                } else if (panelType === 'analysis') {
                    // 處理分析報告（iframe）
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentDocument) {
                        try {
                            this.injectHighlightStyles(iframe);
                            const iframeBody = iframe.contentDocument.body;
                            if (iframeBody) {
                                this.highlightInElement(iframeBody, text, colorIndex);
                            }
                        } catch (e) {
                            console.log('無法存取 iframe 內容:', e);
                        }
                    }
                }
            }

            // 清除面板中的所有高亮（DOM）
            clearAllHighlightsInPanel(panel) {
                const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                
                if (panelType === 'original') {
                    // 清除原始檔案的高亮
                    for (let i = 1; i <= 5; i++) {
                        const highlights = document.querySelectorAll(`#${panel}ContentArea .highlight-${i}`);
                        highlights.forEach(element => {
                            const parent = element.parentNode;
                            const textNode = document.createTextNode(element.textContent);
                            parent.replaceChild(textNode, element);
                            parent.normalize();
                        });
                    }
                } else if (panelType === 'analysis') {
                    // 清除 iframe 中的高亮
                    const iframe = document.querySelector(`#${panel}Content iframe`);
                    if (iframe && iframe.contentDocument) {
                        for (let i = 1; i <= 5; i++) {
                            const highlights = iframe.contentDocument.querySelectorAll(`.highlight-${i}`);
                            highlights.forEach(element => {
                                const parent = element.parentNode;
                                const textNode = iframe.contentDocument.createTextNode(element.textContent);
                                parent.replaceChild(textNode, element);
                                parent.normalize();
                            });
                        }
                    }
                }
            }

            // 在節點中高亮文字
            highlightInNode(node, text, colorIndex) {
                if (!node || !text || !node.textContent.includes(text)) return;
                
                // 獲取所有文字節點
                const walker = document.createTreeWalker(
                    node,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let textNode;
                while (textNode = walker.nextNode()) {
                    if (textNode.nodeValue.includes(text)) {
                        textNodes.push(textNode);
                    }
                }
                
                // 處理每個文字節點
                textNodes.forEach(textNode => {
                    const parent = textNode.parentNode;
                    if (parent.className && parent.className.includes('highlight-')) {
                        return; // 跳過已經高亮的
                    }
                    
                    const content = textNode.nodeValue;
                    const regex = new RegExp(this.escapeRegExp(text), 'gi');
                    const matches = content.match(regex);
                    
                    if (matches && matches.length > 0) {
                        const parts = content.split(regex);
                        const fragment = document.createDocumentFragment();
                        
                        parts.forEach((part, i) => {
                            if (part) {
                                fragment.appendChild(document.createTextNode(part));
                            }
                            if (i < parts.length - 1 && i < matches.length) {
                                const span = document.createElement('span');
                                span.className = `highlight-${colorIndex}`;
                                span.textContent = matches[i];
                                fragment.appendChild(span);
                            }
                        });
                        
                        parent.replaceChild(fragment, textNode);
                    }
                });
            }

            // 在元素中高亮文字（支援 iframe）
            highlightInElement(element, text, colorIndex) {
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function(node) {
                            // 跳過已經高亮的節點
                            if (node.parentElement && node.parentElement.className && 
                                node.parentElement.className.includes('highlight-')) {
                                return NodeFilter.FILTER_REJECT;
                            }
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    },
                    false
                );
                
                const textNodes = [];
                let node;
                
                while (node = walker.nextNode()) {
                    if (node.nodeValue && node.nodeValue.includes(text)) {
                        textNodes.push(node);
                    }
                }
                
                textNodes.forEach(textNode => {
                    const parent = textNode.parentNode;
                    const content = textNode.nodeValue;
                    
                    const regex = new RegExp(this.escapeRegExp(text), 'gi');
                    const matches = content.match(regex);
                    
                    if (matches && matches.length > 0) {
                        const parts = content.split(regex);
                        const fragment = document.createDocumentFragment();
                        
                        parts.forEach((part, i) => {
                            if (part) {
                                fragment.appendChild(document.createTextNode(part));
                            }
                            if (i < parts.length - 1 && i < matches.length) {
                                const span = document.createElement('span');
                                span.className = `highlight-${colorIndex}`;
                                span.textContent = matches[i];
                                fragment.appendChild(span);
                            }
                        });
                        
                        parent.replaceChild(fragment, textNode);
                    }
                });
            }

            // 注入高亮樣式到 iframe
            injectHighlightStyles(iframe) {
                try {
                    const iframeDoc = iframe.contentDocument;
                    if (!iframeDoc.getElementById('highlight-styles')) {
                        const style = iframeDoc.createElement('style');
                        style.id = 'highlight-styles';
                        style.textContent = `
                            .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; }
                            .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; }
                            .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; }
                            .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; }
                            .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; }
                        `;
                        iframeDoc.head.appendChild(style);
                    }
                } catch (e) {
                    console.log('無法注入樣式:', e);
                }
            }

            // 清除特定面板特定顏色的高亮
            clearHighlightColorInPanel(panel, colorIndex) {
                const highlights = this.getPanelHighlights(panel);
                
                // 清除該顏色的所有文字
                highlights[colorIndex].clear();
                
                // 刷新面板高亮
                this.refreshHighlightsInPanel(panel);
                
                // 更新高亮控制按鈕顯示
                this.updateHighlightButtons(panel);
            }

            // 清除特定顏色的高亮
            clearHighlightColor(colorIndex) {
                const panel = window.currentFocusedPanel || 'right';
                this.clearHighlightColorInPanel(panel, colorIndex);
            }

            // 更新高亮控制按鈕顯示
            updateHighlightButtons(panel) {
                const highlights = this.getPanelHighlights(panel);
                
                for (let i = 1; i <= 5; i++) {
                    // 根據面板選擇正確的按鈕
                    const btnId = panel === 'left' ? `leftHighlightBtn${i}` : `highlightBtn${i}`;
                    const btn = document.getElementById(btnId);
                    
                    if (btn) {
                        // 如果該顏色有任何高亮文字，顯示按鈕
                        btn.style.display = highlights[i].size > 0 ? 'block' : 'none';
                    }
                }
            }

            // 輔助函數
            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        }
        
        // 建立全域高亮管理器實例
        const highlightManager = new HighlightManager();      
    </script>
    <script>
        // 右鍵選單管理器
        class ContextMenuManager {
            constructor() {
                this.menu = null;
                this.setupMenu();
            }

            setupMenu() {
                // 檢查是否已存在選單
                this.menu = document.getElementById('contextMenu');
                if (!this.menu) {
                    this.createMenu();
                }
            }

            createMenu() {
                const menu = document.createElement('div');
                menu.id = 'contextMenu';
                menu.className = 'context-menu';
                menu.innerHTML = `
                    <div class="context-menu-item" onclick="contextMenuManager.copyText()">
                        <span>📋</span> 複製
                    </div>
                    <div class="context-menu-item" onclick="contextMenuManager.selectAll()">
                        <span>🔲</span> 全選
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(1)">
                        <div class="color-box" style="background: #ffff00;"></div>
                        <span>高亮 1 (黃色)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(2)">
                        <div class="color-box" style="background: #00ff00;"></div>
                        <span>高亮 2 (綠色)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(3)">
                        <div class="color-box" style="background: #00bfff;"></div>
                        <span>高亮 3 (藍色)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(4)">
                        <div class="color-box" style="background: #ffa500;"></div>
                        <span>高亮 4 (橙色)</span>
                    </div>
                    <div class="context-menu-item" onclick="highlightManager.highlightSelection(5)">
                        <div class="color-box" style="background: #ffc0cb;"></div>
                        <span>高亮 5 (粉紅)</span>
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="clearAllHighlights()">
                        <span>清除所有高亮</span>
                    </div>
                `;
                document.body.appendChild(menu);
                this.menu = menu;
            }

            show(x, y) {
                // 先顯示選單以獲取尺寸
                this.menu.style.display = 'block';
                this.menu.style.visibility = 'hidden'; // 暫時隱藏避免閃爍
                
                // 獲取選單和視窗尺寸
                const menuRect = this.menu.getBoundingClientRect();
                const menuWidth = menuRect.width;
                const menuHeight = menuRect.height;
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // 計算調整後的位置
                let adjustedX = x;
                let adjustedY = y;
                
                // 檢查右邊界
                if (x + menuWidth > windowWidth - 10) { // 留 10px 邊距
                    adjustedX = x - menuWidth; // 顯示在滑鼠左側
                    if (adjustedX < 10) { // 如果左側也不夠空間
                        adjustedX = windowWidth - menuWidth - 10; // 貼著右邊界
                    }
                }
                
                // 檢查下邊界
                if (y + menuHeight > windowHeight - 10) { // 留 10px 邊距
                    adjustedY = y - menuHeight; // 顯示在滑鼠上方
                    if (adjustedY < 10) { // 如果上方也不夠空間
                        adjustedY = windowHeight - menuHeight - 10; // 貼著下邊界
                    }
                }
                
                // 檢查左邊界
                if (adjustedX < 10) {
                    adjustedX = 10;
                }
                
                // 檢查上邊界
                if (adjustedY < 10) {
                    adjustedY = 10;
                }
                
                // 設定最終位置
                this.menu.style.left = adjustedX + 'px';
                this.menu.style.top = adjustedY + 'px';
                this.menu.style.visibility = 'visible'; // 顯示選單
                
                // 點擊其他地方關閉選單
                setTimeout(() => {
                    document.addEventListener('click', () => this.hide(), { once: true });
                }, 0);
            }

            hide() {
                this.menu.style.display = 'none';
            }

            copyText() {
                let textToCopy = '';
                let selection = null;
                
                // 優先使用當前的選擇
                if (this.currentPanel) {
                    const panelType = (this.currentPanel === 'left') ? currentLeftType : currentRightType;
                    
                    if (panelType === 'analysis' && this.currentIframe) {
                        // 分析報告的選擇
                        selection = this.currentIframe.contentWindow.getSelection();
                    } else {
                        // 原始檔案的選擇
                        selection = window.getSelection();
                    }
                } else {
                    selection = window.getSelection();
                }
                
                // 獲取選中的文字
                if (selection && selection.toString().trim()) {
                    textToCopy = selection.toString();
                } else {
                    // 如果沒有選中文字，複製整個面板內容
                    const panel = this.currentPanel || window.currentFocusedPanel || 'left';
                    const panelType = (panel === 'left') ? currentLeftType : currentRightType;
                    
                    if (panelType === 'analysis') {
                        const iframe = document.querySelector(`#${panel}Content iframe`);
                        if (iframe && iframe.contentDocument) {
                            try {
                                const iframeDoc = iframe.contentDocument;
                                const reportContent = iframeDoc.body;
                                if (reportContent) {
                                    textToCopy = reportContent.innerText || reportContent.textContent || '';
                                }
                            } catch (e) {
                                console.log('無法存取 iframe 內容:', e);
                            }
                        }
                    } else {
                        const contentArea = document.querySelector(`#${panel}ContentArea`);
                        if (contentArea) {
                            textToCopy = contentArea.innerText || contentArea.textContent || '';
                        }
                    }
                }
                
                if (textToCopy) {
                    // 使用 Clipboard API
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            updateStatus(selection && selection.toString() ? '已複製選中的文字' : '已複製面板內容');
                        }).catch(() => {
                            this.fallbackCopy(textToCopy);
                        });
                    } else {
                        this.fallbackCopy(textToCopy);
                    }
                }
                
                // 清理
                this.currentIframe = null;
                this.currentSelection = null;
                this.hide();
            }

            extractReportText(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // 嘗試找到報告內容區域
                const reportContent = tempDiv.querySelector('.report-content') || 
                                    tempDiv.querySelector('.analysis-content') ||
                                    tempDiv.querySelector('pre');
                
                if (reportContent) {
                    return reportContent.textContent || reportContent.innerText || '';
                }
                
                // 如果找不到特定區域，提取 body 內容
                const body = tempDiv.querySelector('body');
                if (body) {
                    return body.textContent || body.innerText || '';
                }
                
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            // 從 HTML 提取純文字的輔助方法
            extractTextFromHTML(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            // 備用複製方法
            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    updateStatus('已複製');
                }
            }

            selectAll() {
                if (window.currentFocusedPanel) {
                    const panel = document.getElementById(`${window.currentFocusedPanel}Content`);
                    if (panel) {
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        const range = document.createRange();
                        range.selectNodeContents(panel);
                        selection.addRange(range);
                    }
                }
                this.hide();
            }

            setupForElement(element, isIframe = false) {
                element.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    
                    // 確定當前是哪個面板
                    let panel = 'left';
                    if (element.closest('#rightContent') || element.closest('#rightPanel')) {
                        panel = 'right';
                    } else if (element.closest('#leftContent') || element.closest('#leftPanel')) {
                        panel = 'left';
                    }
                    
                    highlightManager.currentPanel = panel;
                    window.currentFocusedPanel = panel;
                    
                    const selection = isIframe ? 
                        element.contentWindow.getSelection() : 
                        window.getSelection();
                    
                    highlightManager.selectedText = selection.toString();
                    
                    if (selection.rangeCount > 0) {
                        highlightManager.selectedRange = selection.getRangeAt(0);
                    }
                    
                    // 計算實際的座標位置
                    let clientX = e.clientX;
                    let clientY = e.clientY;
                    
                    // 如果是 iframe，需要加上 iframe 的偏移量
                    if (isIframe) {
                        const iframeRect = element.getBoundingClientRect();
                        clientX = e.clientX + iframeRect.left;
                        clientY = e.clientY + iframeRect.top;
                    }
                    
                    this.show(clientX, clientY);
                });
            }
        }

        // 建立全域右鍵選單管理器實例
        const contextMenuManager = new ContextMenuManager();
    </script>
    <script>
        // 複製面板內容
        function copyPanelContent(panel) {
            let textContent = '';
            const panelType = (panel === 'left') ? currentLeftType : currentRightType;
            
            if (panelType === 'analysis') {
                // 嘗試從 iframe 中提取純文字
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentDocument) {
                    try {
                        const iframeDoc = iframe.contentDocument;
                        // 只提取報告內容，不包括UI元素
                        const reportContent = iframeDoc.querySelector('.report-content') || 
                                            iframeDoc.querySelector('.analysis-content') ||
                                            iframeDoc.querySelector('pre') ||
                                            iframeDoc.body;
                        
                        if (reportContent) {
                            textContent = reportContent.innerText || reportContent.textContent || '';
                        }
                    } catch (e) {
                        console.log('無法存取 iframe 內容:', e);
                        textContent = contextMenuManager.extractReportText(analysisContent);
                    }
                } else {
                    textContent = contextMenuManager.extractReportText(analysisContent);
                }
            } else {
                // 原始內容 - 只複製內容區域
                const contentArea = document.querySelector(`#${panel}ContentArea`);
                if (contentArea) {
                    textContent = contentArea.innerText || contentArea.textContent || '';
                } else {
                    textContent = originalContent;
                }
            }
            
            if (!textContent) {
                updateStatus('沒有內容可供複製');
                return;
            }
            
            // 使用 Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textContent).then(() => {
                    showPanelCopySuccess(panel);
                }).catch(() => {
                    fallbackPanelCopy(textContent, panel);
                });
            } else {
                fallbackPanelCopy(textContent, panel);
            }
        }

        // 顯示面板複製成功的動畫
        function showPanelCopySuccess(panel) {
            const iconElement = document.getElementById(`${panel}CopyIcon`);
            if (iconElement) {
                const originalIcon = iconElement.textContent;
                
                // 改成勾號
                iconElement.textContent = '✓';
                
                // 添加動畫效果
                iconElement.style.color = '#4ec9b0';
                iconElement.style.transform = 'scale(1.2)';
                iconElement.style.transition = 'all 0.2s ease';
                
                updateStatus('內容已複製到剪貼簿');
                
                // 0.5秒後恢復原始圖標
                setTimeout(() => {
                    iconElement.textContent = originalIcon;
                    iconElement.style.color = '';
                    iconElement.style.transform = '';
                }, 500);
            } else {
                updateStatus('內容已複製到剪貼簿');
            }
        }

        // 備用的面板複製方法
        function fallbackPanelCopy(text, panel) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            const success = document.execCommand('copy');
            document.body.removeChild(textarea);
            
            if (success) {
                showPanelCopySuccess(panel);
            } else {
                updateStatus('複製失敗');
            }
        }
    </script>  
</body>
</html>