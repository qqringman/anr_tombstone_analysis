<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ file_path }} - Android Log åˆ†æå ±å‘ŠæŸ¥çœ‹å™¨</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* é¢æ¿å…§å®¹å®¹å™¨ */
        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #0d0d0d;
        }

		/* å°‡åˆ†æå ±å‘Šä¸­çš„æ¨£å¼æå‡ç‚ºå…¨åŸŸæ¨£å¼ */
		.panel-content style {
			display: block !important;
		}    
		
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-hover: #333333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #444444;
            --accent-color: #4ec9b0;
            --header-height: 60px;
            --status-height: 30px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* é ‚éƒ¨å·¥å…·åˆ— */
        .header {
            height: var(--header-height);
            background: #1a1a1a;  /* æ”¹ç‚ºæ›´æ·±çš„é»‘è‰² */
            border-bottom: 1px solid #333333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: relative;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .file-info h1 {
            font-size: 18px;
            font-weight: 500;
        }
        
        .file-info p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            background: #2d2d2d;
            border: 1px solid #444444;
            color: #e0e0e0;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #3a3a3a;
            border-color: #666666;
        }
        
        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #3db89f;
        }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            height: calc(100vh - var(--header-height) - var(--status-height));
            display: flex;
            position: relative;
        }
        
        /* åˆ†å‰²é¢æ¿ */
        .split-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }
        
        .split-panel.hidden {
            display: none;
        }
        
        /* é¢æ¿é ­éƒ¨ */
        .panel-header {
            background: #1e1e1e;
            padding: 8px 12px;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-controls {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* é¢æ¿å…§å®¹ */
        .panel-content {
            flex: 1;
            overflow: hidden;  /* æ”¹ç‚º hiddenï¼Œä¸é¡¯ç¤ºæ²è»¸ */
            position: relative;
            background: var(--bg-primary);
        }

        /* iframe æ¨£å¼ */
        .panel-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* åˆ†æå ±å‘Šå…§å®¹æ¨£å¼ */
        .analysis-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* åŸå§‹å…§å®¹æ¨£å¼ */
        .original-content {
            flex: 1;
            padding: 20px 20px 0 20px; /* ç§»é™¤åº•éƒ¨ padding */
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            word-wrap: normal;
            color: #d4d4d4;
            background: transparent;
            min-width: max-content;
        }

        /* åœ¨æœ€å¾Œä¸€è¡Œå¾Œæ·»åŠ ä¸€äº›ç©ºé–“ */
        .original-content::after {
            content: '';
            display: block;
            height: 20px; /* åªåœ¨æœ€å¾Œæ·»åŠ ä¸€é»ç©ºé–“ */
        }

        .line-numbers::after {
            content: '';
            display: block;
            height: 20px; /* èˆ‡å…§å®¹å°é½Š */
        }

        /* åˆ†å‰²æ¢ */
        .resize-handle {
            width: 5px;
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
            /* å¢åŠ å¯é»æ“Šå€åŸŸ */
            margin: 0 3px;
            padding: 0 1px;
            z-index: 10;
        }
        
        .resize-handle:hover {
            background: var(--accent-color);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            left: -5px;
            right: -5px;
            top: 0;
            bottom: 0;
            cursor: col-resize;
        }

        .resize-handle.hidden {
            display: none;
        }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar {
            height: var(--status-height);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* å…¨å±æ¨¡å¼ */
        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .fullscreen .panel-content {
            height: calc(100% - 45px);
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .loading::before {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* åŒ¯å‡ºé¸å–® */
        .export-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 0;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }
        
        .export-menu.show {
            display: block;
        }
        
        .export-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-item:hover {
            background: var(--bg-hover);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .header {
                padding: 0 10px;
            }
            
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .btn span:not(:first-child) {
                display: none;
            }
            
            /* åœ¨æ‰‹æ©Ÿä¸Šé è¨­ä½¿ç”¨å–®æ¬„é¡¯ç¤º */
            .split-panel {
                flex: 1 !important;
            }
            
            .resize-handle {
                display: none !important;
            }
        }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            color: #ff6b6b;
            padding: 20px;
            text-align: center;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 6px;
            margin: 20px;
        }

        /* åˆ†æå ±å‘Šå…§å®¹æ¨£å¼ */
        .panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
            background: var(--bg-primary);
        }
        
        /* åˆ†æå ±å‘Šå®¹å™¨ */
        .analysis-wrapper {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
        }
        
        /* è¦†è“‹åˆ†æå ±å‘Šçš„æ¨£å¼ */
        .panel-content .report-content,
        .panel-content .report-line,
        .panel-content pre {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
            background: transparent;
        }
        
        .panel-content .report-line {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 2px 0;
        }

        /* åŸå§‹å…§å®¹å®¹å™¨ */
        .original-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
        }

        /* ä½¿ç”¨è¡¨æ ¼ä½ˆå±€ */
        .content-table {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .content-row {
            
        }

        .line-number-cell {
            display: table-cell;
            width: 60px;
            min-width: 60px;
            max-width: 80px;
            padding: 0 5px 0 0; /* æ¸›å°‘ padding */
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            vertical-align: top;
            background: #1a1a1a;
            border-right: 1px solid #333;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .content-cell {
            display: table-cell;
            padding: 0 20px 0 10px; /* èª¿æ•´å·¦å´ padding */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            color: #d4d4d4;
            vertical-align: top;
        }

        /* å…§å®¹å€åŸŸçš„å…§éƒ¨å®¹å™¨ */
        .content-inner {
            display: flex;
            position: relative;
        }

        /* åŸå§‹å…§å®¹æ¨£å¼ */
        .original-content {
            flex: 1;
            padding: 20px;
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            white-space: pre;
            word-wrap: normal;
            color: #d4d4d4;
            background: transparent;
            min-width: max-content;
        }
        
        /* åˆ†æå ±å‘Šç‰¹å®šæ¨£å¼ */
        .panel-content .report-line {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            padding: 2px 0;
            color: var(--text-primary);
        }
        
        .panel-content .anr-type {
            color: #ff9800;
            font-weight: bold;
        }
        
        .panel-content .process-name {
            color: #4ec9b0;
            font-weight: bold;
        }
        
        .panel-content .timestamp {
            color: #608b4e;
        }
        
        .panel-content .separator {
            color: #565656;
        }
        
        .panel-content a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .panel-content a:hover {
            text-decoration: underline;
        }

        /* ç‹€æ…‹åˆ—è­¦å‘Šæ¨£å¼ */
        .status-bar .warning-text {
            color: #ff6b6b;
            font-weight: bold;
            margin-left: 20px;
        }

        /* åŒ¯å‡ºé¸å–®æç¤º */
        .export-menu::before {
            content: 'è«‹å‹¿åœ¨è¼‰å…¥å…§å®¹å‰åŒ¯å‡º';
            position: absolute;
            top: -25px;
            right: 0;
            color: #ff6b6b;
            font-size: 12px;
            white-space: nowrap;
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ff6b6b;
        }

        /* é«˜äº®æ¨£å¼ */
        .highlight-1 { background: rgba(255, 255, 0, 0.4) !important; color: #000 !important; } /* é»ƒè‰² */
        .highlight-2 { background: rgba(0, 255, 0, 0.4) !important; color: #000 !important; } /* ç¶ è‰² */
        .highlight-3 { background: rgba(0, 191, 255, 0.4) !important; color: #000 !important; } /* è—è‰² */
        .highlight-4 { background: rgba(255, 165, 0, 0.4) !important; color: #000 !important; } /* æ©™è‰² */
        .highlight-5 { background: rgba(255, 192, 203, 0.4) !important; color: #000 !important; } /* ç²‰ç´… */

        /* å³éµé¸å–®æ¨£å¼ */
        .context-menu {
            position: fixed;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 5px 0;
            z-index: 10000;
            display: none;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        }

        .context-menu-item {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 13px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: #3a3a3a;
        }

        .context-menu-separator {
            height: 1px;
            background: #555;
            margin: 5px 0;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border: 1px solid #666;
            border-radius: 2px;
        }

        /* è¡Œè™Ÿæ¨£å¼ */
        .line-numbers {
            position: sticky;
            left: 0;
            flex-shrink: 0;
            width: 60px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px 10px 0 0; /* ç§»é™¤åº•éƒ¨ padding */
            margin: 0;
            text-align: right;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6em;
            color: #666;
            user-select: none;
            z-index: 10;
            align-self: flex-start;
        }

        /* è¡Œè™Ÿé …ç›® */
        .line-number {
            display: block;
            position: relative;
            padding-left: 10px; /* æ¸›å°‘å·¦å´ padding */
            cursor: pointer;
            height: 1.6em;
            line-height: 1.6em;
            box-sizing: border-box;
            transition: background-color 0.2s ease;
        }

        /* ç¬¬ä¸€è¡Œå’Œæœ€å¾Œä¸€è¡Œçš„ç‰¹æ®Šè™•ç† */
        .content-table::before,
        .content-table::after {
            content: '';
            display: table-row;
            height: 20px;
        }

        /* ç¢ºä¿ç¬¬ä¸€è¡Œå°é½Š */
        .line-numbers::before,
        .original-content::before {
            content: '';
            display: block;
            height: 20px; /* èˆ‡å…§å®¹çš„ padding-top ç›¸åŒ */
        }

        /* ç•¶å‰è¡Œé«˜äº® */
        .line-number.current {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .with-line-numbers {
            padding-left: 80px !important;
            position: relative;
        }

        /* é«˜äº®å°èˆªæç¤º */
        .highlight-nav-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #2d2d2d;
            border: 1px solid #555;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #e0e0e0;
            display: none;
            z-index: 1000;
        }

        /* æ›¸ç±¤æ¨£å¼ */
        .line-number.bookmarked::before {
            content: 'â—';
            position: absolute;
            left: 2px;
            color: #00ff00;
            font-size: 10px;
        }

        /* è¡Œè™Ÿæ‡¸åœæ•ˆæœ */
        .line-number:not(.bookmarked):hover::before {
            content: 'ğŸ“Œ';
            position: absolute;
            left: 2px;
            font-size: 10px;
            opacity: 0.5;
        }

        .line-number.bookmarked:hover::before {
            content: 'âœ•';
            color: #ff6666;
            left: 2px;
        }

        /* é«˜äº®æ§åˆ¶æŒ‰éˆ• - ä¿®æ­£ä½ç½® */
        .highlight-controls {
            position: absolute;
            right: 130px;
            display: flex;
            gap: 5px;
            z-index: 100;
            background: #1a1a1a;
            padding: 5px;
            border-radius: 4px;
            /* border: 1px solid #333;*/
        }

        .highlight-control-btn {
            width: 25px;
            height: 25px;
            border: 1px solid #555;
            border-radius: 20px;
            cursor: pointer;
            display: none;
            position: relative;
        }

        .highlight-control-btn:hover::after {
            content: 'âœ•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 12px;
            font-weight: bold;
        }

        #rightPanel {
            padding-right: 6px;
        }
    </style>    
</head>
<body>
    <!-- é ‚éƒ¨å·¥å…·åˆ— -->
    <div class="header">
        <div class="header-left">
            <div class="file-info">
                <h1 id="filename">è¼‰å…¥ä¸­...</h1>
                <p id="filepath">{{ file_path }}</p>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" id="toggleOriginalBtn" onclick="toggleOriginalPanel()">
                <span>ğŸ“„</span>
                <span>æŸ¥çœ‹åŸå§‹æª”æ¡ˆ</span>
            </button>
            <button class="btn" onclick="switchPanels()">
                <span>ğŸ”„</span>
                <span>å·¦å³äº¤æ›</span>
            </button>
            <button class="btn" onclick="toggleFullscreenMode()">
                <span>â›¶</span>
                <span>å…¨å±æ¨¡å¼</span>
            </button>
            <a href="/view-analysis?path={{ file_path }}&download=true" class="btn" download>
                <span>ğŸ“¥</span>
                <span>ä¸‹è¼‰åˆ†æ</span>
            </a>
            <a href="/view-analysis?path={{ file_path }}&download=true&original=true" class="btn" download>
                <span>ğŸ“¥</span>
                <span>ä¸‹è¼‰åŸå§‹</span>
            </a>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container" id="mainContainer">
        <!-- å·¦å´é¢æ¿ï¼ˆé è¨­é¡¯ç¤ºåˆ†æå ±å‘Šï¼‰ -->
        <div class="split-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="leftPanelIcon">ğŸ“Š</span>
                    <span id="leftPanelTitle">åˆ†æå ±å‘Š</span>
                </div>
                <div class="panel-controls">
                    <div style="position: relative;">
                        <button class="icon-btn" onclick="toggleExportMenu('left')" title="åŒ¯å‡º">
                            ğŸ’¾
                        </button>
                        <div class="export-menu" id="leftExportMenu">
                            <div class="export-item" onclick="exportContent('left', 'html')">
                                <span>ğŸŒ</span> HTML
                            </div>
                            <div class="export-item" onclick="exportContent('left', 'markdown')">
                                <span>ğŸ“</span> Markdown
                            </div>
                            <div class="export-item" onclick="exportContent('left', 'txt')">
                                <span>ğŸ“„</span> ç´”æ–‡å­—
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleFullscreen('left')" title="å…¨å±">
                        â›¶
                    </button>
                </div>
            </div>
            <div class="panel-content" id="leftContent">
                <div class="loading">è¼‰å…¥åˆ†æå ±å‘Šä¸­...</div>
            </div>
        </div>
        
        <!-- åˆ†å‰²æ¢ -->
        <div class="resize-handle hidden" id="resizeHandle"></div>
        
        <!-- å³å´é¢æ¿ï¼ˆé è¨­éš±è—ï¼‰ -->
        <div class="split-panel hidden" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="rightPanelIcon">ğŸ“„</span>
                    <span id="rightPanelTitle">åŸå§‹æª”æ¡ˆ</span>
                </div>
                <!-- é«˜äº®æ§åˆ¶æŒ‰éˆ• -->
                <div class="highlight-controls" id="highlightControls">
                    <div class="highlight-control-btn" id="highlightBtn1" style="background: rgba(255, 255, 0, 0.6);" onclick="clearHighlightColor(1)" title="æ¸…é™¤é»ƒè‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn2" style="background: rgba(0, 255, 0, 0.6);" onclick="clearHighlightColor(2)" title="æ¸…é™¤ç¶ è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn3" style="background: rgba(0, 191, 255, 0.6);" onclick="clearHighlightColor(3)" title="æ¸…é™¤è—è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn4" style="background: rgba(255, 165, 0, 0.6);" onclick="clearHighlightColor(4)" title="æ¸…é™¤æ©™è‰²é«˜äº®"></div>
                    <div class="highlight-control-btn" id="highlightBtn5" style="background: rgba(255, 192, 203, 0.6);" onclick="clearHighlightColor(5)" title="æ¸…é™¤ç²‰ç´…é«˜äº®"></div>
                </div>                
                <div class="panel-controls">
                    <div style="position: relative;">                        
                        <button class="icon-btn" onclick="toggleExportMenu('right')" title="åŒ¯å‡º">
                            ğŸ’¾
                        </button>
                        <div class="export-menu" id="rightExportMenu">
                            <div class="export-item" onclick="exportContent('right', 'html')">
                                <span>ğŸŒ</span> HTML
                            </div>
                            <div class="export-item" onclick="exportContent('right', 'markdown')">
                                <span>ğŸ“</span> Markdown
                            </div>
                            <div class="export-item" onclick="exportContent('right', 'txt')">
                                <span>ğŸ“„</span> ç´”æ–‡å­—
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleFullscreen('right')" title="å…¨å±">
                        â›¶
                    </button>
                    <button class="icon-btn" onclick="closePanel('right')" title="é—œé–‰">
                        âœ•
                    </button>
                </div>
            </div>
            <div class="panel-content" id="rightContent">
                <div class="loading">æº–å‚™è¼‰å…¥åŸå§‹æª”æ¡ˆ...</div>
            </div>
        </div>
    </div>
    
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div class="status-left">
            <span id="statusText">å°±ç·’</span>
            <span class="warning-text">åŒ¯å‡ºæ™‚éƒ½æœƒé¡¯ç¤ºå…§å®¹å†åŒ¯å‡º</span>
        </div>
        <div class="status-right">
            <span id="reportType">{{ report_type.upper() }} å ±å‘Š</span>
            <span> | </span>
            <span id="loadTime">è¼‰å…¥æ™‚é–“: è¨ˆç®—ä¸­...</span>
        </div>
    </div>
    <!-- å³éµé¸å–® -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="highlightSelection(1)">
            <div class="color-box" style="background: #ffff00;"></div>
            <span>é«˜äº® 1 (é»ƒè‰²)</span>
        </div>
        <div class="context-menu-item" onclick="highlightSelection(2)">
            <div class="color-box" style="background: #00ff00;"></div>
            <span>é«˜äº® 2 (ç¶ è‰²)</span>
        </div>
        <div class="context-menu-item" onclick="highlightSelection(3)">
            <div class="color-box" style="background: #00bfff;"></div>
            <span>é«˜äº® 3 (è—è‰²)</span>
        </div>
        <div class="context-menu-item" onclick="highlightSelection(4)">
            <div class="color-box" style="background: #ffa500;"></div>
            <span>é«˜äº® 4 (æ©™è‰²)</span>
        </div>
        <div class="context-menu-item" onclick="highlightSelection(5)">
            <div class="color-box" style="background: #ffc0cb;"></div>
            <span>é«˜äº® 5 (ç²‰ç´…)</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="clearHighlight()">
            <span>ç§»é™¤æ­¤é«˜äº®</span>
        </div>
        <div class="context-menu-item" onclick="clearAllHighlights()">
            <span>æ¸…é™¤æ‰€æœ‰é«˜äº®</span>
        </div>
    </div>
    <!-- é«˜äº®å°èˆªæç¤º -->
    <div class="highlight-nav-hint" id="highlightNavHint">
        F2: ä¸‹ä¸€å€‹é«˜äº® | F3: ä¸Šä¸€å€‹é«˜äº®
    </div>    
    <script>
        // å…¨åŸŸè®Šæ•¸
        const filePath = {{ escaped_file_path | safe }};
        let analysisContent = '';  // åˆ†æå ±å‘Šå…§å®¹
        let originalContent = '';  // åŸå§‹æª”æ¡ˆå…§å®¹
        let isOriginalLoaded = false;
        let currentLeftType = 'analysis';
        let currentRightType = 'original';
        let startTime = Date.now();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateFilename();
            loadAnalysisContent();
            
            // è‡ªå‹•é–‹å•ŸåŸå§‹æª”æ¡ˆè¦–çª—
            setTimeout(() => {
                toggleOriginalPanel();  // è‡ªå‹•é–‹å•Ÿå³å´é¢æ¿
            }, 500);
            
            setupResizeHandler();
            setupKeyboardShortcuts();

            // é»æ“Šå¤–éƒ¨é—œé–‰åŒ¯å‡ºé¸å–®
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.export-menu') && !e.target.closest('.icon-btn')) {
                    closeAllExportMenus();
                }
            });
        });
        
        // æ›´æ–°æª”åé¡¯ç¤º
        function updateFilename() {
            // è§£ç¢¼ HTML ç·¨ç¢¼çš„æª”æ¡ˆè·¯å¾‘
            const decodedPath = decodeURIComponent(filePath);
            const pathParts = decodedPath.split('/');
            let filename = pathParts[pathParts.length - 1];
            
            // ç§»é™¤ .analyzed.html å¾Œç¶´ä»¥é¡¯ç¤ºæ›´ç°¡æ½”çš„æª”å
            filename = filename.replace('.analyzed.html', '');
            filename = filename.replace('.analyzed.txt', '');
            
            document.getElementById('filename').textContent = filename;
        }
        
        // è¼‰å…¥åˆ†æå ±å‘Šå…§å®¹
        async function loadAnalysisContent() {
            try {
                const response = await fetch(`/api/load-analysis?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    analysisContent = data.content;  // å„²å­˜åˆ†æå ±å‘Šå…§å®¹
                    
                    // èª¿è©¦ï¼šæª¢æŸ¥å…§å®¹é¡å‹
                    console.log('Content type:', typeof data.content);
                    console.log('Content preview:', data.content.substring(0, 200));
                    
                    displayContent('left', data.content, 'analysis');
                    updateLoadTime();
                } else {
                    showError('left', data.error);
                }
            } catch (error) {
                showError('left', 'è¼‰å…¥åˆ†æå ±å‘Šå¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥åŸå§‹æª”æ¡ˆå…§å®¹
        async function loadOriginalContent() {
            if (isOriginalLoaded) return;
            
            updateStatus('è¼‰å…¥åŸå§‹æª”æ¡ˆä¸­...');
            
            try {
                const response = await fetch(`/api/load-original?path=${encodeURIComponent(filePath)}`);
                const data = await response.json();
                
                if (data.success) {
                    originalContent = data.content;  // å„²å­˜åŸå§‹æª”æ¡ˆå…§å®¹
                    displayContent('right', data.content, 'original');
                    isOriginalLoaded = true;
                    updateStatus('åŸå§‹æª”æ¡ˆå·²è¼‰å…¥');
                } else {
                    showError('right', data.error || 'æ‰¾ä¸åˆ°åŸå§‹æª”æ¡ˆ');
                    updateStatus('è¼‰å…¥åŸå§‹æª”æ¡ˆå¤±æ•—');
                }
            } catch (error) {
                showError('right', 'è¼‰å…¥åŸå§‹æª”æ¡ˆå¤±æ•—: ' + error.message);
                updateStatus('è¼‰å…¥åŸå§‹æª”æ¡ˆå¤±æ•—');
            }
        }

        // é¡¯ç¤ºå…§å®¹
        function displayContent(panel, content, type) {
            const contentEl = document.getElementById(panel + 'Content');
            
            if (type === 'analysis') {
                // åˆ†æå ±å‘Šè™•ç†ï¼ˆä¿æŒåŸæ¨£ï¼‰
                if (panel === 'left' && currentLeftType === 'analysis') {
                    analysisContent = content;
                } else if (panel === 'right' && currentRightType === 'analysis') {
                    analysisContent = content;
                }
                
                contentEl.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.srcdoc = content;
                
                iframe.onload = function() {
                    setupIframeContextMenu(iframe);
                };
                
                contentEl.appendChild(iframe);
                
            } else {
                // åŸå§‹æª”æ¡ˆè™•ç† - ä½¿ç”¨è¡¨æ ¼ä½ˆå±€
                if (panel === 'left' && currentLeftType === 'original') {
                    originalContent = content;
                } else if (panel === 'right' && currentRightType === 'original') {
                    originalContent = content;
                }
                
                const lines = content.split(/\r?\n/);
                if (lines[lines.length - 1] === '') {
                    lines.pop();
                }
                
                // å»ºç«‹åŒ…è£å®¹å™¨
                const wrapper = document.createElement('div');
                wrapper.className = 'original-content-wrapper';
                wrapper.id = `${panel}ContentWrapper`;
                
                // å»ºç«‹è¡¨æ ¼
                const table = document.createElement('div');
                table.className = 'content-table';
                
                // å»ºç«‹è¡¨æ ¼å…§å®¹
                let tableHTML = '';
                
                // æ·»åŠ é ‚éƒ¨ç©ºç™½è¡Œ
                tableHTML += '<div style="height: 20px;"></div>';
                
                // ç‚ºæ¯ä¸€è¡Œå‰µå»ºè¡¨æ ¼è¡Œ
                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    const escapedLine = escapeHtml(line);
                    
                    tableHTML += `
                        <div class="content-row">
                            <div class="line-number-cell">
                                <span class="line-number" data-line="${lineNum}" data-panel="${panel}">${lineNum}</span>
                            </div>
                            <div class="content-cell">${escapedLine || ' '}</div>
                        </div>
                    `;
                });
                
                // æ·»åŠ åº•éƒ¨ç©ºç™½è¡Œ
                tableHTML += '<div style="height: 20px;"></div>';
                
                table.innerHTML = tableHTML;
                wrapper.appendChild(table);
                
                contentEl.innerHTML = '';
                contentEl.appendChild(wrapper);
                
                // è¨­ç½®è¡Œè™Ÿäº‹ä»¶
                setupLineNumberHandlers(panel);
                
                // è¨­ç½®å…§å®¹è¡Œè¿½è¹¤ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰
                setupContentLineTrackingForTable(panel);
                
                // è¨­ç½®å³éµé¸å–®
                setupContextMenuForTable(panel);
                
                updateStatus(`è¼‰å…¥å®Œæˆ - å…± ${lines.length} è¡Œ`);
            }
        }

        // ç‚ºè¡¨æ ¼ä½ˆå±€è¨­ç½®å…§å®¹è¡Œè¿½è¹¤
        function setupContentLineTrackingForTable(panel) {
            const rows = document.querySelectorAll(`#${panel}ContentWrapper .content-row`);
            
            rows.forEach((row, index) => {
                const lineNum = index + 1;
                const contentCell = row.querySelector('.content-cell');
                const lineNumber = row.querySelector('.line-number');
                
                // å…§å®¹å–®å…ƒæ ¼æ»‘é¼ äº‹ä»¶
                contentCell.addEventListener('mouseenter', function() {
                    currentFocusedLine = lineNum;
                    currentFocusedPanel = panel;
                    // é«˜äº®ç•¶å‰è¡Œè™Ÿ
                    highlightCurrentLineNumber(panel, lineNum);
                });
                
                contentCell.addEventListener('mouseleave', function() {
                    // å¦‚æœä¸æ˜¯æ›¸ç±¤ï¼Œç§»é™¤é«˜äº®
                    if (!lineNumber.classList.contains('bookmarked')) {
                        lineNumber.style.backgroundColor = '';
                    }
                });
                
                contentCell.addEventListener('click', function() {
                    currentFocusedPanel = panel;
                    currentFocusedLine = lineNum;
                });
            });
        }

        // ç‚ºè¡¨æ ¼ä½ˆå±€è¨­ç½®å³éµé¸å–®
        function setupContextMenuForTable(panel) {
            const contentCells = document.querySelectorAll(`#${panel}ContentWrapper .content-cell`);
            
            contentCells.forEach(cell => {
                cell.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    
                    const selection = window.getSelection();
                    selectedText = selection.toString();
                    
                    if (selectedText) {
                        selectedRange = selection.getRangeAt(0);
                        showContextMenu(e.clientX, e.clientY);
                    }
                });
            });
        }

        // è¿½è¹¤æ»‘é¼ æ‰€åœ¨çš„å…§å®¹è¡Œ
        function setupContentLineTracking(panel) {
            const contentEl = document.getElementById(`${panel}OriginalContent`);
            const lineNumbersEl = document.getElementById(`${panel}LineNumbers`);
            
            if (!contentEl || !lineNumbersEl) return;
            
            // ç²å–æº–ç¢ºçš„è¡Œé«˜
            const lineNumbers = lineNumbersEl.querySelectorAll('.line-number');
            if (lineNumbers.length === 0) return;
            
            const firstLineNumber = lineNumbers[0];
            const lineHeight = firstLineNumber.getBoundingClientRect().height;
            
            let lastHighlightedLine = null;
            
            // ä½¿ç”¨æ›´ç²¾ç¢ºçš„æ–¹æ³•è¿½è¹¤è¡Œè™Ÿ
            contentEl.addEventListener('mousemove', function(e) {
                const contentRect = contentEl.getBoundingClientRect();
                const lineNumbersRect = lineNumbersEl.getBoundingClientRect();
                
                // è¨ˆç®—ç›¸å°æ–¼ç¬¬ä¸€è¡Œçš„åç§»
                const relativeY = e.clientY - lineNumbersRect.top;
                
                // è¨ˆç®—è¡Œè™Ÿï¼ˆå¾1é–‹å§‹ï¼‰
                let line = Math.floor(relativeY / lineHeight) + 1;
                
                // ç¢ºä¿è¡Œè™Ÿåœ¨æœ‰æ•ˆç¯„åœå…§
                line = Math.max(1, Math.min(line, lineNumbers.length));
                
                if (line !== lastHighlightedLine) {
                    currentFocusedLine = line;
                    currentFocusedPanel = panel;
                    highlightCurrentLineNumber(panel, line);
                    lastHighlightedLine = line;
                }
            });
            
            // å…§å®¹å€åŸŸç²å¾—ç„¦é»æ™‚æ›´æ–°é¢æ¿
            contentEl.addEventListener('click', function() {
                currentFocusedPanel = panel;
            });
        }

        // é«˜äº®ç•¶å‰è¡Œè™Ÿ
        function highlightCurrentLineNumber(panel, lineNumber) {
            // æ¸…é™¤è©²é¢æ¿ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll(`#${panel}LineNumbers .line-number`).forEach(el => {
                if (!el.classList.contains('bookmarked')) {
                    el.style.backgroundColor = '';
                }
            });
            
            // é«˜äº®ç•¶å‰è¡Œè™Ÿ
            const lineElement = document.querySelector(`#${panel}LineNumbers .line-number[data-line="${lineNumber}"]`);
            if (lineElement && !lineElement.classList.contains('bookmarked')) {
                lineElement.style.backgroundColor = 'rgba(78, 201, 176, 0.1)';
            }
        }

        // æ¸…é™¤è¡Œè™Ÿé«˜äº®
        function clearLineNumberHighlight(panel) {
            document.querySelectorAll(`#${panel}LineNumbers .line-number`).forEach(el => {
                el.style.backgroundColor = '';
            });
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(panel, message) {
            const contentEl = document.getElementById(panel + 'Content');
            contentEl.innerHTML = `<div class="error-message">âŒ ${escapeHtml(message)}</div>`;
        }
        
        // åˆ‡æ›åŸå§‹æª”æ¡ˆé¢æ¿
        function toggleOriginalPanel() {
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const resizeHandle = document.getElementById('resizeHandle');
            const btn = document.getElementById('toggleOriginalBtn');
            
            if (rightPanel.classList.contains('hidden')) {
                // é¡¯ç¤ºå³å´é¢æ¿
                rightPanel.classList.remove('hidden');
                resizeHandle.classList.remove('hidden');
                
                // è¨­å®šç‚º 50%/50% æ¯”ä¾‹
                leftPanel.style.flex = '0 0 calc(50% - 2.5px)';
                rightPanel.style.flex = '0 0 calc(50% - 2.5px)';
                
                // è¼‰å…¥åŸå§‹æª”æ¡ˆ
                if (!isOriginalLoaded) {
                    loadOriginalContent();
                }
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                btn.innerHTML = '<span>ğŸ“„</span><span>éš±è—åŸå§‹æª”æ¡ˆ</span>';
            } else {
                // éš±è—å³å´é¢æ¿
                rightPanel.classList.add('hidden');
                resizeHandle.classList.add('hidden');
                
                // å·¦å´é¢æ¿æ¢å¾©å…¨å¯¬
                leftPanel.style.flex = '1';
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                btn.innerHTML = '<span>ğŸ“„</span><span>æŸ¥çœ‹åŸå§‹æª”æ¡ˆ</span>';
            }
        }
        
        // åˆ‡æ›å·¦å³é¢æ¿å…§å®¹
        function switchPanels() {
            // ç¢ºä¿å³å´é¢æ¿å·²ç¶“é–‹å•Ÿ
            const rightPanel = document.getElementById('rightPanel');
            if (rightPanel.classList.contains('hidden')) {
                updateStatus('è«‹å…ˆé–‹å•ŸåŸå§‹æª”æ¡ˆè¦–çª—');
                return;
            }
            
            // äº¤æ›å…§å®¹é¡å‹
            const tempType = currentLeftType;
            currentLeftType = currentRightType;
            currentRightType = tempType;
            
            // é‡æ–°é¡¯ç¤ºå…§å®¹
            if (currentLeftType === 'analysis') {
                displayContent('left', analysisContent, 'analysis');
            } else {
                displayContent('left', originalContent, 'original');
            }
            
            if (currentRightType === 'analysis') {
                displayContent('right', analysisContent, 'analysis');
            } else {
                displayContent('right', originalContent, 'original');
            }
            
            // æ›´æ–°æ¨™é¡Œ
            updatePanelTitles();
            
            updateStatus('å·²åˆ‡æ›é¢æ¿å…§å®¹');
        }
        
        // æ›´æ–°é¢æ¿æ¨™é¡Œ
        function updatePanelTitles() {
            const leftIcon = document.getElementById('leftPanelIcon');
            const leftTitle = document.getElementById('leftPanelTitle');
            const rightIcon = document.getElementById('rightPanelIcon');
            const rightTitle = document.getElementById('rightPanelTitle');
            
            if (currentLeftType === 'analysis') {
                leftIcon.textContent = 'ğŸ“Š';
                leftTitle.textContent = 'åˆ†æå ±å‘Š';
            } else {
                leftIcon.textContent = 'ğŸ“„';
                leftTitle.textContent = 'åŸå§‹æª”æ¡ˆ';
            }
            
            if (currentRightType === 'analysis') {
                rightIcon.textContent = 'ğŸ“Š';
                rightTitle.textContent = 'åˆ†æå ±å‘Š';
            } else {
                rightIcon.textContent = 'ğŸ“„';
                rightTitle.textContent = 'åŸå§‹æª”æ¡ˆ';
            }
        }
        
        // åˆ‡æ›å…¨å±ï¼ˆæŒ‡å®šé¢æ¿ï¼‰
        function toggleFullscreen(panel) {
            const panelEl = document.getElementById(panel + 'Panel');
            
            if (panelEl.classList.contains('fullscreen')) {
                panelEl.classList.remove('fullscreen');
            } else {
                // å…ˆé—œé–‰å…¶ä»–å…¨å±
                document.querySelectorAll('.fullscreen').forEach(el => {
                    el.classList.remove('fullscreen');
                });
                panelEl.classList.add('fullscreen');
            }
        }
        
        // åˆ‡æ›å…¨å±æ¨¡å¼ï¼ˆæ•´å€‹æ‡‰ç”¨ï¼‰
        function toggleFullscreenMode() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // é—œé–‰é¢æ¿
        function closePanel(panel) {
            if (panel === 'right') {
                toggleOriginalPanel();
            }
        }
        
        // åˆ‡æ›åŒ¯å‡ºé¸å–®
        function toggleExportMenu(panel) {
            const menu = document.getElementById(panel + 'ExportMenu');
            const otherMenu = document.getElementById(panel === 'left' ? 'rightExportMenu' : 'leftExportMenu');
            
            // é—œé–‰å¦ä¸€å€‹é¸å–®
            if (otherMenu) {
                otherMenu.classList.remove('show');
            }
            
            // åˆ‡æ›ç•¶å‰é¸å–®
            menu.classList.toggle('show');
        }
        
        // é—œé–‰æ‰€æœ‰åŒ¯å‡ºé¸å–®
        function closeAllExportMenus() {
            document.querySelectorAll('.export-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        // åŒ¯å‡ºå…§å®¹
        async function exportContent(panel, format) {
            closeAllExportMenus();
            
            // ç¢ºä¿å…§å®¹å·²è¼‰å…¥
            if (panel === 'left' && !analysisContent) {
                updateStatus('è«‹ç­‰å¾…åˆ†æå ±å‘Šè¼‰å…¥å®Œæˆå¾Œå†åŒ¯å‡º');
                return;
            }
            
            if (panel === 'right' && !originalContent) {
                updateStatus('è«‹ç­‰å¾…åŸå§‹æª”æ¡ˆè¼‰å…¥å®Œæˆå¾Œå†åŒ¯å‡º');
                return;
            }
            
            // æ ¹æ“šç•¶å‰é¢æ¿é¡¯ç¤ºçš„å…§å®¹é¡å‹ä¾†æ±ºå®šåŒ¯å‡ºä»€éº¼
            let content = '';
            let contentType = '';
            
            if (panel === 'left') {
                content = (currentLeftType === 'analysis') ? analysisContent : originalContent;
                contentType = currentLeftType;
            } else {
                content = (currentRightType === 'analysis') ? analysisContent : originalContent;
                contentType = currentRightType;
            }
            
            // ç¢ºä¿æœ‰å…§å®¹å¯åŒ¯å‡º
            if (!content) {
                updateStatus('æ²’æœ‰å…§å®¹å¯ä¾›åŒ¯å‡º');
                return;
            }
            
            const filename = filePath.split('/').pop().replace(/\.[^/.]+$/, '');
            
            updateStatus(`æ­£åœ¨åŒ¯å‡ºç‚º ${format.toUpperCase()} æ ¼å¼...`);
            
            try {
                const response = await fetch('/api/export-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        format: format,
                        filename: filename,
                        contentType: contentType
                    })
                });
                
                if (response.ok) {
                    // ä¸‹è¼‰æª”æ¡ˆ
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // å¾ Content-Disposition header ç²å–æª”å
                    const contentDisposition = response.headers.get('content-disposition');
                    let downloadFilename = `${filename}_${format}.${format}`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?(.+?)"?$/);
                        if (filenameMatch) {
                            downloadFilename = filenameMatch[1];
                        }
                    }
                    
                    a.download = downloadFilename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    updateStatus('åŒ¯å‡ºæˆåŠŸ');
                } else {
                    const error = await response.json();
                    updateStatus('åŒ¯å‡ºå¤±æ•—: ' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                updateStatus('åŒ¯å‡ºå¤±æ•—: ' + error.message);
            }
        }
        
        // è¨­ç½®èª¿æ•´å¤§å°è™•ç†
        function setupResizeHandler() {
            const resizeHandle = document.getElementById('resizeHandle');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const mainContainer = document.getElementById('mainContainer');
            
            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            
            // å‰µå»ºä¸€å€‹è¦†è“‹å±¤ä¾†é˜²æ­¢ iframe å¹²æ“¾
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.zIndex = '9999';
            overlay.style.cursor = 'col-resize';
            overlay.style.display = 'none';
            overlay.style.userSelect = 'none';
            document.body.appendChild(overlay);
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startLeftWidth = leftPanel.offsetWidth;
                
                // é¡¯ç¤ºè¦†è“‹å±¤
                overlay.style.display = 'block';
                
                // é˜²æ­¢æ–‡å­—é¸æ“‡
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.mozUserSelect = 'none';
                document.body.style.msUserSelect = 'none';
                
                // ç¦ç”¨ iframe çš„æŒ‡æ¨™äº‹ä»¶
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.style.pointerEvents = 'none';
                });
                
                e.preventDefault();
                e.stopPropagation();
            });
            
            // åœ¨ overlay å’Œ document ä¸Šç›£è½äº‹ä»¶
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const deltaX = e.clientX - startX;
                const newLeftWidth = startLeftWidth + deltaX;
                const containerWidth = mainContainer.offsetWidth - 5; // æ¸›å» resize handle çš„å¯¬åº¦
                const minWidth = 200;
                const maxWidth = containerWidth - minWidth;
                
                if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                    const leftPercent = (newLeftWidth / containerWidth) * 100;
                    const rightPercent = 100 - leftPercent;
                    
                    leftPanel.style.flex = `0 0 calc(${leftPercent}% - 2.5px)`;
                    rightPanel.style.flex = `0 0 calc(${rightPercent}% - 2.5px)`;
                }
            }
            
            function handleMouseUp(e) {
                if (!isResizing) return;
                
                isResizing = false;
                
                // éš±è—è¦†è“‹å±¤
                overlay.style.display = 'none';
                
                // æ¢å¾©æ¨£å¼
                document.body.style.cursor = 'default';
                document.body.style.userSelect = '';
                document.body.style.webkitUserSelect = '';
                document.body.style.mozUserSelect = '';
                document.body.style.msUserSelect = '';
                
                // æ¢å¾© iframe çš„æŒ‡æ¨™äº‹ä»¶
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.style.pointerEvents = 'auto';
                });
                
                e.preventDefault();
                e.stopPropagation();
            }
            
            // åŒæ™‚åœ¨ document å’Œ overlay ä¸Šç›£è½
            document.addEventListener('mousemove', handleMouseMove);
            overlay.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            overlay.addEventListener('mouseup', handleMouseUp);
            
            // è™•ç†æ»‘é¼ é›¢é–‹è¦–çª—çš„æƒ…æ³
            document.addEventListener('mouseleave', function(e) {
                if (isResizing) {
                    handleMouseUp(e);
                }
            });
            
            // è®“æ‹–æ›³æ¢æ›´å®¹æ˜“é»æ“Š
            resizeHandle.style.position = 'relative';
            resizeHandle.innerHTML = '<div style="position: absolute; left: -5px; right: -5px; top: 0; bottom: 0; cursor: col-resize;"></div>';
        }
        
        // è¨­ç½®éµç›¤å¿«æ·éµ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // ESC é€€å‡ºå…¨å±
                if (e.key === 'Escape') {
                    document.querySelectorAll('.fullscreen').forEach(el => {
                        el.classList.remove('fullscreen');
                    });
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                }
                
                // F2 - åœ¨ç•¶å‰è¡ŒåŠ æ›¸ç±¤
                if (e.key === 'F2') {
                    e.preventDefault();
                    
                    // æ‰¾åˆ°ç•¶å‰è¡Œçš„è¡Œè™Ÿå…ƒç´ 
                    const lineElement = document.querySelector(
                        `#${currentFocusedPanel}ContentWrapper .line-number[data-line="${currentFocusedLine}"]`
                    );
                    
                    if (lineElement) {
                        toggleBookmark(lineElement);
                        console.log(`F2: åœ¨ ${currentFocusedPanel} é¢æ¿ç¬¬ ${currentFocusedLine} è¡Œåˆ‡æ›æ›¸ç±¤`);
                    } else {
                        console.log(`F2: æ‰¾ä¸åˆ°è¡Œè™Ÿå…ƒç´  - Panel: ${currentFocusedPanel}, Line: ${currentFocusedLine}`);
                    }
                }
                
                // F3 - è·³è½‰åˆ°ä¸‹ä¸€å€‹æ›¸ç±¤
                if (e.key === 'F3') {
                    e.preventDefault();
                    navigateBookmarks();
                }
                
                // å…¶ä»–å¿«æ·éµ...
                if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    toggleOriginalPanel();
                }
                
                if (e.ctrlKey && e.key === 'w') {
                    e.preventDefault();
                    switchPanels();
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreenMode();
                }
            });
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // æ›´æ–°è¼‰å…¥æ™‚é–“
        function updateLoadTime() {
            const loadTime = Date.now() - startTime;
            document.getElementById('loadTime').textContent = `è¼‰å…¥æ™‚é–“: ${loadTime}ms`;
        }
        
        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // ç¢ºä¿ Unicode å­—ç¬¦æ­£ç¢ºé¡¯ç¤º
            return div.innerHTML.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
                return '&#' + i.charCodeAt(0) + ';';
            });
        }
    </script>
    <script>
        // æ›¸ç±¤ç›¸é—œè®Šæ•¸
        let bookmarks = new Set();
        let currentBookmarkIndex = -1;
        let bookmarkArray = [];

        // é«˜äº®ç›¸é—œè®Šæ•¸
        let highlightedTexts = {
            1: null,
            2: null,
            3: null,
            4: null,
            5: null
        };

        // è¨­ç½®è¡Œè™Ÿè™•ç†å™¨
        function setupLineNumberHandlers(panel) {
            const lineNumbers = document.querySelectorAll(`#${panel}ContentWrapper .line-number`);
            
            lineNumbers.forEach(lineNum => {
                // é»æ“Šè¡Œè™Ÿåˆ‡æ›æ›¸ç±¤
                lineNum.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleBookmark(this);
                });
                
                // æ»‘é¼ é€²å…¥æ™‚æ›´æ–°ç•¶å‰è¡Œ
                lineNum.addEventListener('mouseenter', function() {
                    const line = parseInt(this.getAttribute('data-line'));
                    currentFocusedLine = line;
                    currentFocusedPanel = panel;
                });
            });
        }

        // ç¢ºä¿è¡Œè™Ÿèˆ‡å…§å®¹åŒæ­¥æ²å‹•
        function syncLineNumbers(panel) {
            const wrapper = document.getElementById(`${panel}ContentWrapper`);
            const lineNumbers = document.getElementById(`${panel}LineNumbers`);
            
            if (wrapper && lineNumbers) {
                // åˆå§‹å°é½Š
                const content = document.getElementById(`${panel}OriginalContent`);
                const computedStyle = window.getComputedStyle(content);
                const paddingTop = parseInt(computedStyle.paddingTop);
                
                lineNumbers.style.paddingTop = paddingTop + 'px';
                
                // ç›£è½æ²å‹•äº‹ä»¶
                wrapper.addEventListener('scroll', function() {
                    lineNumbers.style.transform = `translateY(-${this.scrollTop}px)`;
                });
            }
        }

        // åˆ‡æ›æ›¸ç±¤
        function toggleBookmark(lineElement) {
            const lineNumber = parseInt(lineElement.getAttribute('data-line'));
            const panel = lineElement.getAttribute('data-panel');
            const key = `${panel}-${lineNumber}`;
            
            if (bookmarks.has(key)) {
                bookmarks.delete(key);
                lineElement.classList.remove('bookmarked');
            } else {
                bookmarks.add(key);
                lineElement.classList.add('bookmarked');
            }
            
            // æ›´æ–°æ›¸ç±¤é™£åˆ—
            updateBookmarkArray();
        }

        // æ›´æ–°æ›¸ç±¤é™£åˆ—
        function updateBookmarkArray() {
            bookmarkArray = Array.from(bookmarks).sort((a, b) => {
                const [panelA, lineA] = a.split('-');
                const [panelB, lineB] = b.split('-');
                if (panelA === panelB) {
                    return parseInt(lineA) - parseInt(lineB);
                }
                return panelA.localeCompare(panelB);
            });
        }

        // é«˜äº®ç•¶å‰è¡Œ
        function highlightCurrentLine(panel, lineIndex) {
            // é€™å€‹åŠŸèƒ½å¯ä»¥é¸æ“‡æ€§å¯¦ç¾
        }

        // é«˜äº®é¸ä¸­çš„æ–‡å­—ï¼ˆé«˜äº®æ‰€æœ‰ç›¸åŒæ–‡å­—ï¼‰
        function highlightSelection(colorIndex) {
            if (!selectedText) return;
            
            // æ¸…é™¤ä¹‹å‰åŒé¡è‰²çš„é«˜äº®
            if (highlightedTexts[colorIndex]) {
                clearHighlightColor(colorIndex);
            }
            
            highlightedTexts[colorIndex] = selectedText;
            
            // é«˜äº®æ‰€æœ‰è¦–çª—ä¸­çš„ç›¸åŒæ–‡å­—
            highlightAllOccurrences(selectedText, colorIndex);
            
            // é¡¯ç¤ºé«˜äº®æ§åˆ¶æŒ‰éˆ•
            document.getElementById(`highlightBtn${colorIndex}`).style.display = 'block';
            
            hideContextMenu();
            window.getSelection().removeAllRanges();
        }

        // é«˜äº®æ‰€æœ‰å‡ºç¾çš„æ–‡å­—
        function highlightAllOccurrences(text, colorIndex) {
            // è™•ç†å·¦å³é¢æ¿
            ['left', 'right'].forEach(panel => {
                const contentEl = document.getElementById(`${panel}OriginalContent`);
                if (contentEl) {
                    highlightInElement(contentEl, text, colorIndex);
                }
                
                // è™•ç† iframe å…§å®¹
                const iframe = document.querySelector(`#${panel}Content iframe`);
                if (iframe && iframe.contentDocument) {
                    const iframeBody = iframe.contentDocument.body;
                    if (iframeBody) {
                        highlightInElement(iframeBody, text, colorIndex);
                    }
                }
            });
        }

        // åœ¨å…ƒç´ ä¸­é«˜äº®æ–‡å­—
        function highlightInElement(element, text, colorIndex) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            
            while (node = walker.nextNode()) {
                if (node.nodeValue.includes(text)) {
                    textNodes.push(node);
                }
            }
            
            textNodes.forEach(textNode => {
                const parent = textNode.parentNode;
                const content = textNode.nodeValue;
                const regex = new RegExp(escapeRegExp(text), 'g');
                
                if (parent.className && parent.className.includes('highlight-')) {
                    return; // è·³éå·²ç¶“é«˜äº®çš„
                }
                
                const parts = content.split(regex);
                const fragment = document.createDocumentFragment();
                
                parts.forEach((part, i) => {
                    if (part) {
                        fragment.appendChild(document.createTextNode(part));
                    }
                    if (i < parts.length - 1) {
                        const span = document.createElement('span');
                        span.className = `highlight-${colorIndex}`;
                        span.textContent = text;
                        fragment.appendChild(span);
                    }
                });
                
                parent.replaceChild(fragment, textNode);
            });
        }

        // æ¸…é™¤ç‰¹å®šé¡è‰²çš„é«˜äº®
        function clearHighlightColor(colorIndex) {
            document.querySelectorAll(`.highlight-${colorIndex}`).forEach(element => {
                const parent = element.parentNode;
                const textNode = document.createTextNode(element.textContent);
                parent.replaceChild(textNode, element);
                
                // åˆä½µç›¸é„°çš„æ–‡å­—ç¯€é»
                parent.normalize();
            });
            
            highlightedTexts[colorIndex] = null;
            document.getElementById(`highlightBtn${colorIndex}`).style.display = 'none';
        }

        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        function clearAllHighlights() {
            for (let i = 1; i <= 5; i++) {
                clearHighlightColor(i);
            }
            hideContextMenu();
        }

        // è¼”åŠ©å‡½æ•¸ï¼šè½‰ç¾©æ­£å‰‡è¡¨é”å¼
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // åœ¨æ›¸ç±¤é–“å°èˆª
        function navigateBookmarks() {
            if (bookmarkArray.length === 0) {
                updateStatus('æ²’æœ‰æ›¸ç±¤');
                return;
            }
            
            currentBookmarkIndex = (currentBookmarkIndex + 1) % bookmarkArray.length;
            const [panel, line] = bookmarkArray[currentBookmarkIndex].split('-');
            
            // æ‰¾åˆ°å°æ‡‰çš„è¡Œ
            const row = document.querySelector(
                `#${panel}ContentWrapper .line-number[data-line="${line}"]`
            )?.closest('.content-row');
            
            if (row) {
                // æ»¾å‹•åˆ°æ›¸ç±¤ä½ç½®
                row.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // é–ƒçˆæ•ˆæœ
                const lineElement = row.querySelector('.line-number');
                if (lineElement) {
                    lineElement.style.transition = 'background-color 0.3s';
                    const originalBg = lineElement.style.backgroundColor;
                    lineElement.style.backgroundColor = '#4ec9b0';
                    setTimeout(() => {
                        lineElement.style.backgroundColor = originalBg;
                    }, 500);
                }
                
                updateStatus(`è·³è½‰åˆ°æ›¸ç±¤: ${panel} é¢æ¿ç¬¬ ${line} è¡Œ`);
            }
        }

        // ç¢ºä¿å…¨åŸŸè®Šæ•¸è¢«æ­£ç¢ºåˆå§‹åŒ–
        if (typeof currentFocusedPanel === 'undefined') {
            window.currentFocusedPanel = 'left';
        }
        if (typeof currentFocusedLine === 'undefined') {
            window.currentFocusedLine = 1;
        }

        let selectedText = '';
        let selectedRange = null;

        // è¨­ç½®å³éµé¸å–®
        function setupContextMenu(element) {
            element.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                const selection = window.getSelection();
                selectedText = selection.toString();
                
                if (selectedText) {
                    selectedRange = selection.getRangeAt(0);
                    showContextMenu(e.clientX, e.clientY);
                }
            });
        }

        // ç‚º iframe è¨­ç½®å³éµé¸å–®
        function setupIframeContextMenu(iframe) {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            iframeDoc.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                const selection = iframe.contentWindow.getSelection();
                selectedText = selection.toString();
                
                if (selectedText) {
                    selectedRange = selection.getRangeAt(0);
                    showContextMenu(e.clientX, e.clientY);
                }
            });
        }

        // é¡¯ç¤ºå³éµé¸å–®
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
            
            // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
            document.addEventListener('click', hideContextMenu);
        }

        // éš±è—å³éµé¸å–®
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }
    </script>
</body>
</html>